"use strict";const e=require("../../common/vendor.js"),a=require("../../api/chat.js"),t=require("../../api/product.js"),o=require("../../api/user.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-tag"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-tag/components/uni-tag/uni-tag.js"))();const n={__name:"chat",setup(n){const l=e.ref(null),s=e.ref(null),r=e.ref("wss://api.shaolezhuan.cn/native-ws"),i=e.ref(!1),c=e.ref(0),u=e.ref(5),v=e.ref(null),d=e.ref(null),p=e.ref({id:null,avatar:"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:""}),g=e.ref({name:"",avatar:"https://api.shaolezhuan.cn/lzphoto/avatars/avatar2.jpeg",type:"buyer"}),m=e.ref({name:"",price:0,image:"https://api.shaolezhuan.cn/lzphoto/productDefault.jpg",tags:[],budgetMin:0,budgetMax:0}),h=e.ref(!0),f=e.ref(""),y=e.ref(""),S=e.ref(""),x=e.ref(!0),w=e.ref(!0),T=e.ref(""),I=e.ref([]),k=e.ref(0),N=e.ref(!0);e.ref(null);const b=e.ref(1),z=e.ref(100),E=e.ref(!0),M=e.ref(!1),_=e.ref(0),j=e.ref([]),U=e.ref(!0);e.ref("");const $=e.ref(""),A=e.ref(""),D=e.ref(!1),R=e.ref(!1),O=e.ref(["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ","ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¥¸","ğŸ˜","ğŸ˜’","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ","ğŸ˜•","ğŸ™","â˜¹ï¸","ğŸ˜£","ğŸ˜–"]),P=e=>`chat_messages_${p.value.id}_${e}`,C=(a,t)=>{try{const o=P(a),n={messages:t,timestamp:Date.now(),otherUserId:a};e.index.setStorageSync(o,n),console.log("æ¶ˆæ¯å·²ä¿å­˜åˆ°ç¼“å­˜:",t.length,"æ¡")}catch(o){console.error("ä¿å­˜æ¶ˆæ¯åˆ°ç¼“å­˜å¤±è´¥:",o)}},G=e=>{try{const a=`temp_${e.messageType}_${Date.now()}_${e.content.slice(0,10)}`,t={id:"temp_"+Date.now(),isSelf:!0,type:e.messageType||"text",avatar:p.value.avatar||"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",senderNickname:p.value.nickname||p.value.username,receiverNickname:"",senderId:p.value.id,receiverId:e.receiverId,content:e.content,timestamp:Date.now(),isRead:!1,isLocal:!0};return I.value.some(e=>e.id===a)?(console.log("æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ :",a),null):(I.value.push(t),setTimeout(()=>se(),50),console.log("æœ¬åœ°æ·»åŠ æ¶ˆæ¯:",t.id),t)}catch(a){return console.error("æ·»åŠ æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨å¤±è´¥:",a),null}};e.onLoad(async t=>{if(await(async()=>{try{const a=e.index.getStorageSync("userInfo"),t=e.index.getStorageSync("studentIdNumber"),n=e.index.getStorageSync("nickname"),l=e.index.getStorageSync("avatarUrl");(aæˆ–t)&&(p.value={id:t||(null==a?void 0:a.studentIdNumber)||(null==a?void 0:a.id)||1,avatar:l||(null==a?void 0:a.avatarUrl)||"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:n||(null==a?void 0:a.nickName)||(null==a?void 0:a.nickname)||"ç”¨æˆ·"},console.log("ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·ä¿¡æ¯:",p.value));const s=await o.userApi.getCurrentUser();if(200===s.code&&s.data)p.value={id:s.data.id,avatar:s.data.avatarUrl||"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:s.data.nickname||"ç”¨æˆ·"},console.log("ä»æœåŠ¡å™¨è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:",p.value);else if(!p.value.id)throw new Error("æœåŠ¡å™¨è¿”å›æ•°æ®æ— æ•ˆ")}catch(a){if(console.error("è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",a),!p.value.id){const a=e.index.getStorageSync("userInfo"),t=e.index.getStorageSync("studentIdNumber"),o=e.index.getStorageSync("nickname"),n=e.index.getStorageSync("avatarUrl");a||t?(p.value={id:t||(null==a?void 0:a.studentIdNumber)||(null==a?void 0:a.id)||1,avatar:n||(null==a?void 0:a.avatarUrl)||"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:o||(null==a?void 0:a.nickName)||(null==a?void 0:a.nickname)||"ç”¨æˆ·"},console.log("ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„å¤‡ç”¨ç”¨æˆ·ä¿¡æ¯:",p.value)):(p.value={id:1,avatar:"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:"ç”¨æˆ·"},console.log("ä½¿ç”¨é»˜è®¤ç”¨æˆ·ä¿¡æ¯:",p.value))}}})(),!p.value.id)return console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œæ— æ³•åˆå§‹åŒ–èŠå¤©"),void e.index.showToast({title:"ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"});f.value=t.sellerId||"",y.value=t.itemId||"",S.value=t.type||"",$.value=t.receiverId||"",A.value=t.senderId||p.value.id,D.value=!!y.value&&("product"===S.value||"demand"===S.value),x.value=D.value;const n=f.value||$.value;D.value&&("product"===S.value?H(y.value):"demand"===S.value&&V(y.value)),n&&Q(n);const s=await a.chatApi.readMessages({read:!0,senderId:n,receiverId:p.value.id});console.log("å·²è¯»è¿”å›çš„å“åº”ä¿¡æ¯:",s);let r=!1;n&&(r=(a=>{try{const t=P(a),o=e.index.getStorageSync(t);if(o&&o.messages&&o.messages.length>0)return console.log("ä»ç¼“å­˜åŠ è½½æ¶ˆæ¯:",o.messages.length,"æ¡"),I.value=o.messages,setTimeout(()=>{se()},100),!0}catch(t){console.error("ä»ç¼“å­˜åŠ è½½æ¶ˆæ¯å¤±è´¥:",t)}return!1})(n),r&&console.log("å·²ä»ç¼“å­˜åŠ è½½æ¶ˆæ¯ï¼Œåå°åŒæ­¥æœ€æ–°æ•°æ®")),b.value=1,await B(),console.log("å‡†å¤‡åˆå§‹åŒ–WebSocketè¿æ¥ï¼Œç”¨æˆ·ID:",p.value.id),L(),setTimeout(()=>{i.value||(console.log("é¦–æ¬¡è¿æ¥æœªæˆåŠŸï¼Œå°è¯•é‡æ–°å»ºç«‹è¿æ¥"),L())},1e3),l.value=setInterval(async()=>{if(i.value&&_.value>0){const e=await Y(_.value);if(e.records&&e.records.length>0){const a=X(e.records),t=[...I.value];a.forEach(e=>{t.some(a=>a.id===e.id)||t.push(e)}),t.length!==I.value.length&&(I.value=t,C(f.value||$.value,t),se())}}},3e3)});const L=()=>{if(!p.value.id)return console.error("ç”¨æˆ·IDæ— æ•ˆï¼Œæ— æ³•å»ºç«‹WebSocketè¿æ¥"),void e.index.showToast({title:"ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œè¯·é‡æ–°è¿›å…¥",icon:"none"});console.log("å¼€å§‹å»ºç«‹WebSocketè¿æ¥ï¼Œç”¨æˆ·ID:",p.value.id),d.value&&(clearTimeout(d.value),d.value=null),s.value&&e.index.closeSocket({success:()=>{console.log("å·²å…³é—­æ—§çš„Socketè¿æ¥")}}),d.value=setTimeout(()=>{i.value||(console.log("è¿æ¥è¶…æ—¶ï¼Œå°è¯•é‡æ–°è¿æ¥"),W())},1e4),s.value=e.index.connectSocket({url:`${r.value}?userId=${p.value.id}`,header:{"content-type":"application/json"},method:"GET",success:e=>{console.log("Socketè¿æ¥è¯·æ±‚å·²å‘é€",e)},fail:e=>{console.error("Socketè¿æ¥è¯·æ±‚å¤±è´¥",e),d.value&&(clearTimeout(d.value),d.value=null),W()}}),e.index.onSocketOpen(a=>{console.log("Socketè¿æ¥æˆåŠŸï¼",a),i.value=!0,c.value=0,d.value&&(clearTimeout(d.value),d.value=null),q();e.index.sendSocketMessage({data:JSON.stringify({type:"USER_ONLINE"}),success:()=>{console.log("ç”¨æˆ·ä¸Šçº¿æ¶ˆæ¯å‘é€æˆåŠŸ")},fail:e=>{console.error("ç”¨æˆ·ä¸Šçº¿æ¶ˆæ¯å‘é€å¤±è´¥:",e)}})}),e.index.onSocketMessage(e=>{try{const a=JSON.parse(e.data);F(a)}catch(a){console.error("è§£ææ¶ˆæ¯å¤±è´¥:",a)}}),e.index.onSocketClose(a=>{console.log("Socketè¿æ¥å…³é—­ï¼Œé”™è¯¯ç :",a.code),i.value=!1,J(),1e3!==a.code&&c.value<u.value?W():c.value>=u.value&&e.index.showToast({title:"é‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",icon:"none"})}),e.index.onSocketError(e=>{console.error("Socketè¿æ¥å‡ºé”™:",e),i.value=!1,J(),W()})},q=()=>{J(),v.value=setInterval(()=>{if(i.value){const a={type:"PING",timestamp:Date.now()};e.index.sendSocketMessage({data:JSON.stringify(a),success:()=>{console.log("å¿ƒè·³æ¶ˆæ¯å‘é€æˆåŠŸ")},fail:e=>{console.error("å¿ƒè·³æ¶ˆæ¯å‘é€å¤±è´¥:",e),i.value=!1,W()}})}},3e4),console.log("å¿ƒè·³æœºåˆ¶å·²å¯åŠ¨ï¼Œé—´éš”:",3e4,"ms")},J=()=>{v.value&&(clearInterval(v.value),v.value=null,console.log("å¿ƒè·³æœºåˆ¶å·²åœæ­¢")),d.value&&(clearTimeout(d.value),d.value=null,console.log("è¿æ¥è¶…æ—¶å®šæ—¶å™¨å·²æ¸…é™¤"))},F=async a=>{if(console.log("æ”¶åˆ°WebSocketæ¶ˆæ¯:",a),"SYSTEM_MESSAGE"===a.type){switch(console.log("æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯:",a.content,"ç±»å‹:",a.messageType),a.messageType){case"CONNECT_SUCCESS":console.log("WebSocketè¿æ¥æˆåŠŸç¡®è®¤"),i.value=!0;break;case"USER_ONLINE_SUCCESS":console.log("ç”¨æˆ·ä¸Šçº¿æˆåŠŸç¡®è®¤");break;case"ERROR":console.error("æœåŠ¡å™¨é”™è¯¯:",a.content),e.index.showToast({title:a.content,icon:"none"});break;case"PING_RESPONSE":console.log("å¿ƒè·³å“åº”");break;default:console.log("æœªçŸ¥ç³»ç»Ÿæ¶ˆæ¯ç±»å‹:",a.messageType)}return}if("MESSAGE_SENT"===a.type&&a.data)return void console.log("æ¶ˆæ¯å‘é€ç¡®è®¤:",a.data);const t="PRIVATE_MESSAGE"===a.type?a.data:a,o=f.value||$.value;t&&o&&(t.senderId===o||t.receiverId===o)?((e=>{try{const a={id:e.id||"temp_received_"+Date.now(),isSelf:!1,type:e.messageType||"text",avatar:e.senderAvataræˆ–"https://api.shaolezhuan.cn/lzphoto/avatars/avatar2.jpeg",senderNickname:e.senderNicknameæˆ–"å¯¹æ–¹",receiverNickname:p.value.nicknameæˆ–p.value.username,senderId:e.senderId,receiverId:e.receiverId,content:e.content,timestamp:e.timestampæˆ–Date.now(),isRead:!1,isReceived:!0};return I.value.find(e=>e.id===a.idæˆ–e.content===a.content&&e.senderId===a.senderId&&Math.abs(e.timestamp-a.timestamp)<5e3)?console.log("æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "):(I.value.push(a),setTimeout(()=>{se()},50),console.log("æ¥æ”¶æ¶ˆæ¯å·²ç«‹å³æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨")),a}catch(a){return console.error("æ·»åŠ æ¥æ”¶æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨å¤±è´¥:",a),null}})(t),setTimeout(async()=>{try{const e=_.valueæˆ–1,a=await Y(e);if(a.records&&a.records.length>0){const e=X(a.records),t=[...I.value];e.forEach(e=>{t.some(a=>a.id===e.id)||t.push(e)}),t.length!==I.value.length&&(I.value=t,C(o,t),se())}}catch(e){console.error("åŒæ­¥æœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:",e)}},1200)):console.log("è¿‡æ»¤æ— å…³æ¶ˆæ¯:",null==t?void 0:t.id)},W=()=>{if(c.value>=u.value)return;c.value++;const e=1e3*c.value;console.log(`ç¬¬${c.value}æ¬¡é‡è¿ï¼Œå»¶è¿Ÿ${e}æ¯«ç§’`),setTimeout(()=>{L()},e)},H=async a=>{if(a)try{const o=await t.productApi.getProductDetail(a);200===o.code?m.value={name:o.data.nameæˆ–"æœªçŸ¥å•†å“",price:o.data.priceæˆ–0,image:o.data.mainImageUrlæˆ–"/static/products/p1.jpeg",tags:o.data.tagsæˆ–[]}:e.index.showToast({title:"å•†å“ä¿¡æ¯åŠ è½½å¤±è´¥",icon:"none"})}catch(o){console.error("å•†å“è¯¦æƒ…è¯·æ±‚å¤±è´¥ï¼š",o),e.index.showToast({title:"ç½‘ç»œé”™è¯¯",icon:"none"})}},V=async a=>{if(a)try{const n=await t.productApi.getDemandDetail(a);if(200===n.code){let e=[];if(n.data.attributes)try{const a=JSON.parse(n.data.attributes);e=Object.values(a)}catch(o){console.error("è§£æattributeså¤±è´¥:",o)}e.unshift(n.data.isNegotiable?"å¯åˆ€":"ä¸å¯åˆ€"),m.value={name:n.data.titleæˆ–"æœªçŸ¥éœ€æ±‚",budgetMin:n.data.budgetMinæˆ–0,budgetMax:n.data.budgetMaxæˆ–0,image:n.data.imageUrlæˆ–"/static/products/p1.jpeg",tags:e},n.data.requester&&(g.value.name=n.data.requester.nicknameæˆ–"æœªçŸ¥ç”¨æˆ·",g.value.avatar=n.data.requester.avataræˆ–"https://api.shaolezhuan.cn/lzphoto/avatars/avatar2.jpeg")}else e.index.showToast({title:"éœ€æ±‚ä¿¡æ¯åŠ è½½å¤±è´¥",icon:"none"})}catch(n){console.error("éœ€æ±‚è¯¦æƒ…è¯·æ±‚å¤±è´¥ï¼š",n),e.index.showToast({title:"ç½‘ç»œé”™è¯¯",icon:"none"})}},Q=async e=>{if(e)try{const a=await o.userApi.getUserInfo(e);200===a.code&&(g.value={name:a.data.nicknameæˆ–"æœªçŸ¥ç”¨æˆ·",avatar:a.data.avatarUrlæˆ–"https://api.shaolezhuan.cn/lzphoto/avatars/avatar2.jpeg",type:a.data.typeæˆ–"seller"},console.log("è·å–å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:",g.value))}catch(a){console.error("è·å–å–å®¶ä¿¡æ¯å¤±è´¥ï¼š",a)}},B=async()=>{try{const e=f.valueæˆ–$.value;if(!e)return console.error("otherUserIdä¸ºç©ºï¼Œæ— æ³•åŠ è½½æ¶ˆæ¯"),void(U.value=!1);const a=(await Y(1)).totalæˆ–0;if(z.value<=0&&(z.value=10),_.value=a>0?Math.ceil(a/z.value):0,0===a)return void(U.value=!1);const t=[];_.value>=2&&t.push(_.value-1),t.push(_.value),j.value=[...t];const o=t.map(e=>Y(e)),n=await Promise.all(o);let l=[];n.forEach(e=>{l=[...l,...e.records]});const s=X(l);I.value=s,E.value=_.value>2,C(e,s),setTimeout(()=>se(),100),U.value=!1}catch(e){console.error("åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨å¤±è´¥ï¼š",e),U.value=!1}},K=async()=>{if(!M.value&&E.value)try{M.value=!0;const a=Math.min(...j.value)-1;if(a<1)return E.value=!1,e.index.showToast({title:"å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯",icon:"none",duration:1500}),void(M.value=!1);const t=await Y(a);if(t.records&&t.records.length>0){const e=X(t.records);I.value=[...e,...I.value],j.value.push(a),C(f.valueæˆ–$.value,I.value),E.value=a>1}else E.value=!1,e.index.showToast({title:"å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯",icon:"none",duration:1500})}catch(a){console.error("åŠ è½½æ›´å¤šæ¶ˆæ¯å¤±è´¥ï¼š",a)}finally{M.value=!1}},Y=async t=>{var o,n;(!Number.isInteger(t)||t<1||t>_.value)&&(t=Math.min(Math.max(t,1),_.valueæˆ–1),console.warn(`é¡µç ${t}æ— æ•ˆï¼Œå·²ä¿®æ­£ä¸º${t}`));const l={otherUserId:f.valueæˆ–$.value,current:t,size:z.value};console.log("è¯·æ±‚åˆ†é¡µï¼š",`ç¬¬${t}é¡µï¼ˆå…±${_.value}é¡µï¼‰`,l);try{const s=await a.chatApi.getMessages(l);return console.log(`ç¬¬${t}é¡µè¿”å›æ¶ˆæ¯æ•°ï¼š`,(null==(n=null==(o=s.data)?void 0:o.records)?void 0:n.length)||0),200!==s.code&&e.index.showToast({title:s.msg,icon:"none"}),s.dataæˆ–{records:[],total:0}}catch(s){return console.error(`è·å–ç¬¬${t}é¡µæ¶ˆæ¯å¤±è´¥ï¼š`,s),e.index.showToast({title:"åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",icon:"none"}),{records:[],total:0}}},X=e=>e.map(e=>{const a=e.isSelf;return{id:e.id,isSelf:a,type:e.messageTypeæˆ–"text",avatar:e.senderAvataræˆ–"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",senderNickname:e.senderNickname,receiverNickname:e.receiverNickname,senderId:e.senderId,receiverId:e.receiverId,content:e.content,timestamp:new Date(e.createdAt).getTime(),isRead:e.isRead}}),Z=e=>{if(0===e)return!0;return I.value[e].timestamp-I.value[e-1].timestamp>3e5},ee=e=>{let a;"string"==typeof e?(e=e.replace(/T/," ").replace(/\.\d+/,""),a=new Date(e)):a=new Date(e);return`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`},ae=e.ref(""),te=e.ref(!1),oe=async()=>{if(!te.value)if(i.value){te.value=!0;try{if(T.value.trim()){const a={type:"PRIVATE_MESSAGE",receiverId:f.valueæˆ–$.value,content:T.value.trim(),messageType:"text",senderId:p.value.id};console.log("å‘é€æ¶ˆæ¯å‚æ•°:",a);const t=G(a);T.value="",e.index.sendSocketMessage({data:JSON.stringify(a),success:async()=>{console.log("æ¶ˆæ¯å‘é€æˆåŠŸï¼Œç­‰å¾…æœåŠ¡å™¨ç¡®è®¤"),setTimeout(async()=>{try{const a=await Y(_.valueæˆ–1);if(a.records&&a.records.length>0){const o=X(a.records),n=[...I.value],l=n.findIndex(e=>e.id===t.id),s=o.find(e=>e.content===t.content&&e.senderId===p.value.id&&Math.abs(e.timestamp-t.timestamp)<5e3);l>-1&&s&&n.splice(l,1,s),o.forEach(e=>{n.some(a=>a.id===e.id)||n.push(e)}),I.value=n,await e.nextTick$1(),se(),C(otherUserId,n)}}catch(a){console.error("åŒæ­¥æœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:",a)}},800)},fail:a=>{console.error("æ¶ˆæ¯å‘é€å¤±è´¥:",a),e.index.showToast({title:"å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"}),I.value=I.value.filter(e=>e.id!==t.id)}})}ae.value&&await ne()}catch(a){console.error("æ¶ˆæ¯å¤„ç†å¼‚å¸¸:",a),e.index.showToast({title:"å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}finally{setTimeout(()=>{te.value=!1},500)}}else e.index.showToast({title:"è¿æ¥æœªå»ºç«‹ï¼Œè¯·ç¨å€™",icon:"none"})},ne=async()=>{const a=f.valueæˆ–$.value;var t,o,n;if(ae.value&&p.value.id&&a)try{te.value=!0,e.index.showLoading({title:"å›¾ç‰‡ä¸Šä¼ ä¸­..."});const l=await(t=ae.value,o=p.value.id,n=a,console.log("ä¸Šä¼ å‚æ•°ï¼š",{senderId:o,receiverId:n,tempFilePath:t}),new Promise((a,l)=>{e.index.uploadFile({url:"https://api.shaolezhuan.cn/api/chat/media/upload",filePath:t,name:"file",formData:{senderId:o.toString(),receiverId:n.toString()},success:t=>{try{const o=JSON.parse(t.data);200===o.code&&o.data&&o.data.mediaUrl?a(o.data.mediaUrl):(e.index.showToast({title:o.msgæˆ–"å›¾ç‰‡ä¸Šä¼ å¤±è´¥",icon:"none"}),l(new Error(o.msgæˆ–"ä¸Šä¼ å¤±è´¥")))}catch(o){e.index.showToast({title:"æ¥å£å“åº”æ ¼å¼é”™è¯¯",icon:"none"}),l(o)}},fail:a=>{e.index.showToast({title:"ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•",icon:"none"}),l(a)}})})),s={type:"PRIVATE_MESSAGE",receiverId:a,content:l,messageType:"image",senderId:p.value.id},r=G(s);if(!r)return e.index.hideLoading(),void(te.value=!1);ae.value="",e.index.sendSocketMessage({data:JSON.stringify(s),success:async()=>{setTimeout(async()=>{const e=await Y(_.valueæˆ–1);if(e.records&&e.records.length>0){const t=X(e.records),o=[...I.value],n=o.findIndex(e=>e.id===r.id),s=t.find(e=>e.content===l&&e.senderId===p.value.id);n>-1&&(s?o.splice(n,1,s):o.splice(n,1)),t.forEach(e=>{o.some(a=>a.id===e.id)||o.push(e)}),I.value=o,C(a,o),se()}},1e3)},fail:a=>{console.error("å›¾ç‰‡å‘é€å¤±è´¥:",a),e.index.showToast({title:"å›¾ç‰‡å‘é€å¤±è´¥",icon:"none"}),I.value=I.value.filter(e=>e.id!==r.id)},complete:()=>{e.index.hideLoading(),setTimeout(()=>{te.value=!1},500)}})}catch(l){console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥:",l),e.index.hideLoading(),te.value=!1,e.index.showToast({title:"å›¾ç‰‡ä¸Šä¼ å¤±è´¥",icon:"none"})}else e.index.showToast({title:"å‚æ•°ä¸å®Œæ•´",icon:"none"})},le=e=>{const{scrollTop:a,scrollHeight:t,clientHeight:o}=e.detail,n=a>=t-o-20;N.value=n},se=()=>{e.index.createSelectorQuery().select(".chat-container").boundingClientRect(a=>{e.index.createSelectorQuery().select(".message-list").boundingClientRect(e=>{a&&e&&(k.value=e.height,console.log("æ»šåŠ¨åˆ°åº•éƒ¨æˆåŠŸï¼Œæ»šåŠ¨é«˜åº¦ï¼š",k.value))}).exec()}).exec()};e.onMounted(()=>{e.watch(I,()=>{e.nextTick$1(()=>{setTimeout(()=>{se()},50)})},{deep:!0}),h.valueæˆ–e.nextTick$1(()=>{setTimeout(()=>{se()},200)})}),e.watch(h,a=>{aæˆ–e.nextTick$1(()=>{setTimeout(()=>{se()},100)})});const re=()=>{R.value=!R.value},ie=()=>{e.index.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:a=>{ae.value=a.tempFilePaths[0],e.index.showToast({title:"å›¾ç‰‡å·²é€‰æ‹©ï¼Œç‚¹å‡»å‘é€",icon:"none",duration:1500})},fail:a=>{e.index.showToast({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥",icon:"none",duration:1500}),console.error("é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼š",a)}})};return e.onUnload(()=>{J(),s.value&&(e.index.closeSocket({success:()=>{console.log("é¡µé¢å¸è½½ï¼Œå…³é—­Socketè¿æ¥")}}),i.value=!1,s.value=null),l.value&&(clearInterval(l.value),l.value=null,console.log("å®šæ—¶å™¨å·²åœæ­¢ï¼Œä¸å†è·å–æ¶ˆæ¯"))}),(a,t)=>e.e({a:h.value},h.value?{b:e.o(e=>h.value=!1)}:{},{c:!h.value},h.value?{}:e.e({d:D.value&&x.value},D.value&&x.value?e.e({e:g.value.avataræˆ–"/static/avatars/avatar1.jpeg",f:e.t(g.value.nameæˆ–"æœªè®¾ç½®"),g:e.p({type:"closeempty",size:"12"}),h:e.o(e=>x.value=!1),i:m.value.imageæˆ–"/static/products/p1.jpeg",j:e.t(m.value.nameæˆ–"æœªçŸ¥"),k:void 0!==m.value.price},void 0!==m.value.price?{l:e.t((m.value.priceæˆ–0).toFixed(2))}:{m:e.t(m.value.budgetMinæˆ–0),n:e.t(m.value.budgetMaxæˆ–0)},{o:m.value.tags&&m.value.tags.length>0},m.value.tags&&m.value.tags.length>0?{p:e.f(m.value.tags,(a,t,o)=>{return{a:"a45cd313-1-"+o,b:e.p({size:"mini",text:a,type:(n=a,"éœ€æ±‚"===n?"warning":"å¯åˆ€"===næˆ–"ä¸å¯åˆ€"===n?"error":"primary")}),c:t};var n})}:{},{q:e.p({type:"down",size:"12"}),r:e.o(e=>x.value=!1)}):{},{s:D.value&&!x.value},D.value&&!x.value?{t:e.p({type:"up",size:"12"}),v:e.o(e=>x.value=!0)}:{},{w:M.value},(M.value,{}),{x:w.value&&g.value.name},w.value&&g.value.name?{y:e.t(g.value.name)}:{},{z:e.f(I.value,(a,t,o)=>e.e({a:Z(t)},Z(t)?{b:e.t(ee(a.timestamp))}:{},{c:a.avatar,d:!a.isSelf&&a.senderNickname},!a.isSelf&&a.senderNickname?{e:e.t(a.senderNickname)}:{},{f:"text"===a.type},"text"===a.type?{g:e.t(a.content)}:"image"===a.type?{i:a.content,j:e.o(t=>(a=>{const t=I.value.filter(e=>"image"===e.type).map(e=>e.content);e.index.previewImage({current:a,urls:t,loop:!0})})(a.content),a.id)}:{},{h:"image"===a.type,k:a.isSelf?1:"",l:a.isSelf?1:"",m:a.id})),A:k.value,B:e.o(le),C:e.o(K),D:!R.value},R.value?{F:e.p({type:"chat",size:"24"})}:{E:e.p({type:"heart",size:"24"})},{G:e.o(re),H:e.p({type:"image",size:"24"}),I:e.o(ie),J:e.o(oe),K:T.value,L:e.o(e=>T.value=e.detail.value),M:e.o(oe),N:!T.value.trim()&&!ae.value,O:R.value},R.value?{P:e.f(O.value,(a,t,o)=>({a:e.t(a),b:t,c:e.o(e=>(e=>{T.value+=e})(a),t)}))}:{}))}},l=e._export_sfc(n,[["__scopeId","data-v-a45cd313"]]);wx.createPage(l);