"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/uniHelper.js"),o=require("../../utils/system.js"),t=require("../../api/user.js"),n=require("../../api/product.js");if(!Array){e.resolveComponent("uni-icons")()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+l)();const l=()=>"../../components/Waterfall-one.js",s={__name:"index",props:{visible:{type:Boolean,default:!1}},emits:["close","goTo"],setup(l,{emit:s}){const r=e.ref(0),c=e.ref(0),i=e.ref(0);e.ref({});const p=e.ref([{name:"电子数码",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/digital.png"},{name:"自行车",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/bicycle.png"},{name:"电器",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/appliance.png"},{name:"体育用品",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/sports.png"}]),u=e.ref([{name:"二手书",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/books.png"},{name:"生活用品",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/life.png"},{name:"虚拟用品",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/virtualgoods.png"},{name:"其他",icon:"https://api.shaolezhuan.cn/lzphoto/category-icons/others.png"}]),h=e.ref([{imageUrl:"https://api.shaolezhuan.cn/lzphoto/banners/b1.jpg"},{imageUrl:"https://api.shaolezhuan.cn/lzphoto/banners/b2.jpg"},{imageUrl:"https://api.shaolezhuan.cn/lzphoto/banners/b3.jpg"}]),m=e.ref([{content:"商品发布审核工作时间为8:00-22:00，非工作时段发布的商品审核将有所延缓，请谅解！ "}]),g=e.ref([]),d=e.ref([]),v=e.ref([]),f=e.ref([]),y=e.ref([]),z=e.ref(!1),b=e.ref(!1);e.onMounted(()=>{r.value=o.getStatusBarHeight(),c.value=o.getTitleBarHeight(),i.value=o.getNavBarHeight(),x()});const j=()=>{b.value=!0},w=o=>{a.showToast(`点击了${o}分类`),e.index.navigateTo({url:`/pages/category/category?type=${o}`})};e.onReachBottom(()=>{z.value=!0,setTimeout(()=>{z.value=!1},5e3)});const P=()=>{b.value=!1},U=()=>{b.value=!1},x=async()=>{try{const[e,o]=await Promise.all([n.productApi.getAllGoods(),n.productApi.getAllDemands()]);console.log("接口获取的所有商品数据",e),console.log("接口获取的所有需求数据",o),200===e.code?(g.value=e.data||[],await N(),console.log("脏的商品数据：",g.value)):a.showToast("获取商品数据失败"),200===o.code?(d.value=o.data||[],await T(),console.log("脏的需求数据：",d.value)):a.showToast("获取需求数据失败"),k()}catch(e){console.error("获取推荐数据失败：",e),a.showToast("网络异常，获取推荐数据失败")}},N=async()=>{const e=await Promise.all(g.value.map(async e=>{let a=[];try{const o=JSON.parse(e.attributes||"{}");a=Object.values(o),a.unshift(e.isNegotiable?"可刀":"不可刀")}catch(o){console.error("解析商品属性失败:",o),a=[]}return await A(e.sellerId),{id:e.id,imgUrl:e.mainImageUrl||"https://api.shaolezhuan.cn/lzphoto/productDefault.jpg",tags:a,title:e.title||"未知商品",desc:e.description||"",categoryName:e.categoryName||"其他",user:{avatar:e.sellerAvatarUrl,nickname:e.sellerNickname},type:"product",price:e.price||0,isRecommended:e.isHomepageFeatured,recommendPriority:e.adminPinScore||0}}));console.log("未筛选推荐的商品数据：",e),v.value=e.filter(e=>e.isRecommended),console.log("干净的商品数据：",v.value)},T=async()=>{const e=await Promise.all(d.value.map(async e=>{let a=[];try{const o=JSON.parse(e.attributes||"{}");a=Object.values(o)}catch(o){console.error("解析需求属性失败:",o),a=[]}return{id:e.id,imgUrl:e.mainImageUrl||"https://api.shaolezhuan.cn/lzphoto/demandpic.png",tags:["需求",...a],title:e.title||"未知需求",desc:e.description||"",categoryName:e.categoryName||"其他",user:e.requester||{avatar:"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:"未知用户"},type:"demand",price:e.budget||0,isRecommended:e.isHomepageFeatured||!0,recommendPriority:e.adminPinScore||0}}));f.value=e.filter(e=>e.isRecommended),console.log("干净的需求数据：",f.value)};const k=()=>{const e=function(e,a){const o=[...e,...a];for(let t=o.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[o[t],o[e]]=[o[e],o[t]]}return o}(v.value,f.value);y.value=e,y.value.sort((e,a)=>a.recommendPriority-e.recommendPriority),console.log("混合后的最终列表：",y.value)},q=e.computed(()=>y.value.filter(e=>e.isRecommended)),A=async e=>{try{const a=await t.userApi.getUserInfo(e);return 200===a.code?{avatar:a.data.avatar||"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:a.data.nickname||"未知用户"}:null}catch(a){return console.error("获取用户信息失败:",a),null}};return(a,o)=>e.e({a:b.value},(b.value,{}),{b:b.value},b.value?{c:e.o(P),d:e.o(U)}:{},{e:r.value+"px",f:r.value+"px",g:c.value+"px",h:e.p({type:"notification",size:"24",color:"#007aff"}),i:e.f(m.value,(a,o,t)=>({a:e.t(a.content),b:o})),j:e.p({type:"right",size:"16",color:"#333"}),k:e.o(j),l:"url('https://api.shaolezhuan.cn/lzphoto/indextop.jpg')",m:e.f(p.value,(a,o,t)=>({a:a.icon,b:e.t(a.name),c:o,d:e.o(e=>w(a.name),o)})),n:e.f(u.value,(a,o,t)=>({a:a.icon,b:e.t(a.name),c:o,d:e.o(e=>w(a.name),o)})),o:e.f(h.value,(e,a,o)=>({a:e.imageUrl,b:`轮播图${a+1}`,c:a})),p:0===q.value.length},0===q.value.length?{}:{q:e.p({list:q.value,columnCount:2,gap:16,borderRadius:8})},{r:z.value},(z.value,{}),{s:6*r.value+"px"})}},r=e._export_sfc(s,[["__scopeId","data-v-bfe361c4"]]);wx.createPage(r);
