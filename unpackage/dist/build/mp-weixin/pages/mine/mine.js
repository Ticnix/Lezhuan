"use strict";const e=require("../../common/vendor.js"),a=require("../../api/user.js"),o=require("../../api/chat.js"),n=require("../../hooks/useStorage.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"mine",setup(t){const{getStorage:r,setStorage:s}=n.useStorage(),l=e.computed(()=>r("userId")),i=e.computed(()=>r("token")),u=e.ref(null),c=e.ref(null),d=e.ref(!1),v=e.ref(null),g=e.ref(!1),p=e.ref(null),m=e.ref([{imageUrl:"https://api.shaolezhuan.cn/lzphoto/membership/m1.jpg"},{imageUrl:"https://api.shaolezhuan.cn/lzphoto/membership/m2.jpg"},{imageUrl:"https://api.shaolezhuan.cn/lzphoto/membership/m3.jpg"}]),h=e.ref(0);onShow(()=>{i.value&&l.value&&f()}),e.onMounted(()=>{i.value&&l.value&&(x(),w(),f())});const f=async()=>{try{const e=r("userId");if(!e)return;const a=await o.chatApi.unreadMessages(e);console.log("获取用户所有未读消息返回信息:",a),200===a.code&&(h.value=a.data.totalUnreadCount||0)}catch(e){console.error("获取未读消息失败:",e)}},x=async()=>{try{const o=await a.userApi.getCurrentUser();200===o.code&&(u.value=o.data,e.index.setStorageSync("membershipType",u.value.membershipType),console.log("获取当前用户信息：",u.value))}catch(o){console.error("获取用户信息失败:",o)}},w=async()=>{try{const e=await a.userApi.studentInfoStatus();200===e.code&&(c.value=e.data,v.value=e.data.status,console.log("获取当前用户学生认证状态：",c.value),"approved"===v.value&&(d.value=!0,p.value=c.value.studentIdNumber,s("studentIdNumber",p.value),console.log(p.value)))}catch(e){console.error("获取学生认证失败:",e)}},y=async()=>{try{const o=await new Promise((a,o)=>{e.index.getUserProfile({desc:"用于完善用户资料",success:a,fail:o})}),n=await new Promise((a,o)=>{e.index.login({success:a,fail:o})});if(!n.code)throw new Error("无法获取登录凭证");const t={code:n.code,nickname:o.userInfo.nickName,avatarUrl:o.userInfo.avatarUrl};console.log("code：",t.code),console.log("nickname：",t.nickname),console.log("avatarUrl：",t.avatarUrl);const r=await a.userApi.wxLogin(t);if(200!==r.code)throw 400===r.code&&r.msg.includes("code无效")?(g.value=!0,new Error("登录凭证已过期，请重新登录")):new Error(r.msg||"登录失败");{const a=r.data;s("token",a.token),s("nickname",a.nickname),s("avatarUrl",a.avatarUrl),s("userId",a.userId),s("openid",a.openid),e.index.setStorageSync("membershipType",a.membershipType),console.log("后端返回的数据：",a),u.value={nickname:a.nickname,avatarUrl:a.avatarUrl},w(),f(),e.index.showToast({title:"登录成功",icon:"success"})}}catch(o){e.index.showToast({title:o.message,icon:"none"}),console.error("登录过程出错:",o)}},T=()=>{g.value=!1,y()},U=()=>e.index.navigateTo({url:"/pages/setting/setting"}),b=()=>e.index.navigateTo({url:"/pages/student/student"}),k=()=>e.index.navigateTo({url:"/pages/publish/publish"}),S=()=>e.index.navigateTo({url:"/pages/sell/sell"}),I=()=>e.index.navigateTo({url:"/pages/history/history"}),j=()=>e.index.navigateTo({url:"/pages/demand/demand"}),z=()=>e.index.navigateTo({url:"/pages/collect/collect"}),C=()=>e.index.navigateTo({url:"/pages/message/message"}),_=()=>e.index.navigateTo({url:"/pages/guide/guide"}),q=()=>e.index.navigateTo({url:"/pages/membership/membership"}),A=()=>{e.index.showToast({title:"其他功能正在维护中",icon:"none",duration:2e3,mask:!0})};return(a,o)=>{var n,t;return e.e({a:(null==(n=u.value)?void 0:n.avatarUrl)||"",b:e.o(y),c:e.t((null==(t=u.value)?void 0:t.nickname)||"点击头像登录"),d:e.t(p.value||"请完成学生认证"),e:e.p({type:"gear",size:"30"}),f:e.o(U),g:d.value},d.value?{h:e.f(m.value,(a,o,n)=>({a:a.imageUrl,b:e.o(q,o),c:o}))}:{i:e.o(b)},{j:e.o(k),k:e.o(S),l:h.value>0},h.value>0?{m:e.t(h.value)}:{},{n:e.o(C),o:e.o(I),p:e.o(j),q:e.o(z),r:e.o(_),s:e.o(A),t:e.o((...e)=>a.handleContact&&a.handleContact(...e)),v:e.o((...e)=>a.handleContactService&&a.handleContactService(...e)),w:g.value},g.value?{x:e.o(T)}:{})}}},r=e._export_sfc(t,[["__scopeId","data-v-a4462804"]]);wx.createPage(r);
