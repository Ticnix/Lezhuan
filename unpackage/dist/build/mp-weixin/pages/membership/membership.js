"use strict";const e=require("../../common/vendor.js"),a=require("../../api/pay.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"membership",setup(o){let n="";const t=e.ref("none"),l=e.ref("normal");e.onMounted(async()=>{t.value=e.index.getStorageSync("membershipType")});const i=e.computed(()=>{switch(t.value){case"none":default:return"0%";case"normal":return"50%";case"platinum":return"100%"}}),r=async o=>{var l,i,r;try{const r="platinum"===o&&"normal"===t.value?"升级":"购买";e.index.showLoading({title:`${r}中...`});const p={normal:{packageId:3,amount:200,body:"乐转-普通会员",detail:"普通会员套餐，享聊一聊、购物等功能"},platinum:{packageId:4,amount:"normal"===t.value?300:1,body:"乐转-白金会员",detail:"白金会员套餐，享发布需求等全部功能"}}[o],s=e.index.getStorageSync("openid"),c=await a.payApi.postMembership({packageId:p.packageId,isUpgrade:"platinum"===o&&"normal"===t.value});if(console.log("调用后端创建业务订单接口返回情况：",c),200!==c.code||!(null==(l=c.data)?void 0:l.id))throw new Error("创建业务订单失败，原因："+((null==(i=c.data)?void 0:i.msg)||"接口异常"));const m=c.data.id,d=await a.payApi.postWeChatpay({attach:"membership_order",body:p.body,businessOrderId:m,businessType:"membership",detail:p.detail,openid:s,totalAmount:p.amount});if(console.log("调用后端创建微信支付订单返回情况：",d),n=d.data.outTradeNo,200!==d.code)throw new Error("创建微信支付订单失败，原因："+((null==d?void 0:d.msg)||"接口异常"));const{appId:v,nonceStr:y,packageValue:g,paySign:f,timeStamp:h,prepayId:S}=d.data,w=await e.index.requestPayment({provider:"weixin",timeStamp:h,nonceStr:y,package:g,signType:"RSA",paySign:f,appId:v});console.log("调用微信支付返回情况：",w),"requestPayment:ok"===w.errMsg&&(e.index.showToast({title:`${r}会员成功`,icon:"success"}),t.value=o,e.index.setStorageSync("membershipType",o),await u(d.data.outTradeNo))}catch(p){(null==(r=p.errMsg)?void 0:r.includes("cancel"))?e.index.showToast({title:"支付已取消",icon:"none"}):e.index.showToast({title:p.message||"支付失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},u=async e=>{var o;const n=await a.payApi.queryOrderStatus(e);200===n.statusCode&&"SUCCESS"===(null==(o=n.data)?void 0:o.tradeState)&&console.log("订单支付状态已确认：成功")};return(a,o)=>e.e({a:"normal"===t.value},"normal"===t.value?{b:e.p({type:"vip",size:"25",color:"#fff"}),c:i.value,d:"none"!==t.value?1:"",e:"normal"===t.value||"platinum"===t.value?1:"",f:"platinum"===t.value?1:""}:"platinum"===t.value?{h:e.p({type:"vip",size:"25",color:"#fff"}),i:i.value,j:"none"!==t.value?1:"",k:"normal"===t.value||"platinum"===t.value?1:"",l:"platinum"===t.value?1:""}:{m:i.value,n:"none"!==t.value?1:"",o:"normal"===t.value||"platinum"===t.value?1:"",p:"platinum"===t.value?1:""},{g:"platinum"===t.value,q:e.p({type:"chat",size:"24",color:"#7c89ff"}),r:e.p({type:"cart",size:"24",color:"#7c89ff"}),s:e.p({type:"compose",size:"24",color:"#7c89ff"}),t:e.p({type:"upload",size:"24",color:"#7c89ff"}),v:"none"===t.value},"none"===t.value?{w:e.o(e=>r("normal"))}:{},{x:"normal"===l.value?1:"",y:e.o(e=>l.value="normal"),z:e.t("normal"===t.value?"3":"5"),A:"normal"===t.value},(t.value,{}),{B:"platinum"!==t.value},"platinum"!==t.value?{C:e.t("normal"===t.value?"立即升级":"立即购买"),D:e.o(e=>r("platinum"))}:{},{E:"platinum"===l.value?1:"",F:e.o(e=>l.value="platinum")})}},n=e._export_sfc(o,[["__scopeId","data-v-c6fb4bb2"]]);wx.createPage(n);
