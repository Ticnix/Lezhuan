"use strict";const e=require("../../common/vendor.js"),a=require("../../api/product.js");if(!Array){e.resolveComponent("uni-icons")()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+l)();const l=()=>"../../components/Waterfall.js",t={__name:"category",setup(l){e.ref("");const t=e.ref(""),o=e.ref(["全部","出物","收物"]),r=e.ref(0),i=e.ref([]),n=e.ref(0),u=e.ref(""),s=e.ref(["全部","0-50元","50-100元","100-300元","300-500元","500元以上"]),c=e.ref(0),v=e.ref(!1);e.ref([]),e.ref([]),e.ref([]),e.ref(null),e.ref(""),e.ref([]),e.ref([]);const d=e.ref(1),f=e.ref(4),m=e.ref(!1),g=e.ref(!0),p=e.ref(1),h=e.ref(4),y=e.ref(!1),w=e.ref(!0),x=e.ref([]),P=e.ref([]),A=e.ref([]),b=e.ref(300),z=e.ref(null),j={"0-50元":{min:0,max:50},"50-100元":{min:50,max:100},"100-300元":{min:100,max:300},"300-500元":{min:300,max:500},"500元以上":{min:500,max:1/0}},N={"电子数码":["键盘","鼠标","电脑","耳机","显示器"],"自行车":["山地车","公路车","折叠车","儿童自行车","电动车"],"电器":["冰箱","电视","洗衣机","空调","微波炉"],"体育用品":["篮球","足球","羽毛球拍","跑步机","瑜伽垫"],"二手书":["小说","教材","工具书","杂志","漫画"],"生活用品":["抱枕","台灯","收纳盒","餐具","家纺"],"虚拟用品":["游戏账号","虚拟货币","数字会员","线上课程","软件激活码"],"其他":["收藏品","手工制品","闲置饰品","宠物用品","办公用品"]},C=e.ref(0);e.ref(0),e.onLoad(a=>{e.index.getSystemInfo({success:e=>{C.value=750*e.statusBarHeight/e.windowWidth}}),a.type&&(u.value=a.type,k())});const T=()=>{const e=Object.keys(N).indexOf(u.value)+1;return-1!==e?e:-1};e.onMounted(async()=>{if(u.value&&(M(T(),!1),O(!1)),await e.nextTick$1(),z.value){console.log("scroll-view 绑定成功"),console.log("scroll-view已渲染，元素：",z.value);e.index.createSelectorQuery().in(z.value).boundingClientRect(e=>{console.log("scroll-view实际高度：",null==e?void 0:e.height)}).exec()}else console.error("scroll-view ref 绑定失败，请检查拼写");_()});const _=()=>{setTimeout(()=>{e.index.createSelectorQuery().select(".scroll-container").boundingClientRect(e=>{e?console.log("scroll-container clientHeight：",e.clientHeight):console.error("未找到 .scroll-container 元素")}).exec()},300)};e.watch([r,n,c],()=>{v.value=!1});const k=()=>{i.value=["全部",...N[u.value]||[]],n.value=0},I=e=>{r.value=e.detail.value,q()},S=e=>{n.value=e.detail.value,q()},L=e=>{c.value=e.detail.value,q()},U=()=>{q()},q=()=>{d.value=1,P.value=[],g.value=!0,p.value=1,A.value=[],w.value=!0,x.value=[],M(T(),!1),O(!1)},H=e=>{const{scrollTop:a,scrollHeight:l}=e.detail;l-a-760<b.value&&!m.value&&!y.value&&(g.value||w.value)&&(console.log("触发预加载"),g.value&&!m.value&&(d.value+=1,M(T(),!0)),w.value&&!y.value&&(p.value+=1,O(!0)))},M=async(l,t=!1)=>{if(!m.value&&g.value){m.value=!0;try{const o={categoryId:l,current:t?d.value:1,size:f.value};console.log("商品列表请求参数：",o);const r=await a.productApi.getCategorie(o);if(200===r.code){const e=r.data.records||[];if(0===e.length)return void(g.value=!1);t?P.value.push(e):(P.value=[e],d.value=1);const a=await B(e);if(t)x.value=[...x.value,...Q(a)];else if(x.value=Q(a),A.value.length>0){const e=A.value[0],a=await D(e);x.value=[...x.value,...Q(a)]}g.value=e.length===f.value}else e.index.showToast({title:r.message||"获取商品列表失败",icon:"none"}),g.value=!1}catch(o){console.error("商品请求异常：",o),e.index.showToast({title:"网络异常",icon:"none"}),g.value=!1}finally{m.value=!1}}},O=async(l=!1)=>{if(!y.value&&w.value){y.value=!0;try{const t={categoryId:T(),status:"active",current:l?p.value:1,size:h.value};console.log("需求列表请求参数：",t);const o=await a.productApi.getDemandList(t);if(200===o.code){const e=o.data.records||[];if(0===e.length)return void(w.value=!1);l?A.value.push(e):(A.value=[e],p.value=1);const a=await D(e);if(l)x.value=[...x.value,...Q(a)];else if(x.value=Q(a),P.value.length>0){const e=P.value[0],a=await B(e);x.value=[...x.value,...Q(a)]}w.value=e.length===h.value}else e.index.showToast({title:o.message||"获取需求列表失败",icon:"none"}),w.value=!1}catch(t){console.error("需求请求异常：",t),e.index.showToast({title:"网络异常",icon:"none"}),w.value=!1}finally{y.value=!1}}},B=async e=>(await Promise.all(e.map(e=>{let a=[],l="其他";try{const t=JSON.parse(e.attributes||"{}");l=t.subcategory||t.category||"其他",a=[e.isNegotiable?"可刀":"不可刀",t.category||"其他",t.subcategory||"其他",t.condition||"未知成色"].filter(Boolean)}catch(t){a=[]}return{id:e.id,imgUrl:e.mainImageUrl||"https://api.shaolezhuan.cn/lzphoto/productDefault.jpg",tags:a,title:e.title||"未知商品",desc:e.description||"",categoryName:e.categoryName,user:e.requester||{avatar:"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:"未知用户"},category:l,type:"product",price:e.price||0,status:e.status,sortPriority:e.adminPinScore||0,isAdminPinned:e.isAdminPinned||!1}}))).filter(e=>"active"===e.status),D=async e=>(await Promise.all(e.map(e=>({id:e.id,imgUrl:e.mainImageUrl||"https://api.shaolezhuan.cn/lzphoto/demandpic.png",tags:["需求"],title:e.title||"未知需求",desc:e.description||"",categoryName:u.value,user:{avatar:e.sellerAvatarUrl,nickname:e.sellerNickname},category:u.value||"其他",type:"demand",price:e.budget||0,status:e.status,sortPriority:e.adminPinScore||0,isAdminPinned:e.isAdminPinned||!1})))).filter(e=>"active"===e.status),Q=e=>{const a=[...e];for(let l=a.length-1;l>0;l--){const e=Math.floor(Math.random()*(l+1));[a[l],a[e]]=[a[e],a[l]]}return a},R=e.computed(()=>{let e=[...x.value];if(t.value.trim()){const a=t.value.trim().toLowerCase();e=e.filter(e=>{const l=e.title.toLowerCase().includes(a),t=e.desc.toLowerCase().includes(a);return l||t})}const a=o.value[r.value];if(a&&"全部"!==a){const l={"出物":"product","收物":"demand"};e=e.filter(e=>e.type===l[a])}const l=i.value[n.value];l&&"全部"!==l&&(e=e.filter(e=>(Array.isArray(e.tags)?e.tags:[]).includes(l)||e.category===l));const u=s.value[c.value];if(u&&"全部"!==u){const a=j[u];e=e.filter(e=>{const l=Number(e.price)||0;return l>=a.min&&l<a.max})}return e.sort((e,a)=>e.isAdminPinned!==a.isAdminPinned?a.isAdminPinned-e.isAdminPinned:e.sortPriority!==a.sortPriority?a.sortPriority-e.sortPriority:Number(e.price)-Number(a.price))});return(a,l)=>e.e({a:e.p({type:"search",size:"24",color:"#999"}),b:e.o(U),c:t.value,d:e.o(e=>t.value=e.detail.value),e:e.t(o.value[r.value]),f:e.p({type:"down",size:"18",color:"#999"}),g:o.value,h:r.value,i:e.o(I),j:e.t(i.value[n.value]||"全部"),k:e.p({type:"down",size:"18",color:"#999"}),l:i.value,m:n.value,n:e.o(S),o:e.t(s.value[c.value]||"全部"),p:e.p({type:"down",size:"18",color:"#999"}),q:s.value,r:c.value,s:e.o(L),t:"url('/static/bg.jpg')",v:0===R.value.length},0===R.value.length?{}:e.e({w:e.p({list:R.value,columnCount:2,gap:20,"virtual-scroll":!0,"visible-height":800}),x:m.value.value||y.value.value},(m.value.value||y.value.value,{}),{y:e.o(H),z:`calc(100vh - ${C.value+300}rpx)`,A:!g.value.value&&!w.value.value},(g.value.value||w.value.value,{})))}},o=e._export_sfc(t,[["__scopeId","data-v-2c0ca219"]]);wx.createPage(o);
