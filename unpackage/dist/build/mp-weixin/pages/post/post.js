"use strict";const e=require("../../common/vendor.js"),a=require("../../api/product.js"),o=require("../../hooks/useStorage.js"),l=require("../../utils/system.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const t={__name:"post",setup(t){const{getStorage:n,setStorage:u}=o.useStorage(),i=e.ref(0),r=e.ref([]),s=async()=>{if(r.value.length>=9)return void e.index.showToast({title:"最多只能上传9张图片",icon:"none"});const a=await e.index.chooseImage({count:9-r.value.length,sizeType:["original","compressed"],sourceType:["album","camera"]});e.index.showLoading({title:"上传中...",mask:!0});try{const o=a.tempFilePaths.map(async a=>{const o=await e.index.uploadFile({url:"https://api.shaolezhuan.cn/api/upload/image",filePath:a,name:"file",header:{Authorization:e.index.getStorageSync("token")},formData:{userId:e.index.getStorageSync("userId")}}),l=JSON.parse(o.data);if(console.log("上传结果：",l),200!==l.code)throw new Error(`图片上传失败: ${l.msg||"未知错误"}`);return l.data.url}),l=await Promise.all(o);r.value=[...r.value,...l],console.log("所有图片上传完成，永久URL列表:",r.value),e.index.showToast({title:`成功上传${l.length}张图片`,icon:"success"})}catch(o){console.error("上传失败:",o),e.index.showToast({title:o.message||"图片上传失败",icon:"none"})}finally{e.index.hideLoading()}},v={"电子数码":["键盘","鼠标","电脑","耳机","显示器"],"自行车":["山地车","公路车","折叠车","儿童自行车","电动车"],"电器":["冰箱","电视","洗衣机","空调","微波炉"],"体育用品":["篮球","足球","羽毛球拍","跑步机","瑜伽垫"],"二手书":["小说","教材","工具书","杂志","漫画"],"生活用品":["抱枕","台灯","收纳盒","餐具","家纺"],"虚拟用品":["游戏账号","虚拟货币","数字会员","线上课程","软件激活码"],"其他":["收藏品","手工制品","闲置饰品","宠物用品","办公用品"]},c=["99新","95新","9成新","8成新","7成新","6成新及以下"],d=e.ref(""),p=e.ref(""),g=e.ref(""),f=e.ref(0),m=e.ref(!0),h=e.ref(3);let y=null;const x=e=>{if(f.value===e)f.value=0;else{if(2===e&&!d.value)return;f.value=e}},b=e.ref(""),w=e.ref(""),T=e.ref(""),k=e.ref("");e.ref(!1);const P=[{label:"线下自行交易",value:"线下自行交易"}],S=e.ref("");e.ref(!1);const z=e.ref(null),j=async()=>{var a;try{await e.nextTick$1(),null==(a=z.value)||a.open("bottom")}catch(o){console.error("打开价格弹窗失败:",o),e.index.showToast({title:"打开价格弹窗失败",icon:"none"})}},I=()=>{var e;null==(e=z.value)||e.close(),T.value=""},N=()=>{var a;if(T.value){if(k.value){if(Number(k.value)<=0)return void e.index.showToast({title:"原价必须大于0",icon:"none"});if(Number(k.value)<Number(T.value))return void e.index.showToast({title:"原价不能低于售价",icon:"none"})}console.log(k.value),null==(a=z.value)||a.close()}else e.index.showToast({title:"请输入售价",icon:"none"})},A=e.ref(null),_=async()=>{var a;try{await e.nextTick$1(),null==(a=A.value)||a.open("bottom")}catch(o){console.error("打开交易方式弹窗失败:",o),e.index.showToast({title:"打开交易方式弹窗失败",icon:"none"})}},q=e.ref(!1),D=e.ref(),L=e.ref(""),M=e.ref(null),$=async()=>{var a;try{await e.nextTick$1(),null==(a=M.value)||a.open("bottom")}catch(o){console.error("打开小刀弹窗失败:",o),e.index.showToast({title:"打开小刀弹窗失败",icon:"none"})}},B=e=>{var a;e?q.value=!0:(D.value="不小刀",null==(a=M.value)||a.close())};e.ref();const C=()=>{var a;L.value?(D.value="可小刀"+L.value+"元",null==(a=M.value)||a.close()):e.index.showToast({title:"请输入可刀价格",icon:"none"})},E=async()=>{if(0===r.value.length)return void e.index.showToast({title:"请至少上传一张图片",icon:"none"});if(!b.value.trim())return void e.index.showToast({title:"请填写商品描述",icon:"none"});if(!w.value.trim())return void e.index.showToast({title:"请填写商品标题",icon:"none"});if(!T.value)return e.index.showToast({title:"请填写价格",icon:"none"}),void j();if(!S.value)return e.index.showToast({title:"请选择交易方式",icon:"none"}),void _();if(!d.value)return void e.index.showToast({title:"请选择物品种类",icon:"none"});if(!g.value)return void e.index.showToast({title:"请选择商品成色",icon:"none"});const o={"电子数码":1,"自行车":2,"电器":3,"体育用品":4,"二手书":5,"生活用品":6,"虚拟用品":7,"其他":8}[d.value]||0,l={category:d.value,subcategory:p.value,condition:g.value},t={title:w.value,description:b.value.trim(),price:Number(T.value),originalPrice:k.value,categoryId:o,attributes:JSON.stringify(l),isNegotiable:!(void 0===D.value||"不小刀"===D.value),maxNegotiableAmount:L.value,tradingMethod:S.value,mainImageUrl:r.value[0],detailImages:r.value.join(",")};console.log("前端打包的发布商品数据:",t);try{const o=await a.productApi.postProduct(t);console.log("后端订单返回的结果为：",o),200===o.code?(e.index.showToast({title:"发布成功",icon:"success"}),R(),e.index.removeStorageSync("productDraft"),setTimeout(()=>{e.index.navigateTo({url:"/pages/wait/wait"})},500)):e.index.showToast({title:`发布失败：${o.msg||"未知错误"}`,icon:"none"})}catch(n){console.error("发布商品请求失败:",n),e.index.showToast({title:"发布商品请求失败，请检查网络或稍后再试",icon:"none"})}},F=e.ref(null),U=e.ref({}),O=()=>{var a;null==(a=F.value)||a.close(),setTimeout(()=>{e.index.navigateBack({delta:1})},300)},J=()=>{var a;U.value={title:w.value,description:b.value.trim(),images:[...r.value],price:T.value,originalPrice:k.value,tradeMethod:S.value,category:d.value,subcategory:p.value,condition:g.value,negotiable:D.value||"不小刀",negotiablePrice:L.value,saveTime:(new Date).getTime()},u("productDraft",U.value),e.index.showToast({title:"草稿保存成功",icon:"success"}),console.log("保存的草稿内容:",U.value),null==(a=F.value)||a.close(),setTimeout(()=>{e.index.navigateBack({delta:1})},1500)},H=()=>b.value.trim()||r.value.length||T.value||S.value?(F.value&&F.value.open("center"),!0):(e.index.navigateBack({delta:1}),!1);e.onBackPress(e=>"backbutton"===e.from&&H());const R=()=>{var e,a,o,l;r.value=[],w.value="",b.value="",d.value="",p.value="",g.value="",f.value=0,T.value="",k.value="",S.value="",D.value="",L.value="",q.value=!1,null==(e=z.value)||e.close(),null==(a=A.value)||a.close(),null==(o=M.value)||o.close(),null==(l=F.value)||l.close()};return e.onMounted(()=>{i.value=l.getStatusBarHeight(),(()=>{try{const e=n("productDraft");console.log("草稿内容为:",e),e&&"object"==typeof e&&(w.value=e.title||"",b.value=e.description||"",r.value=e.images&&Array.isArray(e.images)?e.images:[],T.value=e.price||"",k.value=e.originalPrice||"",S.value=e.tradeMethod||"",d.value=e.category||"",p.value=e.subcategory||"",g.value=e.condition||"",D.value=e.negotiable||"不小刀",L.value=e.negotiablePrice||"",q.value=!(!e.negotiable||!e.negotiable.includes("可小刀")))}catch(e){console.error("加载草稿失败:",e)}})(),y=setInterval(()=>{h.value>0?h.value--:clearInterval(y)},1e3)}),e.onUnmounted(()=>{y&&clearInterval(y)}),(a,o)=>e.e({a:m.value},m.value?{b:e.t(h.value>0?`请等待 ${h.value} 秒`:"我知道了"),c:e.o(e=>m.value=!1),d:h.value>0}:{},{e:!m.value},m.value?{}:e.e({f:i.value+"px",g:e.p({type:"left",size:"24"}),h:e.o(H),i:e.p({type:"plus",size:"30",color:"#999"}),j:e.o(s),k:e.f(r.value,(a,o,l)=>({a:a,b:"a38b773d-2-"+l,c:e.o(a=>(async a=>{const o=r.value[a];console.log("要删除的文件路径:",o),o&&e.index.showModal({title:"确认删除",content:"确定要删除这张图片吗？删除后不可恢复",cancelText:"取消",confirmText:"删除",async success(l){if(l.confirm){e.index.showLoading({title:"删除中...",mask:!0});try{const l=(await e.index.request({url:"https://api.shaolezhuan.cn/api/upload/file",method:"DELETE",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{fileUrl:o}})).data;200===l.code?(r.value.splice(a,1),e.index.showToast({title:"删除成功",icon:"success"})):(r.value.splice(a,1),e.index.showToast({title:"图片已从列表移除，服务器删除失败",icon:"none"}),console.warn("后端删除失败:",l.msg))}catch(t){r.value.splice(a,1),e.index.showToast({title:"网络异常，图片已从本地移除",icon:"none"}),console.error("删除异常:",t)}finally{e.index.hideLoading()}}}})})(o),o),d:o})),l:e.p({type:"close",size:"18",color:"#fff"}),m:w.value,n:e.o(e=>w.value=e.detail.value),o:e.t(w.value.length),p:b.value,q:e.o(e=>b.value=e.detail.value),r:e.t(b.value.length),s:e.t(d.value||"物品种类"),t:1===f.value?1:"",v:e.p({type:"down",size:"18",color:"#999"}),w:e.o(e=>x(1)),x:e.t(p.value||"子分类"),y:2===f.value?1:"",z:e.p({type:"down",size:"18",color:"#999"}),A:e.o(e=>x(2)),B:d.value?"":1,C:e.t(g.value||"成色"),D:3===f.value?1:"",E:e.p({type:"down",size:"18",color:"#999"}),F:e.o(e=>x(3)),G:f.value},f.value?e.e({H:1===f.value},1===f.value?{I:e.f(Object.keys(v),(a,o,l)=>({a:e.t(a),b:a,c:e.o(e=>(e=>{d.value=e,p.value="",f.value=0})(a),a)}))}:{},{J:2===f.value},2===f.value?{K:e.f(v[d.value],(a,o,l)=>({a:e.t(a),b:a,c:e.o(e=>(e=>{p.value=e,f.value=0})(a),a)}))}:{},{L:3===f.value},3===f.value?{M:e.f(c,(a,o,l)=>({a:e.t(a),b:a,c:e.o(e=>(e=>{g.value=e,f.value=0})(a),a)}))}:{}):{},{N:e.t(T.value?"¥"+T.value:"请填写"),O:e.p({type:"right",size:"18",color:"#999"}),P:e.o(j),Q:e.t(S.value||"请选择"),R:e.p({type:"right",size:"18",color:"#999"}),S:e.o(_),T:e.t(D.value||"请选择"),U:e.p({type:"right",size:"18",color:"#999"}),V:e.o($),W:e.o(E),X:T.value,Y:e.o(e=>T.value=e.detail.value),Z:k.value,aa:e.o(e=>k.value=e.detail.value),ab:e.o(I),ac:e.o(N),ad:e.sr(z,"a38b773d-9",{k:"pricePopup"}),ae:e.p({type:"bottom","background-color":"#fff",mask:!0,"mask-click":!0}),af:e.f(P,(a,o,l)=>e.e({a:e.t(a.label),b:S.value===a.value},S.value===a.value?{c:"a38b773d-11-"+l+",a38b773d-10",d:e.p({type:"checkmark",size:"20",color:"#FFCC00"})}:{},{e:a.value,f:e.o(e=>{return o=a.value,S.value=o,void A.value.close();var o},a.value)})),ag:e.sr(A,"a38b773d-10",{k:"tradePopup"}),ah:e.p({type:"bottom","背景-color":"#fff"}),ai:e.o(e=>B(!0)),aj:e.o(e=>B(!1)),ak:q.value},q.value?{al:L.value,am:e.o(e=>L.value=e.detail.value),an:e.o(C)}:{},{ao:e.sr(M,"a38b773d-12",{k:"negotiablePopup"}),ap:e.p({type:"bottom","background-color":"#fff",mask:!0,"mask-click":!0}),aq:e.o(O),ar:e.o(J),as:e.sr(F,"a38b773d-13",{k:"draftPopup"}),at:e.p({type:"center","background-color":"#fff",mask:!0,"mask-click":!1})}))}},n=e._export_sfc(t,[["__scopeId","data-v-a38b773d"]]);wx.createPage(n);