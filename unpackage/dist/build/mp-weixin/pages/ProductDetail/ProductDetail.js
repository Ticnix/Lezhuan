"use strict";const e=require("../../common/vendor.js"),a=require("../../api/product.js"),t=require("../../api/user.js");if(!Array){e.resolveComponent("uni-fav")()}Math||(o+(()=>"../../uni_modules/uni-fav/components/uni-fav/uni-fav.js"))();const o=()=>"../../components/Waterfall.js",l={__name:"ProductDetail",setup(o){const l=e.ref({}),n=e.ref(!1),r=e.ref(!1),i=e.ref([]),s=e.ref([]),u=e.ref([]),d=e.ref([]),c=e.ref([]),v=e.ref([]),p=e.ref(!1),g=e.ref(""),m=e.ref(!1);let h="",f="";const y=()=>"demand"===f?c.value:v.value;e.onLoad(e=>{h=e.id||"",f=e.type||"product",j()}),e.onMounted(()=>{if(w(),console.log("商品ID:",h),console.log("商品类型：",f),!h)return e.index.showToast({title:"参数错误",icon:"none"}),void setTimeout(()=>e.index.navigateBack(),1500);"demand"===f?(A(h),I()):(x(h),z())});const w=async()=>{if(m.value||!h)return;const e={itemId:Number(h),itemType:f};console.log("浏览记录提交的数据：",e);try{const a=await t.userApi.recordBrowseHistory(e);200===a.code?console.log("浏览记录提交成功",a.data):console.warn("浏览记录提交失败",a.msg)}catch(a){console.error("浏览记录接口调用失败",a)}finally{m.value=!0}},A=async t=>{try{const o=await a.productApi.getDemandDetail(t);200===o.code?(l.value=o.data,console.log("得到详细的需求数据是：",l.value),await T(o.data.requester.id)):e.index.showToast({title:o.msg||"获取需求失败",icon:"none"})}catch(o){console.error("需求加载失败:",o),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},x=async t=>{try{const o=await a.productApi.getProductDetail(t);200===o.code?(l.value=o.data,await b(o.data.sellerId),console.log("得到详细的商品数据是：",l.value)):e.index.showToast({title:o.msg||"获取商品失败",icon:"none"})}catch(o){console.error("商品加载失败:",o),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},T=async e=>{try{const t=await a.productApi.getSellerItem(e);console.log("接口返回的发布者其他需求：",t.data.demands),200===t.code&&(c.value=t.data.demands.filter(e=>e.id!==l.value.id).map(e=>({...e,imgUrl:e.imgUrl||"https://api.shaolezhuan.cn/lzphoto/demandpic.png",budget:e.budget||"0.00"})),console.log("当前 detailType：",f),console.log("sellerDemands 长度：",c.value.length),console.log("getCurrentRelatedList() 实际值：","demand"===f?"来自 sellerDemands":"来自 sellerProducts"),console.log("currentRelatedList为",y()))}catch(t){console.error("获取发布者其他需求失败:",t)}},b=async e=>{try{const t=await a.productApi.getSellerItem(e);console.log("接口返回的发布者其他商品：",t.data.demands),200===t.code&&(v.value=t.data.products.filter(e=>e.id!==l.value.id),console.log("后端返回给获取该商家的所有商品数据：",v.value))}catch(t){console.error("获取发布者其他需求失败:",t)}},I=async()=>{try{const t=await a.productApi.getAllDemands();console.log("接口获取的所有需求推荐数据",t.data),200===t.code?(i.value=t.data||[],await P(),console.log("获取推荐需求的脏数据：",i.value)):e.index.showToast("获取需求数据失败")}catch(t){console.error("获取推荐数据失败：",t),e.index.showToast("网络异常，获取推荐数据失败")}},z=async()=>{try{const t=await a.productApi.getAllGoods();200===t.code?(console.log("后端返回的对应分类推荐商品为：",t.data),s.value=t.data||[],D()):(e.index.showToast({title:t.message||"获取商品列表失败",icon:"none"}),d.value=[])}catch(t){e.index.showToast({title:"网络异常，获取商品列表失败",icon:"none"}),console.error("获取商品列表失败：",t),goodsList.value=[]}},P=async()=>{console.log("清洗前的需求数据：",i.value);const e=await Promise.all(i.value.map(async e=>{let a=[];try{const t=JSON.parse(e.attributes||"{}");a=Object.values(t)}catch(t){console.error("解析 attributes 失败:",t),a=[]}return{id:e.id,imgUrl:e.mainImageUrl||"https://api.shaolezhuan.cn/lzphoto/demandpic.png",tags:["需求"],title:e.title||"未知需求",desc:e.description||"",categoryName:"需求分类",user:e.requester||{avatar:"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg.jpeg",nickname:"未知用户"},category:"全部",type:"demand",price:e.budget||0,status:e.status,sortPriority:e.adminPinScore||0,isAdminPinned:e.isAdminPinned||!1}}));console.log("清洗后的需求数据：",e);const a=e.filter(e=>"active"===e.status);u.value=a},D=async()=>{console.log("清洗前的商品数据：",s.value);const e=(await Promise.all(s.value.map(async e=>{let a=[];try{const t=JSON.parse(e.attributes||"{}");a=Object.values(t),a.unshift(e.isNegotiable?"可刀":"不可刀")}catch(t){console.error("解析 attributes 失败:",t),a=[]}return{id:e.id,imgUrl:e.mainImageUrl||"https://api.shaolezhuan.cn/lzphoto/productDefault.jpg",tags:a,title:e.title||"未知商品",desc:e.description||"",categoryName:e.categoryName,user:{avatar:"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",nickname:"未知用户"},category:a[1]||"其他",type:"product",price:e.price||0,status:e.status,sortPriority:e.adminPinScore||0,isAdminPinned:e.isAdminPinned||!1}}))).filter(e=>"active"===e.status);console.log("清洗并筛选后的商品数据：",e),d.value=e},j=async()=>{try{const e=await t.userApi.getFavoriteStatus(f,h);n.value=e.data,200===e.code&&console.log("查询用户的收藏状态为：",n.value)}catch(e){console.error("查询收藏状态失败:",e)}},q=async()=>{try{if(n.value){200===(await t.userApi.cancelFavorite({itemId:h,itemType:f})).code&&(e.index.showToast({title:"取消收藏成功",icon:"success"}),n.value=!n.value)}else{200===(await t.userApi.addFavorite({itemId:h,itemType:f})).code&&(e.index.showToast({title:"收藏成功",icon:"success"}),n.value=!n.value)}console.log("操作后的收藏状态为：",n.value)}catch(a){console.error("收藏操作失败:",a),e.index.showToast({title:n.value?"取消收藏失败":"收藏失败",icon:"none"}),n.value=!n.value}},N=async()=>{var a;if(g.value.trim())try{const o={reason:g.value,reportedProductId:"product"===f?h:void 0,reportedDemandId:"demand"===f?h:void 0,reportedUserId:null==(a=null==l?void 0:l.requester)?void 0:a.id},n=await t.userApi.submitReport(o);200===n.code?(e.index.showToast({title:n.data,icon:"success"}),p.value=!1):e.index.showToast({title:n.msg||"举报提交失败",icon:"none"})}catch(o){console.error("举报接口调用失败:",o),e.index.showToast({title:"网络错误，请重试",icon:"none"})}else e.index.showToast({title:"请输入举报原因",icon:"none"})};e.onReachBottom(()=>{r.value=!0,setTimeout(()=>{r.value=!1},5e3)});const U=e.computed(()=>{if(!l.value)return[];const e=[];return l.value.imgUrl&&e.push(l.value.imgUrl),l.value.detailImages&&Array.isArray(l.value.detailImages)&&l.value.detailImages.length&&e.push(...l.value.detailImages),0===e.length&&e.push("https://api.shaolezhuan.cn/lzphoto/productDefault.jpg"),e}),k=()=>{var a;let t="";"product"===f?t=l.value.sellerId||"":"demand"===f&&(t=(null==(a=l.value.requester)?void 0:a.id)||"");const o=h,n=f;t&&o?e.index.navigateTo({url:`/pages/chat/chat?sellerId=${t}&itemId=${o}&type=${n}`}):e.index.showToast({title:"无法获取聊天对象信息",icon:"none"})};return(a,t)=>{var o,i,s,m,h,w,A,x,T,b,I,z,P,D,j,C,$,S,_,B,F,L,O,R,J,G,H;return e.e({a:(null==(i=null==(o=l.value)?void 0:o.requester)?void 0:i.avatar)||(null==(s=l.value)?void 0:s.sellerAvatarUrl)||"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",b:e.t((null==(h=null==(m=l.value)?void 0:m.requester)?void 0:h.nickname)||(null==(w=l.value)?void 0:w.sellerNickname)||"未知用户"),c:e.t("demand"===e.unref(f)?(null==(x=null==(A=l.value)?void 0:A.requester)?void 0:x.credittag)||"买家信用优秀":(null==(b=null==(T=l.value)?void 0:T.user)?void 0:b.credittag)||"卖家信用优秀"),d:e.t("demand"===e.unref(f)?(null==(I=l.value)?void 0:I.budget)||"0.00":(null==(z=l.value)?void 0:z.price)||"0.00"),e:"product"===e.unref(f)&&(null==(P=l.value)?void 0:P.originalPrice)},"product"===e.unref(f)&&(null==(D=l.value)?void 0:D.originalPrice)?{f:e.t(null==(j=l.value)?void 0:j.originalPrice)}:{},{g:"product"===e.unref(f)&&(null==(C=l.value)?void 0:C.isNegotiable)},"product"===e.unref(f)&&(null==($=l.value)?void 0:$.isNegotiable)?{h:e.t((null==(S=l.value)?void 0:S.maxNegotiableAmount)||0)}:{},{i:e.t((null==(_=l.value)?void 0:_.title)||"商品标题"),j:e.t("demand"===e.unref(f)?"需求详情":"商品详情"),k:e.t((null==(B=l.value)?void 0:B.description)||(null==(F=l.value)?void 0:F.desc)||"暂无描述"),l:"demand"!==e.unref(f)&&U.value.length},"demand"!==e.unref(f)&&U.value.length?{m:e.f(U.value,(a,t,o)=>({a:t,b:a,c:e.o(a=>(a=>{0!==U.value.length&&e.index.previewImage({current:a,urls:U.value})})(t),t)}))}:{},{n:e.t("demand"===e.unref(f)?"发布者信息":"商家信息"),o:(null==(O=null==(L=l.value)?void 0:L.requester)?void 0:O.avatar)||(null==(R=l.value)?void 0:R.sellerAvatarUrl)||"https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg",p:e.t((null==(G=null==(J=l.value)?void 0:J.requester)?void 0:G.nickname)||(null==(H=l.value)?void 0:H.sellerNickname)||"未知用户"),q:e.t("demand"===e.unref(f)?`发布 ${c.value.length} 条需求`:`在售 ${v.value.length} 件商品`),r:e.o(e=>p.value=!0),s:e.o(e=>k()),t:p.value},p.value?{v:e.o(e=>p.value=!1),w:g.value,x:e.o(e=>g.value=e.detail.value),y:e.o(e=>p.value=!1),z:e.o(N)}:{},{A:e.t("demand"===e.unref(f)?"该发布者其他需求":"该商家其他商品"),B:Array.isArray(y())},Array.isArray(y())?e.e({C:e.f(y(),(a,t,o)=>({a:a.imgUrl||"https://api.shaolezhuan.cn/lzphoto/productDefault.jpg",b:e.t("demand"===e.unref(f)?a.budget:a.price),c:a.id,d:`/pages/productDetail/productDetail?id=${a.id}&type=${e.unref(f)}`,e:e.o(t=>{return o=a.id,void e.index.navigateTo({url:`/pages/ProductDetail/ProductDetail?id=${o}`});var o},a.id)})),D:0===y().length},0===y().length?{E:e.t("demand"===e.unref(f)?"该发布者暂无其他需求":"该商家暂无其他商品")}:{}):{},{F:e.p({list:"demand"===e.unref(f)?u.value:d.value,columnCount:2,gap:20}),G:r.value},(r.value,{}),{H:e.o(q),I:e.p({checked:n.value,circle:"true",bgColor:"#f5f5f5",bgColorChecked:"#ff4d4f",color:"#666",colorChecked:"#fff",size:"24"}),J:e.o(e=>k())})}}},n=e._export_sfc(l,[["__scopeId","data-v-15090eb9"]]);wx.createPage(n);
