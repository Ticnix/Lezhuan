"use strict";const e=require("../../common/vendor.js"),t=require("../../api/user.js");if(!Array){e.resolveComponent("uni-icons")()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+o)();const o=()=>"../../components/CommonGoodsList.js",a={__name:"history",setup(o){const a=e.ref(""),l=e.ref([]),n=e.ref(!1),u=e.ref(0),s=e.ref(1),i=e.ref(10),r=e.ref(!1),c=e.ref(!1),v=e.ref(!1),d=e.ref([{text:"全部",value:""},{text:"出物",value:"出物"},{text:"收物",value:"收物"}]),m=e.ref([{text:"全部",value:""}]),p=e.ref(0),h=e.ref(0);e.onMounted(()=>{f()}),e.onShow(()=>{f()});const f=()=>{s.value=1,l.value=[],v.value=!1,g()},g=async()=>{if(r.value||c.value)return;1===s.value?(r.value=!0,e.index.showLoading({title:"加载中...",mask:!0})):c.value=!0;const o=e.index.getStorageSync("userId");try{const a={userId:o,current:s.value,size:i.value};console.log("历史浏览请求参数：",a);const n=await t.userApi.getBrowseHistoryList(a);if(200===n.code){const e=n.data;console.log("后端返回的浏览记录数据：",e),u.value=e.total;const t=e.records.map(e=>({id:e.itemId.toString(),title:e.itemTitle||"未知标题",desc:"",imgUrl:e.itemImageUrl||"https://api.shaolezhuan.cn/lzphoto/productDefault.jpg",price:e.itemPrice||0,category:e.itemCategory||"未知分类",function:"product"===e.itemType?"出物":"收物",status:e.itemStatus||"normal",browseTime:new Date(e.browseTime).getTime(),publisher:{nickname:e.sellerNickname||"未知用户",avatar:""},isFavorited:e.isFavorited||!1}));1===s.value?l.value=t:l.value=[...l.value,...t],v.value=l.value.length>=u.value;const o=l.value.map(e=>e.category).filter(e=>e&&e.trim()),a=[...new Set(o)].sort((e,t)=>e.localeCompare(t,"zh-CN")).map(e=>({text:e,value:e}));m.value=[{text:"全部",value:""},...a]}else e.index.showToast({title:n.msg||"获取浏览记录失败",icon:"none"})}catch(a){console.error("加载浏览历史失败:",a),e.index.showToast({title:"网络错误，请重试",icon:"none"})}finally{r.value=!1,c.value=!1,e.index.hideLoading(),n.value=0===l.value.length}};e.onReachBottom(()=>{v.value||c.value||(s.value++,g())});const w=e.computed(()=>{const e=l.value.filter(e=>{const t=""===a.value||e.title.toLowerCase().includes(a.value.toLowerCase()),o=d.value[p.value].value,l=!o||e.function===o,n=m.value[h.value].value,u=!n||e.category===n;return t&&l&&u});return n.value=0===e.length&&l.value.length>0,e}),y=()=>{e.index.showModal({title:"确认清空",content:"确定要清空所有浏览记录吗？",success:async o=>{if(o.confirm)try{const o=await t.userApi.clearBrowseHistory();200===o.code?(l.value=[],n.value=!0,e.index.showToast({title:"已清空浏览记录",icon:"none"})):e.index.showToast({title:o.msg||"清空失败",icon:"none"})}catch(a){console.error("清空浏览记录失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}}})},x=e=>{p.value=e.detail.value,f()},T=e=>{h.value=e.detail.value},z=()=>{};return e.onUnmounted(()=>{}),(t,o)=>e.e({a:e.o(y),b:e.p({type:"search",size:"24",color:"#999"}),c:e.o([e=>a.value=e.detail.value,z]),d:a.value,e:e.t(d.value[p.value].text),f:e.p({type:"down",size:"18",color:"#999"}),g:d.value,h:p.value,i:e.o(x),j:e.t(m.value[h.value].text),k:e.p({type:"down",size:"18",color:"#999"}),l:m.value,m:h.value,n:e.o(T),o:e.p({goodsList:w.value,showPrice:!0,showStatus:!0,emptyText:n.value?"暂无浏览记录":""}),p:c.value},c.value?{q:e.p({type:"spinner-cycle",size:"24",color:"#666"})}:{},{r:v.value&&!n.value},(v.value&&n.value,{}))}},l=e._export_sfc(a,[["__scopeId","data-v-f245d684"]]);wx.createPage(l);
