"use strict";const e=require("../../common/vendor.js"),a=require("../../api/chat.js"),t=require("../../api/notice.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const n={__name:"message",setup(n){const o=e.index.getStorageSync("userId")||"",r=e.ref(""),s=e.ref([]),c=e.ref(!0),i=()=>{e.index.navigateTo({url:"/pages/notice/notice"})};e.onPullDownRefresh(()=>{Promise.all([g(),u()]).then(()=>{e.index.stopPullDownRefresh()}).catch(a=>{console.error("下拉刷新失败：",a),e.index.stopPullDownRefresh()})});const l=e.ref(0),u=async()=>{try{const e=await t.noticeApi.getUnreadCount();200===e.code&&e.data&&(l.value=e.data.totalUnreadCount||0)}catch(e){console.error("获取未读通知数量失败:",e)}};e.onShow(async()=>{getCurrentPages().length>1&&(await g(),await u()),c.value=!1,u()});const d=e.computed(()=>{if(!r.value)return s.value;const e=r.value.toLowerCase();return s.value.filter(a=>a.name.toLowerCase().includes(e)||a.lastMessage.toLowerCase().includes(e))}),v=()=>{},p=()=>{r.value=""};e.onMounted(async()=>{e.index.onNavigationBarButtonTap(e=>{"back"===e.type&&(g(),u())})});const g=async()=>{try{const t=await a.chatApi.getChatConversations();if(console.log("后端返回的消息列表为：",t),200===t.code){const e=t.data.map(e=>{const a=e.senderId===o?e.receiverNickname:e.senderNickname,t=e.senderId===o?e.receiverId:e.senderId;return{name:a,avatar:e.senderId===o?e.receiverAvatar:e.senderAvatar,lastMessage:(e.lastMessageContent||"").replace(/https?:\/\/\S+\.(png|jpg|jpeg|gif|webp)/gi,"[图片]"),time:e.lastMessageTime||"",unread:e.unreadCount||0,senderId:t}});s.value=e,await u()}else e.index.showToast({title:t.msg||"获取聊天列表失败",icon:"none"})}catch(t){e.index.showToast({title:"接口请求异常",icon:"none"}),console.error("获取聊天列表失败：",t)}};return(a,t)=>e.e({a:e.p({type:"search",size:"18",color:"#999"}),b:e.o([e=>r.value=e.detail.value,v]),c:r.value,d:r.value},r.value?{e:e.o(p),f:e.p({type:"clear",size:"16",color:"#999"})}:{},{g:e.p({type:"notification",size:"24",color:"#007aff"}),h:e.t(l.value),i:e.t((l.value,"未读通知")),j:l.value>0},l.value>0?{k:e.t(l.value)}:{},{l:e.p({type:"right",size:"20",color:"#999"}),m:e.o(i),n:e.f(d.value,(a,t,n)=>e.e({a:a.avatar,b:a.name,c:a.unread>0},a.unread>0?{d:e.t(a.unread>99?"99+":a.unread)}:{},{e:e.t(a.name),f:e.t(a.time),g:e.t(a.lastMessage),h:a.unread>0?1:"",i:t,j:e.o(t=>(a=>{e.index.navigateTo({url:`/pages/chat/chat?sellerId=${a.senderId}`})})(a),t)})),o:0===d.value.length},0===d.value.length?{p:e.p({type:"chat",size:"48",color:"#ccc"})}:{})}},o=e._export_sfc(n,[["__scopeId","data-v-566acfd2"]]);wx.createPage(o);
