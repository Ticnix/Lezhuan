"use strict";const e=require("../../common/vendor.js"),a=require("../../hooks/useStorage.js"),l=require("../../api/product.js"),o=require("../../utils/system.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const t={__name:"receive",setup(t){const{getStorage:u,setStorage:n}=a.useStorage(),i=e.ref(0),v=e.ref(!0),r=e.ref(3);let s=null;const c=e.ref([]),d=async()=>{if(c.value.length>=9)return void e.index.showToast({title:"最多只能上传9张图片",icon:"none"});const a=await e.index.chooseImage({count:9-c.value.length,sizeType:["original","compressed"],sourceType:["album","camera"]});c.value=[...c.value,...a.tempFilePaths]},p=[{id:1,name:"电子数码"},{id:2,name:"自行车"},{id:3,name:"电器"},{id:4,name:"体育用品"},{id:5,name:"二手书"},{id:6,name:"生活用品"},{id:7,name:"虚拟用品"},{id:8,name:"其他"}],m=e.ref(""),f=e.ref(null),g=e.ref(0),h=e.ref(""),y=e.ref(""),b=e.ref(""),x=e.ref(""),T=e.ref(""),w=e.computed(()=>/^1[3-9]\d{9}$/.test(b.value)),k=[{label:"线下自行交易",value:"线下自行交易"}],I=e.ref(null),j=async()=>{var a;try{await e.nextTick$1(),null==(a=I.value)||a.open("bottom")}catch(l){console.error("打开预算弹窗失败:",l),e.index.showToast({title:"打开预算弹窗失败",icon:"none"})}},z=()=>{var e;null==(e=I.value)||e.close(),x.value=""},S=()=>{var a;x.value?null==(a=I.value)||a.close():e.index.showToast({title:"请输入预算",icon:"none"})},_=e.ref(null),C=async()=>{var a;try{await e.nextTick$1(),null==(a=_.value)||a.open("bottom")}catch(l){console.error("打开交易方式弹窗失败:",l),e.index.showToast({title:"打开交易方式弹窗失败",icon:"none"})}},P=async()=>{if(!f.value)return void e.index.showToast({title:"请选择需求分类",icon:"none"});if(!h.value.trim())return void e.index.showToast({title:"请填写需求标题",icon:"none"});if(!y.value.trim())return void e.index.showToast({title:"请填写需求描述",icon:"none"});if(!b.value.trim())return void e.index.showToast({title:"请填写联系方式",icon:"none"});if(!x.value)return e.index.showToast({title:"请填写预算",icon:"none"}),void j();if(!T.value)return e.index.showToast({title:"请选择交易方式",icon:"none"}),void C();const a=u("userId"),o={title:h.value,description:y.value.trim(),budget:Number(x.value),requesterId:a,categoryName:m.value,categoryId:f.value,contactInfo:b.value.trim(),tradeMethod:T.value,images:c.value.join(",")};console.log("发布需求数据:",o);try{const a=await l.productApi.postDemand(o);console.log("发布结果:",a),200===a.code?(e.index.showToast({title:"发布成功",icon:"success"}),F(),e.index.removeStorageSync("demandDraft"),setTimeout(()=>{e.index.navigateTo({url:"/pages/wait/wait"})},500)):e.index.showToast({title:a.msg||"发布失败",icon:"none"})}catch(t){console.error("发布失败:",t),e.index.showToast({title:"网络异常，发布失败",icon:"none"})}},q=e.ref(null),B=e.ref({}),D=()=>{var a;null==(a=q.value)||a.close(),setTimeout(()=>{e.index.navigateBack({delta:1})},300)},M=()=>{var a;B.value={title:h.value,description:y.value,contactInfo:b.value,budget:x.value,tradeMethod:T.value,categoryId:f.value,selectedCategory:m.value,images:[...c.value],saveTime:(new Date).getTime()},n("demandDraft",B.value),console.log("需求草稿内容为：",B.value),e.index.showToast({title:"草稿保存成功",icon:"success"}),null==(a=q.value)||a.close(),setTimeout(()=>{e.index.navigateBack({delta:1})},1500)},A=()=>{var a;return h.value||y.value||b.value||x.value||T.value||c.value.length||f.value?(null==(a=q.value)||a.open("center"),!0):(e.index.navigateBack({delta:1}),!1)};e.onBackPress(e=>"backbutton"===e.from&&A());const F=()=>{var e,a,l;h.value="",y.value="",b.value="",x.value="",T.value="",m.value="",f.value=null,c.value=[],g.value=0,null==(e=I.value)||e.close(),null==(a=_.value)||a.close(),null==(l=q.value)||l.close()};return e.onMounted(()=>{i.value=o.getStatusBarHeight(),(()=>{try{const e=u("demandDraft");console.log("草稿内容为:",e),e&&"object"==typeof e&&(h.value=e.title||"",y.value=e.description||"",b.value=e.contactInfo||"",x.value=e.budget||"",T.value=e.tradeMethod||"",m.value=e.selectedCategory||"",f.value=e.categoryId||null,c.value=e.images&&Array.isArray(e.images)?e.images:[])}catch(e){console.error("加载草稿失败:",e)}})(),s=setInterval(()=>{r.value>0?r.value--:clearInterval(s)},1e3)}),e.onUnmounted(()=>{s&&clearInterval(s)}),(a,l)=>e.e({a:v.value},v.value?{b:e.t(r.value>0?`请等待 ${r.value} 秒`:"我知道了"),c:e.o(e=>v.value=!1),d:r.value>0}:{},{e:!v.value},v.value?{}:e.e({f:i.value+"px",g:e.p({type:"left",size:"24"}),h:e.o(A),i:e.p({type:"plus",size:"30",color:"#999"}),j:e.o(d),k:e.f(c.value,(a,l,o)=>({a:a,b:"ac72e0ba-2-"+o,c:e.o(e=>(e=>{c.value.splice(e,1)})(l),l),d:l})),l:e.p({type:"close",size:"18",color:"#fff"}),m:e.t(m.value||"需求分类"),n:1===g.value?1:"",o:e.p({type:"down",size:"18",color:"#999"}),p:e.o(e=>{return a=1,void(g.value=g.value===a?0:a);var a}),q:g.value},g.value?e.e({r:1===g.value},1===g.value?{s:e.f(p,(a,l,o)=>({a:e.t(a.name),b:a.id,c:e.o(e=>(e=>{m.value=e.name,f.value=e.id+1,g.value=0})(a),a.id)}))}:{}):{},{t:h.value,v:e.o(e=>h.value=e.detail.value),w:e.t(h.value.length),x:y.value,y:e.o(e=>y.value=e.detail.value),z:e.t(y.value.length),A:w.value?"number":"text",B:b.value,C:e.o(e=>b.value=e.detail.value),D:b.value},b.value?{E:e.t(w.value?"手机号格式":"微信号格式")}:{},{F:e.t(x.value?"¥"+x.value:"请填写"),G:e.p({type:"right",size:"18",color:"#999"}),H:e.o(j),I:e.t(T.value||"请选择"),J:e.p({type:"right",size:"18",color:"#999"}),K:e.o(C),L:e.o(P),M:x.value,N:e.o(e=>x.value=e.detail.value),O:e.o(z),P:e.o(S),Q:e.sr(I,"ac72e0ba-6",{k:"budgetPopup"}),R:e.p({type:"bottom","background-color":"#fff",mask:!0,"mask-click":!0}),S:e.f(k,(a,l,o)=>e.e({a:e.t(a.label),b:T.value===a.value},T.value===a.value?{c:"ac72e0ba-8-"+o+",ac72e0ba-7",d:e.p({type:"checkmark",size:"20",color:"#FFCC00"})}:{},{e:a.value,f:e.o(e=>{return l=a.value,T.value=l,void _.value.close();var l},a.value)})),T:e.sr(_,"ac72e0ba-7",{k:"tradePopup"}),U:e.p({type:"bottom","background-color":"#fff"}),V:e.o(D),W:e.o(M),X:e.sr(q,"ac72e0ba-9",{k:"draftPopup"}),Y:e.p({type:"center","background-color":"#fff",mask:!0,"mask-click":!1})}))}},u=e._export_sfc(t,[["__scopeId","data-v-ac72e0ba"]]);wx.createPage(u);
