"use strict";const e=require("../../common/vendor.js"),o=require("../../api/product.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-tag")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-tag/components/uni-tag/uni-tag.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const t={__name:"publish",setup(t){const s=e.ref(""),a=e.ref(!1),l=e.ref(null),i=e.ref(""),n=e.ref(null),u=e.ref(["全部种类"]),c=e.ref(["全部状态","待审核","已上架","已拒绝","已完成"]),r=e.ref(0),d=e.ref(0),v=e.ref([]);e.onMounted(()=>{m(),e.index.$on("pageShow",m)});const p=e=>({pending_review:"待审核",active:"已上架",rejected:"已拒绝",sold:"已完成"}[e]||e),m=async()=>{try{a.value=!0;const e={current:1,size:1e3,timestamp:Date.now()},t=(await o.productApi.getMyGoods(e)).data.records||[];console.log("后端返回的我发布的商品数据是：",t),v.value=t.filter(e=>"delisted"!==e.status).map(e=>({id:e.id,title:e.title,desc:e.description||"",imgUrl:e.mainImageUrl||"",price:e.price||0,category:e.categoryName||"",location:"",publishTime:e.createdAt?new Date(e.createdAt).getTime():Date.now(),status:p(e.status)||"待审核",isTop:e.urgentPush||!1,isOnHome:e.isHomepageFeatured||!1})),console.log("清洗完的数据：",v.value);const s=[...new Set(v.value.map(e=>e.category))];u.value=["全部种类",...s]}catch(t){console.error("获取商品列表失败:",t),e.index.showToast({title:"加载商品失败",icon:"none",duration:2e3})}finally{a.value=!1}},f=e.computed(()=>v.value.filter(e=>{const o=""===s.value||(e.title.toLowerCase().includes(s.value.toLowerCase())||e.desc&&e.desc.toLowerCase().includes(s.value.toLowerCase())),t=u.value[r.value],a="全部种类"===t||e.category===t,l=c.value[d.value],i="全部状态"===l||("待审核"===l&&"待审核"===e.status||"已上架"===l&&"已上架"===e.status||"已拒绝"===l&&"已拒绝"===e.status||"已售出"===l&&"已完成"===e.status);return o&&a&&i})),w=e=>{r.value=e.detail.value,m()},y=e=>{d.value=e.detail.value,m()},h=()=>{},g=e=>{const o=Date.now()-e;return o<36e5?`${Math.floor(o/6e4)}分钟前`:o<864e5?`${Math.floor(o/36e5)}小时前`:`${Math.floor(o/864e5)}天前`},x=()=>{e.index.showModal({title:"提示",content:"已售出的商品无法编辑",showCancel:!1,confirmText:"知道了"})},T=()=>{var e;null==(e=n.value)||e.close()},z=async()=>{var t;if(l.value)if(!i.value||isNaN(i.value)||parseFloat(i.value)>=l.value.price)e.index.showToast({title:"请输入有效的新价格",icon:"none",duration:2e3});else try{a.value=!0;const s=await o.productApi.updateGoodsPrice(l.value.id,{price:parseFloat(i.value)});if(console.log("降价状态：",i),200===s.code){e.index.showToast({title:"降价成功",icon:"success"});const o=v.value.findIndex(e=>e.id===l.value.id);-1!==o&&(v.value[o].price=parseFloat(i.value))}else e.index.showToast({title:`调整失败：${s.msg}`,icon:"none"});null==(t=n.value)||t.close()}catch(s){console.error("降价失败:",s),e.index.showToast({title:"降价失败",icon:"none"})}finally{a.value=!1}},C=async()=>{var t;if(l.value&&!l.value.isTop)try{a.value=!0;const s=!0,i=l.value.id,u=await o.productApi.setGoodsTop(i);if(console.log("置顶情况",u),200===u.code){e.index.showToast({title:"商品已申请置顶",icon:"success"}),m();const o=v.value.findIndex(e=>e.id===l.value.id);-1!==o&&(v.value[o].isTop=s)}else e.index.showToast({title:`置顶失败：${u.msg}`,icon:"none"});null==(t=n.value)||t.close()}catch(s){console.error("置顶操作失败:",s),e.index.showToast({title:"操作失败",icon:"none"})}finally{a.value=!1}},H=async()=>{var t;if(l.value&&!l.value.isOnHome)try{a.value=!0;const s=!0,i=l.value.id,u=await o.productApi.setGoodsToHome(i);if(console.log("商品推荐的结果：",u),200===u.code){e.index.showToast({title:"商品已申请上首页推荐",icon:"success"}),await m();const o=v.value.findIndex(e=>e.id===l.value.id);-1!==o&&(v.value[o].isOnHome=s)}else e.index.showToast({title:`推荐失败：${u.msg}`,icon:"none"});null==(t=n.value)||t.close()}catch(s){console.error("设置首页展示失败:",s),e.index.showToast({title:"操作失败",icon:"none"})}finally{a.value=!1}},j=async()=>{l.value&&"sold"!==l.value.status?e.index.showModal({title:"确认售出",content:"确定要将此商品标记为已售出吗？标记后将无法编辑",confirmText:"确认",cancelText:"取消",success:async t=>{var s;if(t.confirm)try{a.value=!0,await o.productApi.updateGoodsStatus(l.value.id,{status:"sold"}),await m();const t=v.value.findIndex(e=>e.id===l.value.id);-1!==t&&(v.value[t].status="sold"),e.index.showToast({title:"已标记为售出",icon:"success"}),null==(s=n.value)||s.close()}catch(i){console.error("标记售出失败:",i),e.index.showToast({title:"操作失败",icon:"none"})}finally{a.value=!1}}}):e.index.showToast({title:"该商品已售出",icon:"none"})},A=()=>{e.index.navigateTo({url:"/pages/post/post"})};return(t,$)=>{var _,D,F,M,I,O,b,k,G,L,q,P;return e.e({a:e.p({type:"plus",size:"24",color:"#fff"}),b:e.o(A),c:e.p({type:"search",size:"24",color:"#999"}),d:e.o([e=>s.value=e.detail.value,h]),e:s.value,f:e.t(u.value[r.value]),g:e.p({type:"down",size:"18",color:"#999"}),h:u.value,i:r.value,j:e.o(w),k:e.t(c.value[d.value]),l:e.p({type:"down",size:"18",color:"#999"}),m:c.value,n:d.value,o:e.o(y),p:e.p({type:"info",size:"24",color:"#7c89ff"}),q:a.value},a.value?{r:e.p({type:"loading",size:"40",color:"#7c89ff",spin:!0})}:f.value.length>0?{t:e.f(f.value,(t,s,u)=>{return e.e({a:t.imgUrl||"/static/productDefault.jpg",b:e.t(t.title),c:e.t(t.price.toFixed(2)),d:e.t(g(t.publishTime)),e:e.t(p(t.status)),f:e.n((c=t.status,{"待审核":"status-pending","已上架":"status-onsale","已拒绝":"status-rejected","已完成":"status-completed"}[c]||"status-default")),g:1===t.isTop},1===t.isTop?{h:"368759e4-6-"+u,i:e.p({size:"mini",text:"已置顶",type:"primary"})}:{},{j:t.isOnHome},t.isOnHome?{k:"368759e4-7-"+u,l:e.p({size:"mini",text:"首页展示",type:"success"})}:{},{m:e.o(o=>{return s=t.id,void e.index.navigateTo({url:`/pages/goodsDetail/goodsDetail?id=${s}`});var s},t.id),n:"已售出"!==t.status},"已售出"!==t.status?{o:"368759e4-8-"+u,p:e.p({type:"compose",size:"20",color:"#409EFF"}),q:e.o(o=>(async o=>{var t;try{l.value={...o},i.value=o.price.toString(),await e.nextTick$1(),await m(),null==(t=n.value)||t.open("bottom")}catch(s){console.error("打开编辑弹窗失败:",s),e.index.showToast({title:"打开弹窗失败",icon:"none"})}})(t),t.id)}:{},{r:"已售出"===t.status},"已售出"===t.status?{s:"368759e4-9-"+u,t:e.p({type:"compose",size:"20",color:"#ccc"}),v:e.o(x,t.id)}:{},{w:"368759e4-10-"+u,x:e.o(s=>(async t=>{e.index.showModal({title:"确认删除",content:"确定要删除该商品吗？删除后不可恢复",confirmText:"删除",cancelText:"取消",success:async s=>{if(s.confirm)try{a.value=!0;const s=await o.productApi.deleteGoods(t);console.log("删除商品ID",t),console.log("删除商品反馈",s),200===s.code?(e.index.showToast({title:"商品已删除",icon:"success"}),v.value=v.value.filter(e=>e.id!==t),await m()):e.index.showToast({title:`删除失败:${s.msg}`,icon:"none"})}catch(l){console.error("删除商品失败:",l),e.index.showToast({title:"删除失败",icon:"none"})}finally{a.value=!1}}})})(t.id),t.id),y:t.id});var c}),v:e.p({type:"trash",size:"20",color:"#F56C6C"})}:{w:e.p({type:"empty",size:"60",color:"#ccc"}),x:e.o(A)},{s:f.value.length>0,y:i.value,z:e.o(e=>i.value=e.detail.value),A:"sold"!==(null==(_=l.value)?void 0:_.status)&&!(null==(D=l.value)?void 0:D.isTop)},"sold"===(null==(F=l.value)?void 0:F.status)||(null==(M=l.value)?void 0:M.isTop)?{}:{B:e.o(C),C:null==(I=l.value)?void 0:I.isTop},{D:"sold"!==(null==(O=l.value)?void 0:O.status)&&!(null==(b=l.value)?void 0:b.isOnHome)},"sold"===(null==(k=l.value)?void 0:k.status)||(null==(G=l.value)?void 0:G.isOnHome)?{}:{E:e.o(H),F:null==(L=l.value)?void 0:L.isOnHome},{G:"sold"!==(null==(q=l.value)?void 0:q.status)},"sold"!==(null==(P=l.value)?void 0:P.status)?{H:e.o(j)}:{},{I:e.o(z),J:e.o(T),K:e.sr(n,"368759e4-12",{k:"editPopup"}),L:e.p({type:"bottom",mask:!0,"mask-click":!1})})}}},s=e._export_sfc(t,[["__scopeId","data-v-368759e4"]]);wx.createPage(s);
