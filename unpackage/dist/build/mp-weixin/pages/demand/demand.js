"use strict";const e=require("../../common/vendor.js"),o=require("../../api/product.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-tag")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-tag/components/uni-tag/uni-tag.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const t={__name:"demand",setup(t){const a=e.ref(""),l=e.ref(!1),s=e.ref(null),i=e.ref(""),n=e.ref(null),u=e.ref(["全部种类"]),c=e.ref(["全部状态","待审核","已上架","已拒绝","已完成"]),d=e.ref(0),r=e.ref(0),v=e.ref([]);e.onMounted(()=>{p(),e.index.$on("pageShow",p)});const p=async()=>{try{l.value=!0;const e={current:1,size:1e3},t=(await o.productApi.getMyDemands(e)).data.records||[];v.value=t.filter(e=>"delisted"!==e.status).map(e=>({id:e.id,title:e.title,desc:e.description||"",imgUrl:e.imageUrl||"https://api.shaolezhuan.cn/lzphoto/productDefault.jpg",budget:e.budget||0,publishTime:e.createdAt?new Date(e.createdAt).getTime():Date.now(),status:e.status||"pending_review",category:e.categoryName||"其他",isTop:e.urgentPush||!1,isOnHome:e.isHomepageFeatured||!1}));const a=[...new Set(v.value.map(e=>e.category))];u.value=["全部种类",...a]}catch(t){console.error("获取需求列表失败:",t),e.index.showToast({title:"加载需求失败",icon:"none"})}finally{l.value=!1}},m=e.computed(()=>v.value.filter(e=>{const o=""===a.value||(e.title.toLowerCase().includes(a.value.toLowerCase())||e.desc&&e.desc.toLowerCase().includes(a.value.toLowerCase())),t=u.value[d.value],l="全部种类"===t||e.category===t,s={"全部状态":"","待审核":"pending_review","已上架":"active","已拒绝":"rejected","已完成":"resolved"}[c.value[r.value]],i=!s||e.status===s;return o&&l&&i})),f=e=>{d.value=e.detail.value,p()},h=e=>{r.value=e.detail.value,p()},g=()=>{},w=e=>{const o=Date.now()-e;return o<36e5?`${Math.floor(o/6e4)}分钟前`:o<864e5?`${Math.floor(o/36e5)}小时前`:`${Math.floor(o/864e5)}天前`},y=()=>{e.index.showModal({title:"提示",content:"已完成的需求无法编辑",showCancel:!1,confirmText:"知道了"})},x=()=>{var e;null==(e=n.value)||e.close()},T=async()=>{var t;if(s.value)if(!i.value||isNaN(i.value)||parseFloat(i.value)<=0)e.index.showToast({title:"请输入有效的预算金额",icon:"none",duration:2e3});else try{l.value=!0;const a=await o.productApi.updateDemandBudget(s.value.id,{budget:parseFloat(i.value)});if(200===a.code){e.index.showToast({title:"预算调整成功",icon:"success"}),p();const o=v.value.findIndex(e=>e.id===s.value.id);-1!==o&&(v.value[o].budget=parseFloat(i.value))}else e.index.showToast({title:`调整失败：${a.msg}`,icon:"none"});null==(t=n.value)||t.close()}catch(a){console.error("调整预算失败:",a),e.index.showToast({title:"调整失败",icon:"none"})}finally{l.value=!1}},z=async()=>{var t;if(s.value&&!s.value.isTop)try{l.value=!0;const a=s.value.id,i=await o.productApi.setDemandTop(a);if(console.log("置顶情况",i),200===i.code){e.index.showToast({title:"需求已申请置顶",icon:"success"}),p();const o=v.value.findIndex(e=>e.id===s.value.id);-1!==o&&(v.value[o].isTop=!0)}else e.index.showToast({title:`置顶失败：${i.msg}`,icon:"none"});null==(t=n.value)||t.close()}catch(a){console.error("置顶操作失败:",a),e.index.showToast({title:"操作失败",icon:"none"})}finally{l.value=!1}},D=async()=>{var t;if(s.value&&!s.value.isOnHome)try{l.value=!0;const a=s.value.id,i=await o.productApi.setDemandTohome(a);if(200===i.code){e.index.showToast({title:"需求已申请上首页推荐",icon:"success"}),p();const o=v.value.findIndex(e=>e.id===s.value.id);-1!==o&&(v.value[o].isOnHome=!0)}else e.index.showToast({title:`推荐失败：${i.msg}`,icon:"none"});null==(t=n.value)||t.close()}catch(a){console.error("设置首页展示失败:",a),e.index.showToast({title:"操作失败",icon:"none"})}finally{l.value=!1}},_=async()=>{s.value&&"completed"!==s.value.status?e.index.showModal({title:"确认完成交易",content:"确定要将此需求标记为已完成吗？标记后将无法编辑",confirmText:"确认",cancelText:"取消",success:async t=>{var a;if(t.confirm)try{l.value=!0,await o.productApi.updateDemandStatus(s.value.id,{status:"resolved"});const t=v.value.findIndex(e=>e.id===s.value.id);-1!==t&&(v.value[t].status="completed"),e.index.showToast({title:"已标记为完成",icon:"success"}),null==(a=n.value)||a.close()}catch(i){console.error("标记完成失败:",i),e.index.showToast({title:"操作失败",icon:"none"})}finally{l.value=!1}}}):e.index.showToast({title:"该需求已完成交易",icon:"none"})},b=()=>{e.index.navigateTo({url:"/pages/receive/receive"})};return(t,j)=>{var A,C,H,M,$,F,O,k,I,L,q,S,N,P;return e.e({a:e.p({type:"plus",size:"24",color:"#fff"}),b:e.o(b),c:e.p({type:"search",size:"24",color:"#999"}),d:e.o([e=>a.value=e.detail.value,g]),e:a.value,f:e.t(u.value[d.value]),g:e.p({type:"down",size:"18",color:"#999"}),h:u.value,i:d.value,j:e.o(f),k:e.t(c.value[r.value]),l:e.p({type:"down",size:"18",color:"#999"}),m:c.value,n:r.value,o:e.o(h),p:e.p({type:"info",size:"24",color:"#7c89ff"}),q:l.value},l.value?{r:e.p({type:"loading",size:"40",color:"#7c89ff",spin:!0})}:m.value.length>0?{t:e.f(m.value,(t,a,u)=>{return e.e({a:t.imgUrl||"https://api.shaolezhuan.cn/lzphoto/demandpic.png",b:e.t(t.title),c:e.t(t.budget.toFixed(2)),d:e.t(w(t.publishTime)),e:"84285e6f-6-"+u,f:e.t(t.location),g:e.t((d=t.status,{pending_review:"待审核",active:"已上架",rejected:"已拒绝",resolved:"已完成"}[d]||d)),h:e.n((c=t.status,{pending_review:"status-pending",active:"status-onsale",rejected:"status-rejected",resolved:"status-completed"}[c]||"status-default")),i:1===t.isTop},1===t.isTop?{j:"84285e6f-7-"+u,k:e.p({size:"mini",text:"已置顶",type:"primary"})}:{},{l:t.isOnHome},t.isOnHome?{m:"84285e6f-8-"+u,n:e.p({size:"mini",text:"首页展示",type:"success"})}:{},{o:e.o(o=>{return a=t.id,void e.index.navigateTo({url:`/pages/demandDetail/demandDetail?id=${a}`});var a},t.id),p:"已完成"!==t.status},"已完成"!==t.status?{q:"84285e6f-9-"+u,r:e.p({type:"compose",size:"20",color:"#409EFF"}),s:e.o(o=>(async o=>{var t;try{s.value={...o},i.value=o.budget.toString(),await e.nextTick$1(),null==(t=n.value)||t.open("bottom")}catch(a){console.error("打开编辑弹窗失败:",a),e.index.showToast({title:"打开弹窗失败",icon:"none"})}})(t),t.id)}:{},{t:"已完成"===t.status},"已完成"===t.status?{v:"84285e6f-10-"+u,w:e.p({type:"compose",size:"20",color:"#ccc"}),x:e.o(y,t.id)}:{},{y:"84285e6f-11-"+u,z:e.o(a=>(async t=>{e.index.showModal({title:"确认删除",content:"确定要删除该需求吗？删除后不可恢复",confirmText:"删除",cancelText:"取消",success:async a=>{if(a.confirm)try{l.value=!0;const a=await o.productApi.deleteDemand(t);console.log("删除需求ID",t),console.log("删除需求反馈",a),200===a.code?(p(),v.value=v.value.filter(e=>e.id!==t),e.index.showToast({title:"需求已删除",icon:"success"})):e.index.showToast({title:`删除失败：${a.msg}`,icon:"none"})}catch(s){console.error("删除需求失败:",s),e.index.showToast({title:"删除失败",icon:"none"})}finally{l.value=!1}}})})(t.id),t.id),A:t.id});var c,d}),v:e.p({type:"map-pin",size:"18",color:"#999"}),w:e.p({type:"trash",size:"20",color:"#F56C6C"})}:{x:e.p({type:"empty",size:"60",color:"#ccc"}),y:e.o(b)},{s:m.value.length>0,z:i.value,A:e.o(e=>i.value=e.detail.value),B:"sold"!==(null==(A=s.value)?void 0:A.status)&&!(null==(C=s.value)?void 0:C.isTop)},"sold"===(null==(H=s.value)?void 0:H.status)||(null==(M=s.value)?void 0:M.isTop)?{}:{C:e.o(z),D:null==($=s.value)?void 0:$.isTop},{E:"sold"!==(null==(F=s.value)?void 0:F.status)&&!(null==(O=s.value)?void 0:O.isOnHome)},"sold"===(null==(k=s.value)?void 0:k.status)||(null==(I=s.value)?void 0:I.isOnHome)?{}:{F:e.o(D),G:null==(L=s.value)?void 0:L.isOnHome},{H:!(null==(q=s.value)?void 0:q.isDraft)&&"completed"!==(null==(S=s.value)?void 0:S.status)},(null==(N=s.value)?void 0:N.isDraft)||"completed"===(null==(P=s.value)?void 0:P.status)?{}:{I:e.o(_)},{J:e.o(T),K:e.o(x),L:e.sr(n,"84285e6f-13",{k:"editPopup"}),M:e.p({type:"bottom",mask:!0,"mask-click":!1})})}}},a=e._export_sfc(t,[["__scopeId","data-v-84285e6f"]]);wx.createPage(a);
