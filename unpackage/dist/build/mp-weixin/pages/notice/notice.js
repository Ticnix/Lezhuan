"use strict";const e=require("../../common/vendor.js"),a=require("../../api/notice.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"notice",setup(t){const l=e.ref([]),i=e.ref(!1),n=e.ref(!0),o=e.ref(1),u=e.ref(10),r=e.ref(!1),s=["全部类型","系统通知","交易提醒","消息互动"],v=["全部状态","未读","已读"],c=e.ref(0),d=e.ref(0),f=e.ref(null),p=e.ref({type:"",isRead:null}),h=e.ref({}),y=e.ref({});e.onLoad(()=>{g(!0)});const g=async(t=!1)=>{if(!i.value||t){i.value=!0;try{t&&(o.value=1,n.value=!0,h.value={});const e={page:o.value,size:u.value,...p.value.type&&{type:p.value.type},...null!==p.value.isRead&&{isRead:p.value.isRead}},i=await a.noticeApi.getNotificationList(e);if(200===i.code&&i.data){const e=(i.data.notifications||[]).map(e=>({id:e.id,type:e.notificationType,content:e.content,createTime:e.createTime,isRead:e.isRead||!1}));l.value=t?e:[...l.value,...e],n.value=l.value.length<i.data.total,o.value=i.data.current+1}}catch(r){console.error("获取通知失败:",r),e.index.showToast({title:"网络错误，请重试",icon:"none"})}finally{i.value=!1,t&&e.index.stopPullDownRefresh()}}},m=e=>Math.abs(h.value[e]||0)>=30,R=()=>g(!0),w=()=>{n.value&&!i.value&&g()},$=e=>{c.value=e.detail.value},x=e=>{d.value=e.detail.value},M=()=>{c.value=0,d.value=0,p.value={type:"",isRead:null}},T=()=>{p.value={type:0===c.value?"":1===c.value?"system":2===c.value?"trade":"message",isRead:0===d.value?null:1!==d.value},g(!0),r.value=!1},S=(e,a="short")=>{if(!e)return"";const t=new Date(e),l=t.getFullYear(),i=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0"),o=t.getHours().toString().padStart(2,"0"),u=t.getMinutes().toString().padStart(2,"0");if("full"===a)return`${l}-${i}-${n} ${o}:${u}`;const r=new Date-t,s=Math.floor(r/6e4);if(s<60)return`${s}分钟前`;const v=Math.floor(s/60);if(v<24)return`${v}小时前`;const c=Math.floor(v/24);return c<30?`${c}天前`:`${l}-${i}-${n}`},_=e=>{switch(e){case"system":return"系统通知";case"trade":return"交易提醒";case"message":return"消息互动";default:return"通知"}};return(t,o)=>e.e({a:e.p({type:"filter",size:"24"}),b:e.o(e=>r.value=!r.value),c:r.value},r.value?{d:e.t(s[c.value]),e:e.o($),f:c.value,g:s,h:e.t(v[d.value]),i:e.o(x),j:d.value,k:v,l:e.o(M),m:e.o(T)}:{},{n:e.f(l.value,(t,i,n)=>{return e.e({a:!t.isRead},(t.isRead,{}),{b:e.t(_(t.type)),c:e.t(S(t.createTime)),d:e.t(t.content),e:f.value===t.id},f.value===t.id?{f:e.t(t.id),g:e.t(t.content)}:{},{h:e.o(l=>(async t=>{if(!t.isRead)try{await a.noticeApi.markAsRead(t.id),t.isRead=!0,e.index.showToast({title:"已标记为已读",icon:"none"})}catch(l){e.index.showToast({title:"标记失败",icon:"none"})}f.value=f.value===t.id?null:t.id})(t),t.id),i:`translateX(${o=t.id,h.value[o]||0}px)`,j:e.o(e=>((e,a)=>{y.value[a]=e.touches[0].clientX,Object.keys(h.value).forEach(e=>{e!==a&&(h.value[e]=0)})})(e,t.id),t.id),k:e.o(e=>((e,a)=>{const t=y.value[a]-e.touches[0].clientX;h.value[a]=Math.max(-80,Math.min(0,-t))})(e,t.id),t.id),l:e.o(e=>(e=>{Math.abs(h.value[e])<30?h.value[e]=0:h.value[e]=-80})(t.id),t.id),m:m(t.id)},m(t.id)?{n:e.o(i=>(async t=>{try{await a.noticeApi.deleteNotification(t),l.value=l.value.filter(e=>e.id!==t),delete h.value[t],e.index.showToast({title:"删除成功",icon:"success"})}catch(i){console.error("删除通知失败:",i),e.index.showToast({title:"删除失败，请重试",icon:"none"})}})(t.id),t.id)}:{},{o:t.id,p:t.isRead?"":1});var o}),o:0===l.value.length&&!i.value},0!==l.value.length||i.value?{}:{p:e.p({type:"notification",size:"60",color:"#ccc"})},{q:i.value},i.value?{r:e.p({type:"loading",size:"24",color:"#777",spin:!0})}:{},{s:!n.value&&l.value.length>0},(!n.value&&l.value.length,{}),{t:e.o(w),v:e.o(R)})}},l=e._export_sfc(t,[["__scopeId","data-v-cfa7382e"]]);wx.createPage(l);
