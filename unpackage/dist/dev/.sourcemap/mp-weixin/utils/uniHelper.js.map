{"version":3,"file":"uniHelper.js","sources":["utils/uniHelper.js"],"sourcesContent":["/**\n * 通用工具函数\n * 封装UniApp常用API，简化调用\n */\n\n/**\n * 显示提示框\n * @param {string} title - 提示内容\n * @param {string} icon - 图标类型，默认none\n * @param {number} duration - 显示时长，默认2000ms\n */\nexport const showToast = (title, icon = 'none', duration = 2000) => {\n  uni.showToast({\n    title,\n    icon,\n    duration\n  });\n};\n\n/**\n * 显示加载框\n * @param {string} title - 加载提示内容\n */\nexport const showLoading = (title = '加载中...') => {\n  uni.showLoading({\n    title,\n    mask: true\n  });\n};\n\n/**\n * 隐藏加载框\n */\nexport const hideLoading = () => {\n  uni.hideLoading();\n};\n\n/**\n * 导航跳转\n * @param {string} url - 目标页面路径\n * @param {boolean} isTab - 是否是tabBar页面\n */\nexport const navigateTo = (url, isTab = false) => {\n  if (isTab) {\n    uni.switchTab({ url });\n  } else {\n    uni.navigateTo({ url });\n  }\n};\n\n/**\n * 存储本地数据\n * @param {string} key - 存储键名\n * @param {any} value - 存储值\n */\nexport const setStorage = (key, value) => {\n  uni.setStorageSync(key, value);\n};\n\n/**\n * 获取本地数据\n * @param {string} key - 存储键名\n * @returns {any} 存储的值\n */\nexport const getStorage = (key) => {\n  return uni.getStorageSync(key);\n};\n\n/**\n * 删除本地数据\n * @param {string} key - 存储键名\n */\nexport const removeStorage = (key) => {\n  uni.removeStorageSync(key);\n};\n\n// 图片域名白名单与清洗\nexport const ALLOWED_IMAGE_HOSTS = [\n  'api.shaolezhuan.cn',\n  'tcb-api.tencentcloudapi.com',\n  'thirdwx.qlogo.cn',\n  'wx.qlogo.cn',\n  // 兼容对象存储/CDN等返回的主图域名\n  'myqcloud.com',\n  'shaolezhuan.cn'\n];\n\nexport const sanitizeImageUrl = (url, type = 'product') => {\n  const defaults = {\n    product: 'https://api.shaolezhuan.cn/lzphoto/productDefault.jpg',\n    demand: 'https://api.shaolezhuan.cn/lzphoto/demandpic.png',\n    avatar: 'https://api.shaolezhuan.cn/lzphoto/avatars/avatar1.jpeg'\n  };\n  if (!url) return defaults[type] || defaults.product;\n  const isLocal = typeof url === 'string' && (url.startsWith('/') || url.startsWith('wxfile://') || url.startsWith('data:image'));\n  if (isLocal) return url;\n  const match = String(url).match(/^https?:\\/\\/([^\\/]+)/i);\n  const host = match ? match[1] : '';\n  const allowed = ALLOWED_IMAGE_HOSTS.some(h => host.endsWith(h));\n  return allowed ? url : (defaults[type] || defaults.product);\n};\n\n/**\n * 校验是否已登录，未登录则弹窗提醒并可跳转到“我的”页\n * 使用：if (!ensureLoggedIn({ content: '登录后才能使用该功能' })) return;\n * @param {Object} options - 可选配置\n * @param {string} options.title - 弹窗标题，默认“未登录”\n * @param {string} options.content - 弹窗内容说明\n * @param {string} options.confirmText - 确认按钮文字，默认“去登录”\n * @param {string} options.cancelText - 取消按钮文字，默认“取消”\n * @param {string} options.redirectTo - 登录页（或“我的”页）路径，默认`/pages/mine/mine`\n * @returns {boolean} 是否已登录\n */\nexport const ensureLoggedIn = (options = {}) => {\n  const token = uni.getStorageSync('token');\n  const userId = uni.getStorageSync('userId');\n  const isLoggedIn = !!(token && userId);\n  if (isLoggedIn) return true;\n\n  const {\n    title = '未登录',\n    content = '您还未登录，请先登录以使用此功能',\n    confirmText = '去登录',\n    cancelText = '取消',\n    redirectTo = '/pages/mine/mine',\n  } = options;\n\n  uni.showModal({\n    title,\n    content,\n    confirmText,\n    cancelText,\n    success: (res) => {\n      if (res.confirm) {\n        // “我的”是 tabBar 页面，需使用 switchTab\n        uni.switchTab({ url: redirectTo });\n      }\n    }\n  });\n\n  return false;\n};\n\n/**\n * 校验是否已完成学生认证，未认证则弹窗引导至学生认证页面\n * 使用：if (!ensureStudentCertified({ content: '请先完成学生认证' })) return;\n * 依据：本项目以本地存储键 `studentIdNumber` 是否存在来判断认证完成\n * @param {Object} options - 可选配置\n * @param {string} options.title - 弹窗标题，默认“未完成学生认证”\n * @param {string} options.content - 弹窗内容说明\n * @param {string} options.confirmText - 确认按钮文字，默认“去认证”\n * @param {string} options.cancelText - 取消按钮文字，默认“取消”\n * @param {string} options.redirectTo - 学生认证页路径，默认`/pages/student/student`\n * @returns {boolean} 是否已认证\n */\nexport const ensureStudentCertified = (options = {}) => {\n  const studentIdNumber = uni.getStorageSync('studentIdNumber');\n  const isCertified = !!studentIdNumber;\n  if (isCertified) return true;\n\n  const {\n    title = '未完成学生认证',\n    content = '请先完成学生认证以使用此功能',\n    confirmText = '去认证',\n    cancelText = '取消',\n    redirectTo = '/pages/student/student',\n  } = options;\n\n  uni.showModal({\n    title,\n    content,\n    confirmText,\n    cancelText,\n    success: (res) => {\n      if (res.confirm) {\n        // 学生认证页非 tabBar 页面，使用 navigateTo\n        uni.navigateTo({ url: redirectTo });\n      }\n    }\n  });\n\n  return false;\n};\n\n/**\n * 校验会员等级是否满足要求，不满足则弹窗引导至会员购买/升级页面\n * 使用：if (!ensureMembership('platinum', { content: '发布需求需白金会员' })) return;\n * 依据：本项目 `membershipType` 存储值：'none' | 'normal' | 'platinum'\n * @param {'normal'|'platinum'} requiredType - 所需会员等级\n * @param {Object} options - 文案与跳转配置\n * @returns {boolean} 是否已满足会员等级\n */\nexport const ensureMembership = (requiredType = 'normal', options = {}) => {\n  const current = uni.getStorageSync('membershipType') || 'none';\n  const ok = requiredType === 'normal'\n    ? (current === 'normal' || current === 'platinum')\n    : (current === 'platinum');\n  if (ok) return true;\n\n  const defaultTextMap = {\n    normal: {\n      title: '非会员限制',\n      content: '该功能需普通会员。开通后可聊一聊、购物、发布商品',\n      confirmText: '去购买',\n    },\n    platinum: {\n      title: '会员等级不足',\n      content: '该功能需白金会员。升级后可发布需求等全部功能',\n      confirmText: '去升级',\n    }\n  };\n  const d = defaultTextMap[requiredType] || defaultTextMap.normal;\n\n  const {\n    title = d.title,\n    content = d.content,\n    confirmText = d.confirmText,\n    cancelText = '取消',\n    redirectTo = '/pages/membership/membership',\n  } = options;\n\n  uni.showModal({\n    title,\n    content,\n    confirmText,\n    cancelText,\n    success: (res) => {\n      if (res.confirm) {\n        // 会员页非 tabBar 页面，使用 navigateTo\n        uni.navigateTo({ url: redirectTo });\n      }\n    }\n  });\n\n  return false;\n};\n"],"names":["uni"],"mappings":"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"}