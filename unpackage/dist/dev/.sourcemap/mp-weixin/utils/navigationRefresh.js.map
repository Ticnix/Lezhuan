{"version":3,"file":"navigationRefresh.js","sources":["utils/navigationRefresh.js"],"sourcesContent":["// 全局导航拦截：为所有非 tabBar 跳转附加时间戳参数，确保页面重新触发加载\n// 对于 switchTab，无法传参，使用 Storage 记录一次“应刷新”标记，由目标页在 onShow 自行刷新\n\n// 附加查询参数（简易实现，兼容各端）\nconst appendParam = (url, key, value) => {\n  try {\n    const hasQuery = url.includes('?');\n    const sep = hasQuery ? '&' : '?';\n    return `${url}${sep}${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n  } catch (e) {\n    // 兜底：不抛出错误，返回原 url\n    console.error('appendParam 处理失败:', e);\n    return url;\n  }\n};\n\n// 记录一次 switchTab 刷新标记（目标页在 onShow 消费）\nconst markSwitchTabRefresh = (urlPath) => {\n  try {\n    const ts = Date.now();\n    uni.setStorageSync('__refresh_switchTab_path', urlPath);\n    uni.setStorageSync('__refresh_switchTab_ts', ts);\n  } catch (e) {\n    console.warn('设置 switchTab 刷新标记失败:', e);\n  }\n};\n\nexport const installNavigationRefreshInterceptors = () => {\n  // navigateTo / redirectTo / reLaunch：统一附加时间戳参数\n  const handler = {\n    invoke(args) {\n      if (args && args.url) {\n        args.url = appendParam(args.url, '__ts', Date.now());\n      }\n      return args;\n    }\n  };\n\n  try {\n    uni.addInterceptor('navigateTo', handler);\n    uni.addInterceptor('redirectTo', handler);\n    uni.addInterceptor('reLaunch', handler);\n  } catch (e) {\n    console.warn('注册非 tabBar 导航拦截器失败:', e);\n  }\n\n  // switchTab：无法传参，使用 Storage 记录刷新意图\n  try {\n    uni.addInterceptor('switchTab', {\n      invoke(args) {\n        if (args && args.url) {\n          const path = args.url.split('?')[0];\n          markSwitchTabRefresh(path);\n        }\n        return args;\n      }\n    });\n  } catch (e) {\n    console.warn('注册 switchTab 导航拦截器失败:', e);\n  }\n};\n\n// 供页面在 onShow 使用：如果是最近一次被 switchTab 唤起的页面，则返回 true\nexport const shouldRefreshOnShow = (currentPagePath) => {\n  try {\n    const lastPath = uni.getStorageSync('__refresh_switchTab_path');\n    const lastTs = uni.getStorageSync('__refresh_switchTab_ts');\n    if (!lastPath || !lastTs) return false;\n    // 命中路径且时间戳仍存在则消费一次并返回 true\n    if (currentPagePath && currentPagePath.split('?')[0] === lastPath) {\n      uni.removeStorageSync('__refresh_switchTab_path');\n      uni.removeStorageSync('__refresh_switchTab_ts');\n      return true;\n    }\n    return false;\n  } catch (e) {\n    return false;\n  }\n};"],"names":["uni"],"mappings":";;AAIA,MAAM,cAAc,CAAC,KAAK,KAAK,UAAU;AACvC,MAAI;AACF,UAAM,WAAW,IAAI,SAAS,GAAG;AACjC,UAAM,MAAM,WAAW,MAAM;AAC7B,WAAO,GAAG,GAAG,GAAG,GAAG,GAAG,mBAAmB,GAAG,CAAC,IAAI,mBAAmB,KAAK,CAAC;AAAA,EAC3E,SAAQ,GAAG;AAEVA,kBAAc,MAAA,MAAA,SAAA,oCAAA,qBAAqB,CAAC;AACpC,WAAO;AAAA,EACR;AACH;AAGA,MAAM,uBAAuB,CAAC,YAAY;AACxC,MAAI;AACF,UAAM,KAAK,KAAK;AAChBA,kBAAAA,MAAI,eAAe,4BAA4B,OAAO;AACtDA,kBAAAA,MAAI,eAAe,0BAA0B,EAAE;AAAA,EAChD,SAAQ,GAAG;AACVA,kBAAA,MAAA,MAAA,QAAA,oCAAa,wBAAwB,CAAC;AAAA,EACvC;AACH;AAEY,MAAC,uCAAuC,MAAM;AAExD,QAAM,UAAU;AAAA,IACd,OAAO,MAAM;AACX,UAAI,QAAQ,KAAK,KAAK;AACpB,aAAK,MAAM,YAAY,KAAK,KAAK,QAAQ,KAAK,IAAG,CAAE;AAAA,MACpD;AACD,aAAO;AAAA,IACR;AAAA,EACL;AAEE,MAAI;AACFA,kBAAAA,MAAI,eAAe,cAAc,OAAO;AACxCA,kBAAAA,MAAI,eAAe,cAAc,OAAO;AACxCA,kBAAAA,MAAI,eAAe,YAAY,OAAO;AAAA,EACvC,SAAQ,GAAG;AACVA,kBAAA,MAAA,MAAA,QAAA,oCAAa,uBAAuB,CAAC;AAAA,EACtC;AAGD,MAAI;AACFA,kBAAG,MAAC,eAAe,aAAa;AAAA,MAC9B,OAAO,MAAM;AACX,YAAI,QAAQ,KAAK,KAAK;AACpB,gBAAM,OAAO,KAAK,IAAI,MAAM,GAAG,EAAE,CAAC;AAClC,+BAAqB,IAAI;AAAA,QAC1B;AACD,eAAO;AAAA,MACR;AAAA,IACP,CAAK;AAAA,EACF,SAAQ,GAAG;AACVA,kBAAA,MAAA,MAAA,QAAA,oCAAa,yBAAyB,CAAC;AAAA,EACxC;AACH;;"}