{"version":3,"file":"history.js","sources":["pages/history/history.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvaGlzdG9yeS9oaXN0b3J5LnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"history-browse-page\">\n    <!-- 顶部导航栏 -->\n    <view class=\"navbar\">\n      <text class=\"nav-title\">历史浏览</text>\n      <button class=\"clear-btn\" @click=\"clearHistory\">\n        清空\n      </button>\n    </view>\n    \n    <!-- 搜索和筛选区域 -->\n    <view class=\"filter-container\">\n      <view class=\"search-box\">\n        <uni-icons type=\"search\" size=\"24\" color=\"#999\" class=\"search-icon\"></uni-icons>\n        <input \n          type=\"text\" \n          placeholder=\"搜索浏览记录...\" \n          v-model=\"searchKeyword\"\n          @input=\"handleSearch\"\n          class=\"search-input\"\n        />\n      </view>\n      \n      <view class=\"picker-container\">\n        <!-- 功能筛选（对象数组 + range-key） -->\n        <view class=\"picker-item\">\n          <text class=\"picker-label\">功能:</text>\n          <picker \n            mode=\"selector\"\n            :range=\"functionRange\"\n            :range-key=\"'text'\"\n            :value=\"functionIndex\"\n            @change=\"handleFunctionChange\"\n            class=\"custom-picker\"\n          >\n            <view class=\"picker-display\">\n              {{ functionRange[functionIndex].text }}\n              <uni-icons type=\"down\" size=\"18\" color=\"#999\" class=\"picker-icon\"></uni-icons>\n            </view>\n          </picker>\n        </view>\n        \n        <!-- 分类筛选（对象数组 + range-key） -->\n        <view class=\"picker-item\">\n          <text class=\"picker-label\">分类:</text>\n          <picker \n            mode=\"selector\"\n            :range=\"categoryRange\"\n            :range-key=\"'text'\"\n            :value=\"categoryIndex\"\n            @change=\"handleCategoryChange\"\n            class=\"custom-picker\"\n          >\n            <view class=\"picker-display\">\n              {{ categoryRange[categoryIndex].text }}\n              <uni-icons type=\"down\" size=\"18\" color=\"#999\" class=\"picker-icon\"></uni-icons>\n            </view>\n          </picker>\n        </view>\n      </view>\n    </view>\n    \n    <!-- 商品列表组件 -->\n    <CommonGoodsList \n      :goodsList=\"filteredHistoryGoods\" \n      :showPrice=\"true\"\n      :showStatus=\"true\"\n      :emptyText=\"isEmpty ? '暂无浏览记录' : ''\"\n    />\n    \n    <!-- 加载更多提示 -->\n    <view v-if=\"loadingMore\" class=\"loading-more\">\n\t  <uni-icons type=\"spinner-cycle\" size=\"24\" color=\"#666\"></uni-icons>\n      <text class=\"loading-text\">加载中...</text>\n    </view>\n    <view v-if=\"noMore && !isEmpty\" class=\"no-more\">\n      已加载全部\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted, computed, onUnmounted, onUpdated } from 'vue';\nimport { onReachBottom, onShow } from '@dcloudio/uni-app';\nimport CommonGoodsList from '@/components/CommonGoodsList.vue';\nimport userApi from '@/api/user.js'; // 引入用户相关接口\nimport { ensureLoggedIn } from '@/utils/uniHelper';\n\n// 基础状态\nconst searchKeyword = ref('');\nconst historyGoods = ref([]); // 所有加载的历史记录（累加）\nconst isEmpty = ref(false);\nconst total = ref(0); // 总记录数\nconst currentPage = ref(1); // 当前页码\nconst pageSize = ref(200); // 每页条数\nconst loading = ref(false); // 初始加载状态\nconst loadingMore = ref(false); // 加载更多状态\nconst noMore = ref(false); // 是否没有更多数据\n\n// 筛选器配置（对象数组，包含text和value）\nconst functionRange = ref([\n  { text: '全部', value: '' },\n  { text: '宝贝', value: '宝贝' },\n  { text: '需求', value: '需求' }\n]);\nconst categoryRange = ref([{ text: '全部', value: '' }]); // 初始值，后续动态填充\n\n// 筛选器选中索引\nconst functionIndex = ref(0);\nconst categoryIndex = ref(0);\n\n// 页面初始化加载第一页数据\nonMounted(() => {\n  if (!ensureLoggedIn({ content: '登录后才能查看历史浏览', redirectTo: '/pages/mine/mine' })) return;\n  resetAndLoad();\n});\n\n// 页面显示时刷新数据（重置为第一页）\nonShow(() => {\n  if (!ensureLoggedIn({ content: '登录后才能查看历史浏览', redirectTo: '/pages/mine/mine' })) return;\n  resetAndLoad();\n});\n\n// 重置分页并加载第一页数据（筛选条件变化时调用）\nconst resetAndLoad = () => {\n  currentPage.value = 1;\n  historyGoods.value = [];\n  noMore.value = false;\n  loadHistoryData();\n};\n\n// 加载浏览历史数据（对接后端分页接口）\nconst loadHistoryData = async () => {\n  // 避免重复请求\n  if (loading.value || loadingMore.value) return;\n\n  // 初始加载/加载更多状态切换\n  if (currentPage.value === 1) {\n    loading.value = true;\n    uni.showLoading({ title: '加载中...', mask: true });\n  } else {\n    loadingMore.value = true;\n  }\n  \n  const userId = uni.getStorageSync('userId')\n\n  try {\n    // 构造请求参数（根据筛选条件）\n    const params = {\n\t  userId: userId,\n      current: currentPage.value,\n      size: pageSize.value,\n    };\n\t\n\tconsole.log('历史浏览请求参数：', params)\n\n    // 调用后端分页接口\n    const res = await userApi.getBrowseHistoryList(params);\n    if (res.code === 200) {\n      const pageData = res.data;\n\t  console.log('后端返回的浏览记录数据：', pageData)\n      total.value = pageData.total; // 总记录数\n\n      // 格式化后端返回的数据（适配前端组件字段）\n      const formattedData = pageData.records.map(record => ({\n        id: record.itemId.toString(),\n        title: record.itemTitle || '未知标题',\n        desc: '', // 后端未返回描述，可留空或补充\n        imgUrl: record.itemImageUrl || 'https://api.shaolezhuan.cn/lzphoto/demandpic.png',\n        price: record.itemPrice || 0,\n        category: record.itemCategory || '未知分类', // 需后端补充分类字段\n        function: record.itemType === 'product' ? '宝贝' : '需求',\n        type: record.itemType === 'demand' ? 'demand' : 'product',\n        status: record.itemStatus || 'normal',\n        browseTime: new Date(record.browseTime).getTime(), // 转换为时间戳\n        publisher: {\n          nickname: record.sellerNickname || '未知用户',\n          avatar: '' // 后端未返回头像，可留空\n        },\n        isFavorited: record.isFavorited || false // 是否收藏\n      }));\n\n      // 累加数据（第一页直接覆盖，后续页追加）\n      if (currentPage.value === 1) {\n        historyGoods.value = formattedData;\n      } else {\n        historyGoods.value = [...historyGoods.value, ...formattedData];\n      }\n\n      // 判断是否还有更多数据\n      noMore.value = historyGoods.value.length >= total.value;\n\n      // 生成分类下拉框（去重+排序，过滤无效值）\n      const validCategories = historyGoods.value.map(item => item.category).filter(cate => cate && cate.trim());\n      const uniqueCategories = [...new Set(validCategories)]\n        .sort((a, b) => a.localeCompare(b, 'zh-CN'))\n        .map(cate => ({ text: cate, value: cate }));\n      categoryRange.value = [{ text: '全部', value: '' }, ...uniqueCategories];\n    } else {\n      uni.showToast({ title: res.msg || '获取浏览记录失败', icon: 'none' });\n    }\n  } catch (error) {\n    console.error('加载浏览历史失败:', error);\n    uni.showToast({ title: '网络错误，请重试', icon: 'none' });\n  } finally {\n    // 关闭加载状态\n    loading.value = false;\n    loadingMore.value = false;\n    uni.hideLoading();\n    isEmpty.value = historyGoods.value.length === 0;\n  }\n};\n\n// 下拉加载更多（页面滚动到底部时触发）\nonReachBottom(() => {\n  if (!noMore.value && !loadingMore.value) {\n    currentPage.value++; // 页码+1\n    loadHistoryData(); // 加载下一页\n  }\n});\n\n// 综合筛选逻辑（基于本地已加载数据筛选）\nconst filteredHistoryGoods = computed(() => {\n  const filtered = historyGoods.value.filter(goods => {\n    // 搜索筛选\n    const matchesSearch = searchKeyword.value === '' \n      ? true \n      : goods.title.toLowerCase().includes(searchKeyword.value.toLowerCase());\n    \n    // 功能筛选（基于value匹配）\n    const selectedFunction = functionRange.value[functionIndex.value].value;\n    const matchesFunction = !selectedFunction \n      ? true \n      : goods.function === selectedFunction;\n    \n    // 分类筛选（基于value匹配）\n    const selectedCategory = categoryRange.value[categoryIndex.value].value;\n    const matchesCategory = !selectedCategory \n      ? true \n      : goods.category === selectedCategory;\n\n    // 状态过滤：不显示已卖出(sold/已卖出)或已下架/删除(delisted/已删除)\n    const status = (goods.status || '').toString();\n    const statusLower = status.toLowerCase();\n    const hiddenZh = status === '已卖出' || status === '已删除';\n    const hiddenEn = statusLower === 'sold' || statusLower === 'delisted';\n    const visibleStatus = !(hiddenZh || hiddenEn);\n\n    return matchesSearch && matchesFunction && matchesCategory && visibleStatus;\n  });\n  \n  // 更新空状态（筛选后无数据时显示）\n  isEmpty.value = filtered.length === 0 && historyGoods.value.length > 0;\n  return filtered;\n});\n\n// 清空历史记录（需对接后端清空接口，这里仅做前端示例）\nconst clearHistory = () => {\n  uni.showModal({\n    title: '确认清空',\n    content: '确定要清空所有浏览记录吗？',\n    success: async (res) => {\n      if (res.confirm) {\n        try {\n          // 调用后端清空接口（假设存在）\n          const res = await userApi.clearBrowseHistory();\n          if (res.code === 200) {\n            historyGoods.value = [];\n            isEmpty.value = true;\n            uni.showToast({ title: '已清空浏览记录', icon: 'none' });\n          } else {\n            uni.showToast({ title: res.msg || '清空失败', icon: 'none' });\n          }\n        } catch (error) {\n          console.error('清空浏览记录失败:', error);\n          uni.showToast({ title: '网络错误', icon: 'none' });\n        }\n      }\n    }\n  });\n};\n\n// 筛选器变化时重置分页并重新加载\nconst handleFunctionChange = (e) => {\n  functionIndex.value = e.detail.value;\n  resetAndLoad();\n};\n\nconst handleCategoryChange = (e) => {\n  categoryIndex.value = e.detail.value;\n  // 分类筛选仅过滤本地数据，无需重新请求接口\n};\n\nconst handleSearch = () => {\n  // 搜索仅过滤本地数据，无需重新请求接口\n};\n\nonUnmounted(() => {\n  // 清理工作\n});\n</script>\n\n<style scoped>\n.history-browse-page {\n  background-color: #f5f7fa;\n  min-height: 100vh;\n  padding-bottom: 40rpx;\n}\n\n/* 导航栏样式 */\n.navbar {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  height: 100rpx;\n  padding: 0 30rpx;\n  background-color: #fff;\n  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\n  position: sticky;\n  top: 0;\n  z-index: 999;\n}\n\n.nav-title {\n  font-size: 36rpx;\n  font-weight: 600;\n  color: #333;\n}\n\n/* 清空按钮 */\n.clear-btn {\n  background-color: transparent;\n  color: #f5222d;\n  font-size: 28rpx;\n  padding: 0 20rpx;\n  margin-right: 16rpx;\n  height: 60rpx;\n  line-height: 60rpx;\n}\n\n/* 筛选区域样式 */\n.filter-container {\n  padding: 20rpx;\n  background-color: #fff;\n  margin-bottom: 20rpx;\n  box-shadow: 0 2rpx 5rpx rgba(0, 0, 0, 0.03);\n}\n\n.search-box {\n  display: flex;\n  align-items: center;\n  background-color: #f5f7fa;\n  border-radius: 60rpx;\n  padding: 0 20rpx;\n  height: 70rpx;\n  margin-bottom: 20rpx;\n}\n\n.search-icon {\n  margin-right: 10rpx;\n}\n\n.search-input {\n  flex: 1;\n  height: 100%;\n  font-size: 28rpx;\n  color: #333;\n  background: transparent;\n}\n\n.picker-container {\n  display: flex;\n  gap: 20rpx;\n  overflow-x: auto;\n  padding-bottom: 10rpx;\n  scrollbar-width: none; /* 隐藏滚动条 */\n}\n\n.picker-container::-webkit-scrollbar {\n  display: none; /* 隐藏滚动条 */\n}\n\n.picker-item {\n  display: flex;\n  align-items: center;\n  background-color: #f5f7fa;\n  border-radius: 40rpx;\n  padding: 0 20rpx;\n  height: 60rpx;\n  flex-shrink: 0;\n}\n\n.picker-label {\n  font-size: 28rpx;\n  color: #666;\n  margin-right: 10rpx;\n}\n\n.custom-picker {\n  width: auto;\n}\n\n.picker-display {\n  display: flex;\n  align-items: center;\n  font-size: 28rpx;\n  color: #333;\n  padding: 0 5rpx;\n}\n\n.picker-icon {\n  margin-left: 8rpx;\n}\t\n\n.loading-more {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 30rpx 0;\n  color: #666;\n  font-size: 28rpx;\n}\n\n.loading-text {\n  margin-left: 10rpx;\n}\n\n.no-more {\n  text-align: center;\n  padding: 30rpx 0;\n  color: #999;\n  font-size: 28rpx;\n}\n</style>","import MiniProgramPage from 'C:/Users/86133/Desktop/demo/Lezhuan/pages/history/history.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onMounted","ensureLoggedIn","onShow","uni","userApi","onReachBottom","computed","res","onUnmounted"],"mappings":"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"}