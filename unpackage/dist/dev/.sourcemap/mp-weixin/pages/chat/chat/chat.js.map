{"version":3,"file":"chat.js","sources":["pages/chat/chat/chat.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdC9jaGF0L2NoYXQudnVl"],"sourcesContent":["<template>\n  <view class=\"chat-page\">\n    <!-- å¼¹çª—ï¼šä¼˜å…ˆæ˜¾ç¤ºï¼Œå…³é—­åå±•ç¤ºé¡µé¢å†…å®¹ -->\n    <view class=\"popup-overlay\" v-if=\"showPopup\">\n      <view class=\"popup-container\">\n        <view class=\"popup-content\">è¯·å‹¿å‘é€è¾±éª‚ã€æ­§è§†å†…å®¹ï¼Œå…±å»ºå‹å¥½äº¤æµç¯å¢ƒï¼Œè¿è€…å°†é™åˆ¶èŠå¤©åŠŸèƒ½ï¼Œæœ¬å¹³å°ä»…ä½œä¸ºä¿¡æ¯äº¤æµå¹³å°ï¼Œå¦‚é‡å¿ƒä»ªç‰©å“è¯·åŠ å¾®ä¿¡è‡ªè¡Œäº¤æ˜“ï¼Œç”±æ­¤äº§ç”Ÿçš„çº çº·ï¼Œå¹³å°ä¸æ‰¿æ‹…è´£ä»»ï¼Œäº¤æ˜“é£é™©è¯·è‡ªè¡Œæ‰¿æ‹…ã€‚</view>\n        <button class=\"popup-close-btn\" @click=\"showPopup = false\">æˆ‘çŸ¥é“äº†</button>\n      </view>\n    </view>\n\n    <!-- ä¸»å†…å®¹åŒºï¼šå¼¹çª—å…³é—­åæ˜¾ç¤º -->\n    <view class=\"main-content\" v-if=\"!showPopup\">\n      <!-- å‚æ•°ä¿¡æ¯å±•ç¤ºï¼šå¡ç‰‡å¼è®¾è®¡ -->\n      <view class=\"params-card\" v-if=\"isProductChat && showParams\">\n        <!-- å¡ç‰‡å¤´éƒ¨ï¼šæ ‡é¢˜+å…³é—­æŒ‰é’® -->\n        <view class=\"params-card__header\">\n          <view class=\"params-card__user\">\n            <image :src=\"sellerInfo.avatar || '/static/avatars/avatar1.jpeg'\" class=\"user-avatar\" mode=\"aspectFill\"></image>\n            <text class=\"params-card__title\">{{ sellerInfo.name || 'æœªè®¾ç½®' }}</text>\n          </view>\n          <view class=\"params-card__close\" @click=\"showParams = false\" hover-class=\"params-card__close--active\">\n            <uni-icons type=\"closeempty\" size=\"12\"></uni-icons>\n          </view>\n        </view>\n\n        <!-- å¡ç‰‡å†…å®¹ï¼šå•†å“/éœ€æ±‚ä¿¡æ¯å±•ç¤º -->\n        <view class=\"params-card__content\">\n          <!-- å›¾ç‰‡åŒºåŸŸ -->\n          <image :src=\"itemInfo.image || '/static/products/p1.jpeg'\" class=\"product-image\" mode=\"aspectFill\"></image>\n          <!-- ä¿¡æ¯åŒºåŸŸ -->\n          <view class=\"product-info\">\n            <text class=\"product-title\">{{ itemInfo.name || 'æœªçŸ¥' }}</text>\n            <text class=\"product-price\" v-if=\"itemInfo.price !== undefined\">Â¥{{ (itemInfo.price || 0).toFixed(2) }}</text>\n            <text class=\"product-price\" v-else>é¢„ç®—: Â¥{{ itemInfo.budgetMin || 0 }} - Â¥{{ itemInfo.budgetMax || 0 }}</text>\n            \n            <view class=\"tags\" v-if=\"itemInfo.tags && itemInfo.tags.length > 0\">\n              <view class=\"tag-view\" v-for=\"(tag, index) in itemInfo.tags\" :key=\"index\">\n                <uni-tag \n                  size=\"mini\"\n                  :text=\"tag\" \n                  :type=\"getTagType(tag)\" \n                />\n              </view>\n            </view>\n          </view>\n        </view>\n        <!-- å¡ç‰‡åº•éƒ¨ï¼šæ”¶èµ·æç¤º -->\n        <view class=\"params-card__footer\" @click=\"showParams = false\" hover-class=\"params-card__footer--active\">\n          <text class=\"params-card__footer-text\">æ”¶èµ·ä¿¡æ¯</text>\n          <uni-icons type=\"down\" size=\"12\"></uni-icons>\n        </view>\n      </view>\n\n      <view class=\"params-expand-btn\" v-if=\"isProductChat && !showParams\" @click=\"showParams = true\" hover-class=\"params-expand-btn--active\">\n        <text class=\"params-expand-btn__text\">å±•å¼€æ²Ÿé€šä¿¡æ¯</text>\n        <uni-icons type=\"up\" size=\"12\" class=\"params-expand-btn__icon\"></uni-icons>\n      </view>\n\n      <!-- èŠå¤©å†…å®¹åŒº -->\n      <scroll-view \n        class=\"chat-container\" \n        scroll-y \n        :scroll-with-animation=\"true\"\n        :scroll-top=\"scrollTop\"\n        @scroll=\"onScroll\"\n        @scrolltolower=\"loadMoreHistory\"\n        ref=\"scrollViewRef\"\n      >\n        <!-- åŠ è½½æ›´å¤šæç¤º -->\n        <view class=\"loading-more\" v-if=\"isLoadingMore\">\n          åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯...\n        </view>\n        \n        <view class=\"message-list\">\n          <!-- ç³»ç»Ÿæç¤º -->\n          <view class=\"system-message\" v-if=\"showSystemTip && sellerInfo.name\" >\n            æ­£åœ¨ä¸ {{ sellerInfo.name }} æ²Ÿé€šä¸­...\n          </view>\n\n          <!-- æ¶ˆæ¯åˆ—è¡¨ï¼šæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡æ¶ˆæ¯ -->\n          <view \n            class=\"message-item\" \n            :class=\"{ 'self-message1': msg.isSelf }\" \n            v-for=\"(msg, index) in messageList\" \n            :key=\"msg.id\"\n          >\n            <!-- æ—¶é—´ -->\n            <text class=\"message-time\" v-if=\"shouldShowTime(index)\">{{ formatTime(msg.timestamp) }}</text>\n            \n            <!-- æ¶ˆæ¯å†…å®¹ä¸å¤´åƒæ¨ªå‘å¸ƒå±€ -->\n            <view :class=\"{ 'self-message': msg.isSelf }\" class=\"message-content-wrap\">\n              <image \n                :src=\"msg.avatar\" \n                mode=\"widthFix\" \n                class=\"avatar\"\n              ></image>\n              <!-- æ°”æ³¡ä¿¡æ¯ -->\n              <view class=\"message-bubble\">\n                <!-- å‘é€è€…æ˜µç§°ï¼ˆéè‡ªå·±å‘é€çš„æ¶ˆæ¯æ‰æ˜¾ç¤ºï¼‰ -->\n                <text class=\"sender-nickname\" v-if=\"!msg.isSelf && msg.senderNickname\">{{ msg.senderNickname }}</text>\n                <!-- æ–‡æœ¬æ¶ˆæ¯ -->\n                <text class=\"message-content\" v-if=\"msg.type === 'text'\">{{ msg.content }}</text>\n                <!-- å›¾ç‰‡æ¶ˆæ¯ -->\n                <image \n                  v-else-if=\"msg.type === 'image'\" \n                  :src=\"msg.content\" \n                  mode=\"widthFix\" \n                  class=\"message-image\"\n                  @click=\"previewImage(msg.content)\"\n                ></image>\n              </view>\n            </view>\n          </view>\n        </view>\n      </scroll-view>\n\n      <!-- è¾“å…¥åŠè¡¨æƒ…é¢æ¿åŒºåŸŸ -->\n      <view class=\"input-panel\">\n        <!-- åŠŸèƒ½å·¥å…·æ ï¼šè¡¨æƒ…ã€å›¾ç‰‡ -->\n        <view class=\"tool-bar\">\n          <view class=\"tool-btn\" @click=\"toggleEmojiPanel\">\n            <uni-icons v-if=\"!showEmojiPanel\" type=\"heart\" size=\"24\"></uni-icons>\n            <uni-icons v-else type=\"chat\" size=\"24\"></uni-icons>\n          </view>\n          <view class=\"tool-btn\" @click=\"chooseImage\">\n            <uni-icons type=\"image\" size=\"24\"></uni-icons>\n          </view>\n        </view>\n      \n        <!-- è¾“å…¥åŒºåŸŸ -->\n        <view class=\"input-container\">\n          <input \n            type=\"text\" \n            v-model=\"inputContent\" \n            placeholder=\"è¯·è¾“å…¥æ¶ˆæ¯...\" \n            class=\"message-input\"\n            @confirm=\"sendMessage\"\n            maxlength=\"200\"\n          />\n          <button \n            class=\"send-button\" \n            @click=\"sendMessage\"\n            :disabled=\"!inputContent.trim() && !waitSendImage\"\n          >\n            å‘é€\n          </button>\n        </view>\n        <!-- è¡¨æƒ…é¢æ¿ï¼šåˆ‡æ¢æ˜¾ç¤º -->\n        <view class=\"emoji-panel\" v-if=\"showEmojiPanel\">\n          <view class=\"emoji-list\">\n            <view \n              class=\"emoji-item\" \n              v-for=\"(emoji, index) in emojiList\" \n              :key=\"index\"\n              @click=\"insertEmoji(emoji)\"\n            >\n              {{ emoji }}\n            </view>\n          </view>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted, watch, getCurrentInstance, nextTick } from 'vue';\nimport { onLoad,onUnload } from '@dcloudio/uni-app';\nimport chatApi from '@/api/chat.js'; // å‡è®¾çš„èŠå¤©API\nimport productApi from '@/api/product.js'; // å‡è®¾çš„å•†å“API\nimport userApi from '@/api/user.js'; // å‡è®¾çš„èŠå¤©API\n\n// WebSocketç›¸å…³å˜é‡\nconst timer = ref(null); \nconst socketTask = ref(null); // uni Socketä»»åŠ¡å®ä¾‹\nconst socketUrl = ref('ws://8.141.125.2:8083/native-ws'); // ä¿®æ”¹ä¸ºåŸç”ŸWebSocketç«¯ç‚¹\nconst isSocketConnected = ref(false);\nconst reconnectCount = ref(0); // é‡è¿æ¬¡æ•°è®¡æ•°\nconst maxReconnectCount = ref(5); // æœ€å¤§é‡è¿æ¬¡æ•°\nconst heartbeatTimer = ref(null);\nconst heartbeatInterval = 30000; // å¿ƒè·³é—´éš”30ç§’\nconst connectionTimer = ref(null); // è¿æ¥è¶…æ—¶æ£€æµ‹å®šæ—¶å™¨\nconst connectionTimeout = 10000; // è¿æ¥è¶…æ—¶æ—¶é—´5ç§’\n\n// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä»APIè·å–çœŸå®ç”¨æˆ·ä¿¡æ¯ï¼‰\nconst currentUser = ref({\n  id: null, // å°†ä»APIè·å–\n  avatar: '/static/avatars/avatar1.jpeg',\n  nickname: ''\n});\n\n// å–å®¶/å¯¹æ–¹ä¿¡æ¯\nconst sellerInfo = ref({\n  name: '', \n  avatar: '/static/avatars/avatar1.jpeg',\n  type: 'buyer'\n});\n\n// å•†å“/éœ€æ±‚ä¿¡æ¯\nconst itemInfo = ref({\n  name: '',\n  price: 0,\n  image: '/static/products/p1.jpeg',\n  tags: [],\n  budgetMin: 0,\n  budgetMax: 0\n});\n\n// 1. å¼¹çª—çŠ¶æ€\nconst showPopup = ref(true); // åˆå§‹æ˜¾ç¤ºå¼¹çª—\n\n// 2. æ¥æ”¶è·¯ç”±å‚æ•°\nconst sellerId = ref('');\nconst itemId = ref(''); // å•†å“æˆ–éœ€æ±‚ID\nconst itemType = ref(''); // productæˆ–demand\n\n// 3. é¡µé¢çŠ¶æ€\nconst showParams = ref(true); // æ˜¯å¦æ˜¾ç¤ºå‚æ•°ä¿¡æ¯\nconst showSystemTip = ref(true); // æ˜¯å¦æ˜¾ç¤ºç³»ç»Ÿæç¤º\nconst inputContent = ref(''); // è¾“å…¥æ¡†å†…å®¹\nconst messageList = ref([]); // æ¶ˆæ¯åˆ—è¡¨\nconst scrollTop = ref(0); // æ»šåŠ¨ä½ç½®\nconst isAutoScroll = ref(true); // æ˜¯å¦è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨\nconst scrollViewRef = ref(null); // æ»šåŠ¨è§†å›¾å¼•ç”¨\n\n// åˆ†é¡µç›¸å…³\nconst page = ref(1); // å½“å‰é¡µç \nconst pageSize = ref(20); // æ¯é¡µæ¡æ•°\n\nconst hasMore = ref(true); // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®\nconst isLoadingMore = ref(false); // æ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤š\nconst totalPages = ref(0); // æ€»é¡µæ•°ï¼ˆæœ€å¤§é¡µç ï¼Œå³æœ€æ–°æ¶ˆæ¯æ‰€åœ¨é¡µï¼‰\nconst loadedPages = ref([]); // å·²åŠ è½½çš„é¡µç é›†åˆï¼ˆç”¨äºé¿å…é‡å¤åŠ è½½ï¼‰\n\n// ç¼“å­˜ç›¸å…³\nconst isLoadingFromCache = ref(true); // æ˜¯å¦æ­£åœ¨ä»ç¼“å­˜åŠ è½½\nconst cacheKey = ref(''); // ç¼“å­˜é”®å\n\nconst receiverId = ref(''); // æ¥æ”¶æ–¹id\nconst senderId = ref(''); // å‘é€æ–¹id\nconst isProductChat = ref(false); // æ˜¯å¦ä¸ºå•†å“/éœ€æ±‚ç›¸å…³èŠå¤©\n\n// 4. è¡¨æƒ…åŠŸèƒ½ç›¸å…³\nconst showEmojiPanel = ref(false); // è¡¨æƒ…é¢æ¿æ˜¾ç¤ºçŠ¶æ€\nconst emojiList = ref([\n  'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡',\n  'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',\n  'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¥¸',\n  'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–'\n]);\n\n// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯\nconst fetchCurrentUserInfo = async () => {\n  try {\n    // é¦–å…ˆå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·ä¿¡æ¯ä½œä¸ºå¤‡ç”¨\n    const storedUserInfo = uni.getStorageSync('userInfo');\n    const storedUserId = uni.getStorageSync('studentIdNumber');\n    const storedNickname = uni.getStorageSync('nickname');\n    const storedAvatarUrl = uni.getStorageSync('avatarUrl');\n    \n    // å¦‚æœæœ‰æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå…ˆä½¿ç”¨å®ƒ\n    if (storedUserInfo || storedUserId) {\n      currentUser.value = {\n        id: storedUserId || storedUserInfo?.studentIdNumber || storedUserInfo?.id || 1,\n        avatar: storedAvatarUrl || storedUserInfo?.avatarUrl || '/static/avatars/avatar1.jpeg',\n        nickname: storedNickname || storedUserInfo?.nickName || storedUserInfo?.nickname || 'ç”¨æˆ·'\n      };\n      console.log('ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·ä¿¡æ¯:', currentUser.value);\n    }\n    \n    // ç„¶åå°è¯•ä»æœåŠ¡å™¨è·å–æœ€æ–°ä¿¡æ¯\n    const res = await userApi.getCurrentUser();\n    if (res.code === 200 && res.data) {\n      currentUser.value = {\n        id: res.data.id,\n        avatar: res.data.avatarUrl || '/static/avatars/avatar1.jpeg',\n        nickname: res.data.nickname || 'ç”¨æˆ·'\n      };\n      console.log('ä»æœåŠ¡å™¨è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:', currentUser.value);\n    } else if (!currentUser.value.id) {\n      // å¦‚æœæœåŠ¡å™¨è¯·æ±‚å¤±è´¥ä¸”æ²¡æœ‰æœ¬åœ°å­˜å‚¨ï¼Œä½¿ç”¨é»˜è®¤å€¼\n      throw new Error('æœåŠ¡å™¨è¿”å›æ•°æ®æ— æ•ˆ');\n    }\n  } catch (error) {\n    console.error('è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);\n    \n    // å¦‚æœè¿˜æ²¡æœ‰è®¾ç½®ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨å†æ¬¡è·å–\n    if (!currentUser.value.id) {\n      const storedUserInfo = uni.getStorageSync('userInfo');\n      const storedUserId = uni.getStorageSync('studentIdNumber');\n      const storedNickname = uni.getStorageSync('nickname');\n      const storedAvatarUrl = uni.getStorageSync('avatarUrl');\n      \n      if (storedUserInfo || storedUserId) {\n        currentUser.value = {\n          id: storedUserId || storedUserInfo?.studentIdNumber || storedUserInfo?.id || 1,\n          avatar: storedAvatarUrl || storedUserInfo?.avatarUrl || '/static/avatars/avatar1.jpeg',\n          nickname: storedNickname || storedUserInfo?.nickName || storedUserInfo?.nickname || 'ç”¨æˆ·'\n        };\n        console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„å¤‡ç”¨ç”¨æˆ·ä¿¡æ¯:', currentUser.value);\n      } else {\n        // æœ€åçš„é»˜è®¤å€¼\n        currentUser.value = {\n          id: 1, // é»˜è®¤IDï¼Œå®é™…åº”è¯¥ä»æœ¬åœ°å­˜å‚¨è·å–\n          avatar: '/static/avatars/avatar1.jpeg',\n          nickname: 'ç”¨æˆ·'\n        };\n        console.log('ä½¿ç”¨é»˜è®¤ç”¨æˆ·ä¿¡æ¯:', currentUser.value);\n      }\n    }\n  }\n};\n\n// ç¼“å­˜ç›¸å…³å‡½æ•°\nconst generateCacheKey = (otherUserId) => {\n  return `chat_messages_${currentUser.value.id}_${otherUserId}`;\n};\n\nconst loadMessagesFromCache = (otherUserId) => {\n  try {\n    const key = generateCacheKey(otherUserId);\n    const cachedData = uni.getStorageSync(key);\n    if (cachedData && cachedData.messages && cachedData.messages.length > 0) {\n      console.log('ä»ç¼“å­˜åŠ è½½æ¶ˆæ¯:', cachedData.messages.length, 'æ¡');\n      messageList.value = cachedData.messages;\n      // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨\n      setTimeout(() => {\n        scrollToBottom();\n      }, 100);\n      return true;\n    }\n  } catch (error) {\n    console.error('ä»ç¼“å­˜åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);\n  }\n  return false;\n};\n\nconst saveMessagesToCache = (otherUserId, messages) => {\n  try {\n    const key = generateCacheKey(otherUserId);\n    const cacheData = {\n      messages: messages,\n      timestamp: Date.now(),\n      otherUserId: otherUserId\n    };\n    uni.setStorageSync(key, cacheData);\n    console.log('æ¶ˆæ¯å·²ä¿å­˜åˆ°ç¼“å­˜:', messages.length, 'æ¡');\n  } catch (error) {\n    console.error('ä¿å­˜æ¶ˆæ¯åˆ°ç¼“å­˜å¤±è´¥:', error);\n  }\n};\n\n// ç«‹å³æ·»åŠ æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨\nconst addMessageToLocal = (messageData) => {\n  try {\n    // åˆ›å»ºæœ¬åœ°æ¶ˆæ¯å¯¹è±¡\n    const localMessage = {\n      id: 'temp_' + Date.now(), // ä¸´æ—¶IDï¼Œåç»­ä¼šè¢«æœåŠ¡å™¨è¿”å›çš„çœŸå®IDæ›¿æ¢\n      isSelf: true, // å‘é€çš„æ¶ˆæ¯éƒ½æ˜¯è‡ªå·±çš„\n      type: messageData.messageType || 'text',\n      avatar: currentUser.value.avatar || '/static/avatars/avatar1.jpeg',\n      senderNickname: currentUser.value.nickname || currentUser.value.username,\n      receiverNickname: '', // æ¥æ”¶è€…æ˜µç§°æš‚æ—¶ä¸ºç©º\n      senderId: currentUser.value.id,\n      receiverId: messageData.receiverId,\n      content: messageData.content,\n      timestamp: Date.now(),\n      isRead: false,\n      isLocal: true // æ ‡è®°ä¸ºæœ¬åœ°æ¶ˆæ¯ï¼Œç”¨äºåŒºåˆ†\n    };\n    \n    // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨æœ«å°¾\n    messageList.value.push(localMessage);\n    \n    // æ»šåŠ¨åˆ°åº•éƒ¨\n    setTimeout(() => {\n      scrollToBottom();\n    }, 50);\n    \n    console.log('æ¶ˆæ¯å·²ç«‹å³æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨');\n    return localMessage;\n  } catch (error) {\n    console.error('æ·»åŠ æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨å¤±è´¥:', error);\n    return null;\n  }\n};\n\n// ç«‹å³æ·»åŠ æ¥æ”¶åˆ°çš„æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨\nconst addReceivedMessageToLocal = (messageData) => {\n  try {\n    // åˆ›å»ºæ¥æ”¶æ¶ˆæ¯å¯¹è±¡\n    const receivedMessage = {\n      id: messageData.id || 'temp_received_' + Date.now(),\n      isSelf: false, // æ¥æ”¶çš„æ¶ˆæ¯ä¸æ˜¯è‡ªå·±çš„\n      type: messageData.messageType || 'text',\n      avatar: messageData.senderAvatar || '/static/avatars/avatar1.jpeg',\n      senderNickname: messageData.senderNickname || 'å¯¹æ–¹',\n      receiverNickname: currentUser.value.nickname || currentUser.value.username,\n      senderId: messageData.senderId,\n      receiverId: messageData.receiverId,\n      content: messageData.content,\n      timestamp: messageData.timestamp || Date.now(),\n      isRead: false,\n      isReceived: true // æ ‡è®°ä¸ºæ¥æ”¶çš„æ¶ˆæ¯\n    };\n    \n    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„æ¶ˆæ¯ï¼ˆé¿å…é‡å¤ï¼‰\n    const existingMessage = messageList.value.find(msg => \n      msg.id === receivedMessage.id || \n      (msg.content === receivedMessage.content && \n       msg.senderId === receivedMessage.senderId && \n       Math.abs(msg.timestamp - receivedMessage.timestamp) < 5000) // 5ç§’å†…çš„ç›¸åŒæ¶ˆæ¯è®¤ä¸ºæ˜¯é‡å¤\n    );\n    \n    if (!existingMessage) {\n      // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨æœ«å°¾\n      messageList.value.push(receivedMessage);\n      \n      // æ»šåŠ¨åˆ°åº•éƒ¨\n      setTimeout(() => {\n        scrollToBottom();\n      }, 50);\n      \n      console.log('æ¥æ”¶æ¶ˆæ¯å·²ç«‹å³æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨');\n    } else {\n      console.log('æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ');\n    }\n    \n    return receivedMessage;\n  } catch (error) {\n    console.error('æ·»åŠ æ¥æ”¶æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨å¤±è´¥:', error);\n    return null;\n  }\n};\n\n// ç›‘å¬é¡µé¢åŠ è½½ï¼Œè·å–å‚æ•°å¹¶åˆå§‹åŒ–å†å²æ¶ˆæ¯\nonLoad(async (options) => {\n  // 1. ç¬¬ä¸€æ­¥ï¼šå…ˆè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼‰\n  await fetchCurrentUserInfo();\n  if (!currentUser.value.id) {\n    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œæ— æ³•åˆå§‹åŒ–èŠå¤©');\n    uni.showToast({ title: 'ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'none' });\n    return;\n  }\n\n  // 2. ç¬¬äºŒæ­¥ï¼šè·å–è·¯ç”±å‚æ•°ï¼ˆsellerId/receiverIdç­‰ï¼Œæ¶ˆæ¯åŠ è½½éœ€è¦ï¼‰\n  sellerId.value = options.sellerId || '';\n  itemId.value = options.itemId || '';\n  itemType.value = options.type || '';\n  receiverId.value = options.receiverId || '';\n  senderId.value = options.senderId || currentUser.value.id;\n\n  // åˆ¤æ–­æ˜¯å¦ä¸ºå•†å“èŠå¤©\n  isProductChat.value = !!itemId.value && (itemType.value === 'product' || itemType.value === 'demand');\n  showParams.value = isProductChat.value;\n\n  // 3. ç¬¬ä¸‰æ­¥ï¼šåŠ è½½å•†å“/éœ€æ±‚è¯¦æƒ…å’Œå¯¹æ–¹ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œä¸å½±å“æ¶ˆæ¯åŠ è½½ï¼‰\n  const otherUserId = sellerId.value || receiverId.value;\n  if (isProductChat.value) {\n    if (itemType.value === 'product') fetchProductDetail(itemId.value);\n    else if (itemType.value === 'demand') fetchDemandDetail(itemId.value);\n  }\n  if (otherUserId) fetchSellerInfo(otherUserId);\n\n  // 4. ç¬¬å››æ­¥ï¼šå…ˆå°è¯•ä»ç¼“å­˜åŠ è½½ï¼ˆå¯é€‰ï¼‰ï¼Œå†ä»æœåŠ¡å™¨åŠ è½½æœ€æ–°æ¶ˆæ¯\n  let hasCache = false;\n  if (otherUserId) {\n    hasCache = loadMessagesFromCache(otherUserId);\n    if (hasCache) console.log('å·²ä»ç¼“å­˜åŠ è½½æ¶ˆæ¯ï¼Œåå°åŒæ­¥æœ€æ–°æ•°æ®');\n  }\n\n  // 5. ç¬¬äº”æ­¥ï¼šä»æœåŠ¡å™¨åŠ è½½æœ€æ–°æ¶ˆæ¯ï¼ˆæ ¸å¿ƒï¼Œå¿…é¡»åœ¨å‚æ•°éƒ½è·å–åè°ƒç”¨ï¼‰\n  page.value = 1;\n  await initMessageList();\n\n  // 6. ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–WebSocketï¼ˆæœ€åï¼Œé¿å…é‡å¤åŠ è½½æ¶ˆæ¯ï¼‰\n  console.log('å‡†å¤‡åˆå§‹åŒ–WebSocketè¿æ¥ï¼Œç”¨æˆ·ID:', currentUser.value.id);\n  initWebSocket();\n\n  // å»¶è¿Ÿé‡è¿æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰\n  setTimeout(() => {\n    if (!isSocketConnected.value) {\n      console.log('é¦–æ¬¡è¿æ¥æœªæˆåŠŸï¼Œå°è¯•é‡æ–°å»ºç«‹è¿æ¥');\n      initWebSocket();\n    }\n  }, 1000);\n  \n  timer.value = setInterval(() => fetchMessageList(1), 3000); \n});\n\n// åˆå§‹åŒ–WebSocketè¿æ¥\nconst initWebSocket = () => {\n  // éªŒè¯ç”¨æˆ·IDæ˜¯å¦æœ‰æ•ˆ\n  if (!currentUser.value.id) {\n    console.error('ç”¨æˆ·IDæ— æ•ˆï¼Œæ— æ³•å»ºç«‹WebSocketè¿æ¥');\n    uni.showToast({ title: 'ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œè¯·é‡æ–°è¿›å…¥', icon: 'none' });\n    return;\n  }\n  \n  console.log('å¼€å§‹å»ºç«‹WebSocketè¿æ¥ï¼Œç”¨æˆ·ID:', currentUser.value.id);\n  \n  // æ¸…é™¤ä¹‹å‰çš„è¿æ¥è¶…æ—¶å®šæ—¶å™¨\n  if (connectionTimer.value) {\n    clearTimeout(connectionTimer.value);\n    connectionTimer.value = null;\n  }\n  \n  // å…ˆå…³é—­å·²æœ‰è¿æ¥ï¼ˆé¿å…é‡å¤è¿æ¥ï¼‰\n  if (socketTask.value) {\n    uni.closeSocket({\n      success: () => {\n        console.log('å·²å…³é—­æ—§çš„Socketè¿æ¥');\n      }\n    });\n  }\n\n  // è®¾ç½®è¿æ¥è¶…æ—¶æ£€æµ‹\n  connectionTimer.value = setTimeout(() => {\n    if (!isSocketConnected.value) {\n      console.log('è¿æ¥è¶…æ—¶ï¼Œå°è¯•é‡æ–°è¿æ¥');\n      handleReconnect();\n    }\n  }, connectionTimeout);\n\n  socketTask.value = uni.connectSocket({\n    url: `${socketUrl.value}?userId=${currentUser.value.id}`, // å¸¦ç”¨æˆ·IDå‚æ•°\n    header: {\n      'content-type': 'application/json' // å¯é€‰ï¼šæ·»åŠ è¯·æ±‚å¤´\n    },\n    method: 'GET', // å›ºå®šä¸ºGET\n    success: (res) => {\n      console.log('Socketè¿æ¥è¯·æ±‚å·²å‘é€', res);\n    },\n    fail: (err) => {\n      console.error('Socketè¿æ¥è¯·æ±‚å¤±è´¥', err);\n      // æ¸…é™¤è¿æ¥è¶…æ—¶å®šæ—¶å™¨\n      if (connectionTimer.value) {\n        clearTimeout(connectionTimer.value);\n        connectionTimer.value = null;\n      }\n      handleReconnect(); // è¿æ¥å¤±è´¥ç›´æ¥è§¦å‘é‡è¿\n    }\n  });\n\n  // ç›‘å¬è¿æ¥æˆåŠŸï¼ˆæ›¿ä»£åŸsocket.onopenï¼‰\n  uni.onSocketOpen((res) => {\n    console.log('Socketè¿æ¥æˆåŠŸï¼', res);\n    isSocketConnected.value = true; // æ ‡è®°è¿æ¥æˆåŠŸ\n    reconnectCount.value = 0; // é‡ç½®é‡è¿æ¬¡æ•°\n    \n    // æ¸…é™¤è¿æ¥è¶…æ—¶å®šæ—¶å™¨\n    if (connectionTimer.value) {\n      clearTimeout(connectionTimer.value);\n      connectionTimer.value = null;\n    }\n    \n    // å¯åŠ¨å¿ƒè·³æœºåˆ¶\n    startHeartbeat();\n    \n    // å‘é€ç”¨æˆ·ä¸Šçº¿æ¶ˆæ¯\n    const onlineMessage = {\n      type: 'USER_ONLINE'\n    };\n    uni.sendSocketMessage({\n      data: JSON.stringify(onlineMessage),\n      success: () => {\n        console.log('ç”¨æˆ·ä¸Šçº¿æ¶ˆæ¯å‘é€æˆåŠŸ');\n      },\n      fail: (err) => {\n        console.error('ç”¨æˆ·ä¸Šçº¿æ¶ˆæ¯å‘é€å¤±è´¥:', err);\n      }\n    });\n    \n    // initMessageList(); // è¿æ¥æˆåŠŸååŠ è½½å†å²æ¶ˆæ¯\n  });\n\n  // ç›‘å¬æ¶ˆæ¯æ¥æ”¶\n  uni.onSocketMessage((event) => {\n    try {\n      const message = JSON.parse(event.data); // è§£ææ”¶åˆ°çš„æ¶ˆæ¯\n      handleReceivedMessage(message); // å¤„ç†æ¶ˆæ¯\n    } catch (error) {\n      console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);\n    }\n  });\n\n  // ç›‘å¬è¿æ¥å…³é—­\n  uni.onSocketClose((event) => {\n    console.log('Socketè¿æ¥å…³é—­ï¼Œé”™è¯¯ç :', event.code);\n    isSocketConnected.value = false; // æ ‡è®°è¿æ¥æ–­å¼€\n    \n    // åœæ­¢å¿ƒè·³\n    stopHeartbeat();\n\n    // éä¸»åŠ¨å…³é—­ï¼ˆcode!==1000ï¼‰ä¸”æœªè¶…è¿‡æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œè‡ªåŠ¨é‡è¿\n    if (event.code !== 1000 && reconnectCount.value < maxReconnectCount.value) {\n      handleReconnect(); // è§¦å‘é‡è¿\n    } else if (reconnectCount.value >= maxReconnectCount.value) {\n\n      uni.showToast({ title: 'é‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', icon: 'none' });\n    }\n  });\n\n  // ç›‘å¬è¿æ¥é”™è¯¯\n  uni.onSocketError((error) => {\n    console.error('Socketè¿æ¥å‡ºé”™:', error);\n    isSocketConnected.value = false;\n    \n    // åœæ­¢å¿ƒè·³\n    stopHeartbeat();\n    \n    handleReconnect(); // å‡ºé”™æ—¶è§¦å‘é‡è¿\n  });\n};\n\n// å¯åŠ¨å¿ƒè·³æœºåˆ¶\nconst startHeartbeat = () => {\n  // æ¸…é™¤å·²æœ‰çš„å¿ƒè·³å®šæ—¶å™¨\n  stopHeartbeat();\n  \n  heartbeatTimer.value = setInterval(() => {\n    if (isSocketConnected.value) {\n      const pingMessage = {\n        type: 'PING',\n        timestamp: Date.now()\n      };\n      \n      uni.sendSocketMessage({\n        data: JSON.stringify(pingMessage),\n        success: () => {\n          console.log('å¿ƒè·³æ¶ˆæ¯å‘é€æˆåŠŸ');\n        },\n        fail: (err) => {\n          console.error('å¿ƒè·³æ¶ˆæ¯å‘é€å¤±è´¥:', err);\n          // å¿ƒè·³å¤±è´¥ï¼Œå¯èƒ½è¿æ¥å·²æ–­å¼€\n          isSocketConnected.value = false;\n          handleReconnect();\n        }\n      });\n    }\n  }, heartbeatInterval);\n  \n  console.log('å¿ƒè·³æœºåˆ¶å·²å¯åŠ¨ï¼Œé—´éš”:', heartbeatInterval, 'ms');\n};\n\n// åœæ­¢å¿ƒè·³æœºåˆ¶\nconst stopHeartbeat = () => {\n  if (heartbeatTimer.value) {\n    clearInterval(heartbeatTimer.value);\n    heartbeatTimer.value = null;\n    console.log('å¿ƒè·³æœºåˆ¶å·²åœæ­¢');\n  }\n  \n  // åŒæ—¶æ¸…é™¤è¿æ¥è¶…æ—¶å®šæ—¶å™¨\n  if (connectionTimer.value) {\n    clearTimeout(connectionTimer.value);\n    connectionTimer.value = null;\n    console.log('è¿æ¥è¶…æ—¶å®šæ—¶å™¨å·²æ¸…é™¤');\n  }\n};\n\nconst sendReadConfirmation = (messageId) => {\n  if (!isSocketConnected.value || !messageId) return;\n  \n  const data = {\n    type: 'read_confirmation',\n    messageId: messageId,\n    receiverId: sellerId.value || receiverId.value\n  };\n  \n  uni.sendSocketMessage({\n    data: JSON.stringify(data),\n    fail: (err) => {\n      console.error('å·²è¯»ç¡®è®¤å‘é€å¤±è´¥:', err);\n    }\n  });\n};\n\n// å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯\nconst handleReceivedMessage = async (message) => {\n  console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', message);\n  \n  // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯\n  if (message.type === 'SYSTEM_MESSAGE') {\n    console.log('æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯:', message.content, 'ç±»å‹:', message.messageType);\n    \n    switch (message.messageType) {\n      case 'CONNECT_SUCCESS':\n        console.log('WebSocketè¿æ¥æˆåŠŸç¡®è®¤');\n        isSocketConnected.value = true;\n        break;\n      case 'USER_ONLINE_SUCCESS':\n        console.log('ç”¨æˆ·ä¸Šçº¿æˆåŠŸç¡®è®¤');\n        break;\n      case 'ERROR':\n        console.error('æœåŠ¡å™¨é”™è¯¯:', message.content);\n        uni.showToast({ title: message.content, icon: 'none' });\n        break;\n      case 'PING_RESPONSE':\n        console.log('å¿ƒè·³å“åº”');\n        break;\n      default:\n        console.log('æœªçŸ¥ç³»ç»Ÿæ¶ˆæ¯ç±»å‹:', message.messageType);\n    }\n    return;\n  }\n  \n  // å¤„ç†ç§èŠæ¶ˆæ¯\n  if (message.type === 'PRIVATE_MESSAGE' && message.data) {\n    const messageData = message.data;\n    const otherUserId = sellerId.value || receiverId.value;\n    \n    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦ä¸å½“å‰èŠå¤©ç›¸å…³\n    if (messageData.senderId === otherUserId || messageData.receiverId === otherUserId) {\n      // ç«‹å³æ·»åŠ æ¥æ”¶åˆ°çš„æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨\n      addReceivedMessageToLocal(messageData);\n      \n      // å»¶è¿ŸåŒæ­¥æœåŠ¡å™¨æ•°æ®ä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§\n      setTimeout(async () => {\n        try {\n          const res = await fetchMessageList(1); // è·å–ç¬¬ä¸€é¡µæœ€æ–°æ¶ˆæ¯\n          if (res.records && res.records.length > 0) {\n            const formattedMessages = formatMessageList(res.records);\n            \n            // ç›´æ¥ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„çœŸå®æ¶ˆæ¯\n            messageList.value = formattedMessages;\n            \n            // æ›´æ–°ç¼“å­˜\n            if (otherUserId) {\n              saveMessagesToCache(otherUserId, messageList.value);\n            }\n            \n            hasMore.value = res.records.length >= pageSize.value;\n          }\n        } catch (error) {\n          console.error('åŒæ­¥æœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:', error);\n        }\n      }, 1500); // å»¶è¿Ÿ1.5ç§’åŒæ­¥ï¼Œç»™æ¥æ”¶æ¶ˆæ¯æ›´å¤šæ—¶é—´\n    }\n    return;\n  }\n  \n  // å¤„ç†æ¶ˆæ¯å‘é€ç¡®è®¤\n  if (message.type === 'MESSAGE_SENT' && message.data) {\n    console.log('æ¶ˆæ¯å‘é€ç¡®è®¤:', message.data);\n    return;\n  }\n  \n  // å…¼å®¹æ—§æ ¼å¼çš„æ¶ˆæ¯å¤„ç†\n  const otherUserId = sellerId.value || receiverId.value;\n  if (message.senderId === otherUserId || message.receiverId === otherUserId) {\n    // ç«‹å³æ·»åŠ æ¥æ”¶åˆ°çš„æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨\n    addReceivedMessageToLocal(message);\n    \n    // å»¶è¿ŸåŒæ­¥æœåŠ¡å™¨æ•°æ®ä»¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§\n    setTimeout(async () => {\n      try {\n        const res = await fetchMessageList(1); // è·å–ç¬¬ä¸€é¡µæœ€æ–°æ¶ˆæ¯\n        if (res.records && res.records.length > 0) {\n          const formattedMessages = formatMessageList(res.records);\n          \n          // ç›´æ¥ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„çœŸå®æ¶ˆæ¯\n          messageList.value = formattedMessages;\n          \n          // æ›´æ–°ç¼“å­˜\n          if (otherUserId) {\n            saveMessagesToCache(otherUserId, messageList.value);\n          }\n          \n          hasMore.value = res.records.length >= pageSize.value;\n        }\n      } catch (error) {\n        console.error('åŒæ­¥æœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:', error);\n      }\n    }, 1500); // å»¶è¿Ÿ1.5ç§’åŒæ­¥ï¼Œç»™æ¥æ”¶æ¶ˆæ¯æ›´å¤šæ—¶é—´\n  }\n};\n\nconst handleReconnect = () => {\n  if(reconnectCount.value >= maxReconnectCount.value)return;\n  reconnectCount.value++; // é‡è¿æ¬¡æ•°+1\n  const delay = reconnectCount.value * 1000; // é‡è¿å»¶è¿Ÿï¼š1sã€2sã€3s...ï¼ˆé€æ¸å˜é•¿ï¼‰\n  console.log(`ç¬¬${reconnectCount.value}æ¬¡é‡è¿ï¼Œå»¶è¿Ÿ${delay}æ¯«ç§’`);\n\n  // å»¶è¿Ÿåé‡æ–°åˆå§‹åŒ–è¿æ¥\n  setTimeout(() => {\n    initWebSocket();\n  }, delay);\n};\n\n// åŠ è½½å•†å“è¯¦æƒ…\nconst fetchProductDetail = async (id) => {\n  if (!id) return;\n  try {\n    const res = await productApi.getProductDetail(id);\n    if (res.code === 200) {\n      itemInfo.value = {\n        name: res.data.name || 'æœªçŸ¥å•†å“',\n        price: res.data.price || 0,\n        image: res.data.mainImageUrl || '/static/products/p1.jpeg',\n        tags: res.data.tags || [],\n      };\n    } else {\n      uni.showToast({ title: 'å•†å“ä¿¡æ¯åŠ è½½å¤±è´¥', icon: 'none' });\n    }\n  } catch (error) {\n    console.error('å•†å“è¯¦æƒ…è¯·æ±‚å¤±è´¥ï¼š', error);\n    uni.showToast({ title: 'ç½‘ç»œé”™è¯¯', icon: 'none' });\n  }\n};\n\n// åŠ è½½éœ€æ±‚è¯¦æƒ…\nconst fetchDemandDetail = async (id) => {\n  if (!id) return;\n  try {\n    const res = await productApi.getDemandDetail(id);\n    if (res.code === 200) {\n      // å¤„ç†éœ€æ±‚å±æ€§æ ‡ç­¾\n      let tags = [];\n      if (res.data.attributes) {\n        try {\n          const attributesObj = JSON.parse(res.data.attributes);\n          tags = Object.values(attributesObj);\n        } catch (err) {\n          console.error('è§£æattributeså¤±è´¥:', err);\n        }\n      }\n      // æ·»åŠ å¯è®®ä»·æ ‡ç­¾\n      tags.unshift(res.data.isNegotiable ? 'å¯åˆ€' : 'ä¸å¯åˆ€');\n      \n      itemInfo.value = {\n        name: res.data.title || 'æœªçŸ¥éœ€æ±‚',\n        budgetMin: res.data.budgetMin || 0,\n        budgetMax: res.data.budgetMax || 0,\n        image: res.data.imageUrl || '/static/products/p1.jpeg',\n        tags: tags\n      };\n      \n      // è®¾ç½®éœ€æ±‚å‘å¸ƒè€…ä¿¡æ¯\n      if (res.data.requester) {\n        sellerInfo.value.name = res.data.requester.nickname || 'æœªçŸ¥ç”¨æˆ·';\n        sellerInfo.value.avatar = res.data.requester.avatar || '/static/avatars/avatar1.jpeg';\n      }\n    } else {\n      uni.showToast({ title: 'éœ€æ±‚ä¿¡æ¯åŠ è½½å¤±è´¥', icon: 'none' });\n    }\n  } catch (error) {\n    console.error('éœ€æ±‚è¯¦æƒ…è¯·æ±‚å¤±è´¥ï¼š', error);\n    uni.showToast({ title: 'ç½‘ç»œé”™è¯¯', icon: 'none' });\n  }\n};\n\n// åŠ è½½å–å®¶ä¿¡æ¯\nconst fetchSellerInfo = async (id) => {\n  if (!id) return;\n  try {\n    // è¿™é‡Œæ›¿æ¢ä¸ºå®é™…è·å–ç”¨æˆ·ä¿¡æ¯çš„æ¥å£\n    const res = await userApi.getUserInfo(id);\n    if (res.code === 200) {\n      sellerInfo.value = {\n        name: res.data.nickname || 'æœªçŸ¥ç”¨æˆ·',\n        avatar: res.data.avatarUrl || '/static/avatars/avatar1.jpeg',\n        type: res.data.type || 'seller'\n      };\n      console.log('è·å–å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:', sellerInfo.value);\n    }\n  } catch (error) {\n    console.error('è·å–å–å®¶ä¿¡æ¯å¤±è´¥ï¼š', error);\n  }\n};\n\n// åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨\nconst initMessageList = async () => {\n  try {\n    const otherUserId = sellerId.value || receiverId.value;\n    if (!otherUserId) {\n      console.error('otherUserIdä¸ºç©ºï¼Œæ— æ³•åŠ è½½æ¶ˆæ¯');\n      isLoadingFromCache.value = false;\n      return;\n    }\n\n    // 1. è·å–ç¬¬1é¡µæ•°æ®ï¼Œè®¡ç®—æ€»é¡µæ•°\n    const firstPageRes = await fetchMessageList(1);\n    const totalCount = firstPageRes.total || 0;\n\t if (pageSize.value <= 0) {\n\t      pageSize.value = 10; // å¼ºåˆ¶é‡ç½®ä¸ºé»˜è®¤å€¼\n\t    }\n    totalPages.value = totalCount > 0 ? Math.ceil(totalCount / pageSize.value) : 0;\n    if (totalCount === 0) {\n      isLoadingFromCache.value = false;\n      return;\n    }\n\n    // 2. ç¡®å®šè¦åŠ è½½çš„â€œæœ€åä¸¤é¡µâ€ï¼ˆæœ€æ–°æ¶ˆæ¯æ‰€åœ¨é¡µï¼‰\n    const latestPages = [];\n    if (totalPages.value >= 2) latestPages.push(totalPages.value - 1); // å…ˆåŠ æ¬¡æ–°é¡µï¼ˆå¦‚page4ï¼‰\n    if (totalPages.value >= 1) latestPages.push(totalPages.value);     // ååŠ æœ€æ–°é¡µï¼ˆå¦‚page5ï¼‰\n    loadedPages.value = [...latestPages];\n\n    // 3. åŠ è½½è¿™ä¸¤é¡µæ¶ˆæ¯\n    const pagePromises = latestPages.map(page => fetchMessageList(page));\n    const pagesData = await Promise.all(pagePromises);\n\n    // 4. åˆå¹¶æ¶ˆæ¯ï¼šæ¬¡æ–°é¡µ + æœ€æ–°é¡µï¼ˆç¡®ä¿æœ€æ–°æ¶ˆæ¯åœ¨æœ«å°¾ï¼‰\n    let allRecords = [];\n    pagesData.forEach(data => {\n      allRecords = [...allRecords, ...data.records]; // æŒ‰[page4, page5]åˆå¹¶\n    });\n\n    // 5. æ ¼å¼åŒ–å¹¶æ›´æ–°æ¶ˆæ¯åˆ—è¡¨\n    const formattedMessages = formatMessageList(allRecords);\n    messageList.value = formattedMessages;\n\n    // 6. ç¼“å­˜å’Œæ»šåŠ¨\n    saveMessagesToCache(otherUserId, formattedMessages);\n    hasMore.value = Math.min(...latestPages) > 1; // æ˜¯å¦è¿˜æœ‰æ›´æ—©çš„é¡µ\n    setTimeout(() => scrollToBottom(), 100); // æ»šåŠ¨åˆ°æœ«å°¾ï¼ˆæœ€æ–°æ¶ˆæ¯ï¼‰\n    isLoadingFromCache.value = false;\n  } catch (error) {\n    console.error('åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨å¤±è´¥ï¼š', error);\n    isLoadingFromCache.value = false;\n  }\n};\n\n// è·å–æ¶ˆæ¯åˆ—è¡¨æ•°æ®\n// const fetchMessageList = async (currentPage) => {\n//   const userId = currentUser.value.id; // å½“å‰ç”¨æˆ·ID\n//   const otherUserId = sellerId.value || receiverId.value;\n  \n//     if (!Number.isInteger(currentPage) || currentPage < 1) {\n//       console.error('æ— æ•ˆçš„é¡µç ï¼Œå·²ä¿®æ­£ä¸º 1');\n//       currentPage = 1;\n//     }\n  \n//   console.log('è°ƒç”¨APIçš„å‚æ•°æ£€æŸ¥:');\n//   console.log('sellerId:', sellerId.value);\n//   console.log('receiverId:', receiverId.value);\n//   console.log('æœ€ç»ˆotherUserId:', otherUserId);\n//   console.log('å½“å‰ç”¨æˆ·ID:', currentUser.value?.id);\n  \n//   //å‚æ•°éªŒè¯\n//   if (!otherUserId) {\n//     console.error('é”™è¯¯ï¼šotherUserIdä¸ºç©ºï¼Œæ— æ³•è·å–èŠå¤©è®°å½•');\n//     // uni.showToast({\n//     //   title: 'èŠå¤©å¯¹è±¡ä¿¡æ¯ç¼ºå¤±',\n//     //   icon: 'none'\n//     // });\n//     return { records: [], total: 0 };\n//   }\n  \n//   const params = {\n//     otherUserId: otherUserId,\n//     current: currentPage,  // ä¿®æ”¹ä¸ºcurrentä»¥åŒ¹é…åç«¯æ¥å£å‚æ•°\n//     size: pageSize.value\n//   };\n  \n//   console.log('è°ƒç”¨APIçš„å‚æ•°:', params);\n  \n//   const res = await chatApi.getMessages(params);\n//   console.log('ä»åç«¯è·å–çš„èŠå¤©è®°å½•è¿”å›çš„ç»“æœæ˜¯:',res)\n//   console.log('è¯·æ±‚æœ€æ–°æ•°æ®çš„å‚æ•°:', params); \n//   console.log(`ç¬¬${currentPage}é¡µæ•°æ®è¿”å›ç»“æœ:`, res.data); \n//   return res.data;\n// };\n\nconst fetchMessageList = async (currentPage) => {\n  // å¼ºåˆ¶æ ¡éªŒï¼šè‹¥currentPageæ— æ•ˆï¼Œé»˜è®¤è®¾ä¸º1\n  if (!Number.isInteger(currentPage) || currentPage < 1) {\n    currentPage = 1;\n    console.warn('æ— æ•ˆçš„é¡µç ï¼Œå·²ä¿®æ­£ä¸º 1');\n  }\t\n  const userId = currentUser.value.id;\n  const otherUserId = sellerId.value || receiverId.value;\n  const params = { otherUserId, current: currentPage, size: pageSize.value };\n\nconsole.log('fetchMessageList è¯·æ±‚å‚æ•°ï¼š', { otherUserId, current: currentPage, size: pageSize.value });\n\n  try {\n    const res = await chatApi.getMessages(params);\n\tconsole.log('ä»åç«¯è·å–çš„èŠå¤©è®°å½•è¿”å›çš„ç»“æœæ˜¯ï¼š',res.data)\n\tif(res.code!==200){\n\t\tuni.showToast({ title: res.msg, icon: 'none' });\n\t}\n    return res.data || { records: [], total: 0 };\n  } catch (error) {\n    console.error('è·å–èŠå¤©æ¶ˆæ¯åˆ—è¡¨å¤±è´¥ï¼š', error);\n    // é‡è¯•é€»è¾‘ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰\n    let retryCount = 0;\n    while (retryCount < 3) {\n      try {\n        const res = await chatApi.getMessages(params);\n        return res.data || { records: [], total: 0 };\n      } catch (retryError) {\n        retryCount++;\n        if (retryCount >= 3) {\n          uni.showToast({ title: 'åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', icon: 'none' });\n          return { records: [], total: 0 };\n        }\n      }\n    }\n  }\n};\n\n// æ ¼å¼åŒ–æ¶ˆæ¯åˆ—è¡¨\nconst formatMessageList = (records) => {\n  return records.map(record => {\n    // ä½¿ç”¨åç«¯è¿”å›çš„ isSelf å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå·²ç»åœ¨åç«¯æ­£ç¡®è®¡ç®—äº†\n    const isSelf = record.isSelf;\n    \n    return {\n      id: record.id,\n      isSelf: isSelf,\n      type: record.messageType || 'text',\n      // æ ¹æ®æ˜¯å¦ä¸ºè‡ªå·±å‘é€çš„æ¶ˆæ¯é€‰æ‹©æ­£ç¡®çš„å¤´åƒ\n      avatar: record.senderAvatar || '/static/avatars/avatar1.jpeg',\n      \n\t  // æ·»åŠ å‘é€è€…æ˜µç§°ä¿¡æ¯\n      senderNickname: record.senderNickname,\n      receiverNickname: record.receiverNickname,\n      senderId: record.senderId,\n      receiverId: record.receiverId,\n      content: record.content,\n      timestamp: new Date(record.createdAt).getTime(),\n      isRead: record.isRead\n    };\n  });\n};\n\nconst loadMoreHistory = async () => {\n  if (isLoadingMore.value || !hasMore.value) return;\n  \n  try {\n    isLoadingMore.value = true;\n    \n    // 1. æ‰¾åˆ°å½“å‰å·²åŠ è½½çš„æœ€å°é¡µç ï¼ˆæœ€æ—©çš„æ¶ˆæ¯æ‰€åœ¨é¡µï¼‰\n    const minLoadedPage = Math.min(...loadedPages.value);\n    // 2. ä¸‹ä¸€ä¸ªè¦åŠ è½½çš„é¡µç ï¼ˆæ¯”å½“å‰æœ€æ—©é¡µæ›´æ—§ä¸€é¡µï¼‰\n    const nextPage = minLoadedPage - 1;\n    \n    // 3. å¦‚æœå·²åˆ°ç¬¬1é¡µï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šå†å²\n    if (nextPage < 1) {\n      hasMore.value = false;\n      uni.showToast({ title: 'å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯', icon: 'none', duration: 1500 });\n      isLoadingMore.value = false;\n      return;\n    }\n    \n    // 4. åŠ è½½æ›´æ—©çš„ä¸€é¡µæ¶ˆæ¯\n    const res = await fetchMessageList(nextPage);\n    if (res.records && res.records.length > 0) {\n      // æ ¼å¼åŒ–æ–°æ¶ˆæ¯ï¼ˆå•é¡µå†…æ˜¯â€œæ—§â†’æ–°â€ï¼‰\n      const newMessages = formatMessageList(res.records);\n      // å°†æ›´æ—©çš„æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨æœ€å‰é¢ï¼ˆç”¨æˆ·ä¸Šæ»‘æ—¶ï¼Œæ—§æ¶ˆæ¯ä»é¡¶éƒ¨å‡ºç°ï¼‰\n      messageList.value = [...newMessages, ...messageList.value];\n      \n      // æ›´æ–°å·²åŠ è½½é¡µç è®°å½•\n      loadedPages.value.push(nextPage);\n      \n      // æ›´æ–°ç¼“å­˜\n      const otherUserId = sellerId.value || receiverId.value;\n      if (otherUserId) {\n        saveMessagesToCache(otherUserId, messageList.value);\n      }\n      \n      // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´æ—©çš„æ¶ˆæ¯\n      hasMore.value = nextPage > 1;\n    } else {\n      hasMore.value = false;\n      uni.showToast({ title: 'å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯', icon: 'none', duration: 1500 });\n    }\n  } catch (error) {\n    console.error('åŠ è½½æ›´å¤šæ¶ˆæ¯å¤±è´¥ï¼š', error);\n  } finally {\n    isLoadingMore.value = false;\n  }\n};\n\n// åˆ¤æ–­å½“å‰æ¶ˆæ¯æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ—¶é—´ï¼ˆé—´éš”5åˆ†é’Ÿï¼‰\nconst shouldShowTime = (index) => {\n  if (index === 0) return true;\n  \n  const currentTime = messageList.value[index].timestamp;\n  const prevTime = messageList.value[index - 1].timestamp;\n  \n  return currentTime - prevTime > 300000; // 5åˆ†é’Ÿ = 300000æ¯«ç§’\n};\n\n// æ ¼å¼åŒ–æ—¶é—´ï¼ˆå…¼å®¹iOSï¼‰\nconst formatTime = (timestamp) => {\n  let date;\n  // å¤„ç†å­—ç¬¦ä¸²æ ¼å¼çš„æ—¶é—´ï¼ˆå¦‚æœåç«¯è¿”å›çš„æ˜¯å­—ç¬¦ä¸²ï¼‰\n  if (typeof timestamp === 'string') {\n    // å°† \"yyyy-MM-ddTHH:mm:ss\" è½¬æ¢ä¸º \"yyyy/MM/dd HH:mm:ss\"\n    timestamp = timestamp.replace(/T/, ' ').replace(/\\.\\d+/, ''); \n    date = new Date(timestamp);\n  } else {\n    // å¤„ç†æ—¶é—´æˆ³æ ¼å¼\n    date = new Date(timestamp);\n  }\n  const hours = date.getHours().toString().padStart(2, '0');\n  const minutes = date.getMinutes().toString().padStart(2, '0');\n  return `${hours}:${minutes}`;\n};\n\nconst formatDateForIOS = (dateStr) => {\n  if (!dateStr) return new Date().getTime();\n  // å¤„ç† \"yyyy-MM-ddTHH:mm:ss\" æˆ– \"yyyy-MM-dd HH:mm:ss\" æ ¼å¼\n  const normalized = dateStr.replace(/T/, ' ').replace(/\\.\\d+/, ''); \n  // è¿›ä¸€æ­¥æ›¿æ¢ \"-\" ä¸º \"/\"ï¼ˆiOS å¯¹ \"/\" åˆ†éš”çš„æ—¥æœŸå…¼å®¹æ€§æ›´å¥½ï¼‰\n  const iosFriendly = normalized.replace(/-/g, '/'); \n  return new Date(iosFriendly).getTime();\n};\n\n// å›¾ç‰‡å‘é€ç›¸å…³\nconst waitSendImage = ref('');\n// ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨\nconst uploadImage = (tempFilePath, senderId, receiverId) => {\n\tconsole.log('ä¸Šä¼ å‚æ•°ï¼š', { senderId, receiverId, tempFilePath });\n  return new Promise((resolve, reject) => {\n    uni.uploadFile({\n      url: 'http://8.141.125.2:8083/api/chat/media/upload', // æ¥å£åœ°å€\n      filePath: tempFilePath,\n      name: 'file', // ä¸æ¥å£çº¦å®šçš„æ–‡ä»¶å­—æ®µå\n      formData: {\n        senderId: senderId.toString(), // å¼ºåˆ¶è½¬å­—ç¬¦ä¸²\n        receiverId: receiverId.toString()\n      },\n      success: (res) => {\n        try {\n          const data = JSON.parse(res.data);\n          if (data.code === 200 && data.data && data.data.mediaUrl) {\n            resolve(data.data.mediaUrl); // è¿”å›åç«¯çš„å›¾ç‰‡URL\n          } else {\n            uni.showToast({ title: data.msg || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', icon: 'none' });\n            reject(new Error(data.msg || 'ä¸Šä¼ å¤±è´¥'));\n          }\n        } catch (e) {\n          uni.showToast({ title: 'æ¥å£å“åº”æ ¼å¼é”™è¯¯', icon: 'none' });\n          reject(e);\n        }\n      },\n      fail: (err) => {\n        uni.showToast({ title: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', icon: 'none' });\n        reject(err);\n      }\n    });\n  });\n};\n\n// å‘é€æ¶ˆæ¯\nconst sendMessage = async () => {\n\t  if (!isSocketConnected.value) {\n\t    uni.showToast({ title: 'è¿æ¥æœªå»ºç«‹ï¼Œè¯·ç¨å€™', icon: 'none' });\n\t    return;\n\t  }\n\t  // æ–‡æœ¬æ¶ˆæ¯å¤„ç†\n\t  if (inputContent.value.trim()) {\n\t    try {\n\t      const message = {\n\t        type: 'PRIVATE_MESSAGE',\n\t        receiverId: sellerId.value || receiverId.value,\n\t        content: inputContent.value.trim(),\n\t        messageType: 'text',\n\t        senderId: currentUser.value.id\n\t      };\n\t      console.log('å‘é€æ¶ˆæ¯å‚æ•°:', message);\n\t\n\t      // 1. æœ¬åœ°ä¸´æ—¶æ˜¾ç¤ºï¼ˆç«‹å³åé¦ˆç”¨æˆ·ï¼‰\n\t      const localMessage = addMessageToLocal(message); // æ ‡è®° isLocal: true\n\t      inputContent.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†\n\t\n\t      // 2. é€šè¿‡WebSocketå‘é€æ¶ˆæ¯\n\t      uni.sendSocketMessage({\n\t        data: JSON.stringify(message),\n\t        success: async () => {\n\t          console.log('æ¶ˆæ¯å‘é€æˆåŠŸï¼Œç­‰å¾…æœåŠ¡å™¨ç¡®è®¤');\n\t\n\t          // 3. å»¶è¿ŸåŒæ­¥æœåŠ¡å™¨æœ€æ–°æ¶ˆæ¯ï¼ˆç¡®ä¿æœåŠ¡å™¨å·²ä¿å­˜ï¼‰\n\t          setTimeout(async () => {\n\t            try {\n\t              // è¯·æ±‚æœ€æ–°ä¸€é¡µæ¶ˆæ¯ï¼ˆæ€»é¡µæ•°å¯¹åº”çš„é¡µï¼Œå³åŒ…å«åˆšå‘é€çš„æ¶ˆæ¯ï¼‰\n\t              const res = await fetchMessageList(totalPages.value || 1);\n\t              if (res.records && res.records.length > 0) {\n\t                const serverMessages = formatMessageList(res.records);\n\t\n\t                // 4. å¢é‡æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰\n\t                // - ä¿ç•™ç°æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬å†å²æ¶ˆæ¯å’Œæœªè¢«ç¡®è®¤çš„ä¸´æ—¶æ¶ˆæ¯ï¼‰\n\t                const updatedMessages = [...messageList.value];\n\t                \n\t                // - æ‰¾åˆ°æœ¬åœ°ä¸´æ—¶æ¶ˆæ¯çš„ç´¢å¼•\n\t                const localMsgIndex = updatedMessages.findIndex(\n\t                  msg => msg.id === localMessage.id // ç”¨ä¸´æ—¶IDåŒ¹é…\n\t                );\n\t\n\t                // - æ‰¾åˆ°æœåŠ¡å™¨è¿”å›çš„å¯¹åº”çœŸå®æ¶ˆæ¯\n\t                const realMessage = serverMessages.find(\n\t                  msg => msg.content === localMessage.content && \n\t                         msg.senderId === currentUser.value.id && \n\t                         Math.abs(msg.timestamp - localMessage.timestamp) < 5000\n\t                );\n\t\n\t                // - æ›¿æ¢ä¸´æ—¶æ¶ˆæ¯ä¸ºçœŸå®æ¶ˆæ¯ï¼ˆå¦‚æœæ‰¾åˆ°ï¼‰\n\t                if (localMsgIndex > -1 && realMessage) {\n\t                  updatedMessages.splice(localMsgIndex, 1, realMessage);\n\t                }\n\t\n\t                // - æ£€æŸ¥æ˜¯å¦æœ‰å¯¹æ–¹åŒæ—¶å‘é€çš„æ–°æ¶ˆæ¯ï¼Œè¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾\n\t                serverMessages.forEach(serverMsg => {\n\t                  const isAlreadyExist = updatedMessages.some(\n\t                    msg => msg.id === serverMsg.id\n\t                  );\n\t                  if (!isAlreadyExist) {\n\t                    updatedMessages.push(serverMsg);\n\t                  }\n\t                });\n\t\n\t                // 5. æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ï¼ˆä¿ç•™å†å²ï¼Œåªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼‰\n\t                messageList.value = updatedMessages;\n\t\n\t                // 6. æ›´æ–°ç¼“å­˜ï¼ˆåŒ…å«æ‰€æœ‰å†å²+æœ€æ–°æ¶ˆæ¯ï¼‰\n\t                const otherUserId = sellerId.value || receiverId.value;\n\t                if (otherUserId) {\n\t                  saveMessagesToCache(otherUserId, updatedMessages);\n\t                }\n\t\n\t                // 7. ç¡®ä¿æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯\n\t                scrollToBottom();\n\t              }\n\t            } catch (error) {\n\t              console.error('åŒæ­¥æœåŠ¡å™¨æ¶ˆæ¯å¤±è´¥:', error);\n\t            }\n\t          }, 800); // é€‚å½“å»¶è¿Ÿï¼Œç¡®ä¿æœåŠ¡å™¨å·²å¤„ç†æ¶ˆæ¯\n\t        },\n\t        fail: (err) => {\n\t          console.error('æ¶ˆæ¯å‘é€å¤±è´¥:', err);\n\t          uni.showToast({ title: 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'none' });\n\t          // å¤±è´¥æ—¶ç§»é™¤æœ¬åœ°ä¸´æ—¶æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰\n\t          messageList.value = messageList.value.filter(\n\t            msg => msg.id !== localMessage.id\n\t          );\n\t        }\n\t      });\n\t    } catch (error) {\n\t      console.error('æ¶ˆæ¯å¤„ç†å¼‚å¸¸:', error);\n\t      uni.showToast({ title: 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'none' });\n\t    }\n\t  }\n\n // å›¾ç‰‡æ¶ˆæ¯å¤„ç†\n  if (waitSendImage.value) {\n     await sendImageMessage();\n  }\n};\n\n// å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼ˆåŒ…å«ä¸Šä¼ é€»è¾‘ï¼‰\nconst sendImageMessage = async () => {\n\t const targetReceiverId = sellerId.value || receiverId.value; \n  if (!waitSendImage.value || !currentUser.value.id || !targetReceiverId) {\n      uni.showToast({ title: 'å‚æ•°ä¸å®Œæ•´', icon: 'none' });\n      return;\n    }\n\n  try {\n    uni.showLoading({ title: 'å›¾ç‰‡ä¸Šä¼ ä¸­...' });\n    // 1. ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨\n    const imageUrl = await uploadImage(\n      waitSendImage.value,\n      currentUser.value.id,\n      targetReceiverId,\n    );\n\n    // 2. æ„é€ å›¾ç‰‡æ¶ˆæ¯\n    const message = {\n      type: 'PRIVATE_MESSAGE',\n      receiverId: targetReceiverId,\n      content: imageUrl, // ä½¿ç”¨åç«¯è¿”å›çš„çœŸå®å›¾ç‰‡URL\n      messageType: 'image',\n      senderId: currentUser.value.id\n    };\n\n    // 3. æœ¬åœ°ä¸´æ—¶æ˜¾ç¤º\n    const localMessage = addMessageToLocal(message);\n\n    // 4. é€šè¿‡WebSocketå‘é€\n    uni.sendSocketMessage({\n      data: JSON.stringify(message),\n      success: () => {\n        console.log('å›¾ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸ');\n        waitSendImage.value = '';\n        // åŒæ­¥æœåŠ¡å™¨æ¶ˆæ¯ï¼ˆå¯é€‰ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´ï¼‰\n        setTimeout(async () => {\n          const res = await fetchMessageList(1);\n          if (res.records && res.records.length > 0) {\n            messageList.value = formatMessageList(res.records);\n            const otherUserId = receiverId.value;\n            if (otherUserId) {\n              saveMessagesToCache(otherUserId, messageList.value);\n            }\n          }\n        }, 1000);\n      },\n      fail: (err) => {\n        console.error('å›¾ç‰‡æ¶ˆæ¯å‘é€å¤±è´¥:', err);\n        uni.showToast({ title: 'å›¾ç‰‡å‘é€å¤±è´¥', icon: 'none' });\n        // ç§»é™¤æœ¬åœ°ä¸´æ—¶æ¶ˆæ¯\n        messageList.value = messageList.value.filter(msg => msg.id !== localMessage.id);\n      },\n      complete: () => {\n        uni.hideLoading();\n      }\n    });\n  } catch (error) {\n    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);\n    uni.hideLoading();\n    uni.showToast({ title: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥', icon: 'none' });\n  }\n};\n\n// æ ¹æ®æ ‡ç­¾å†…å®¹è·å–ç±»å‹\nconst getTagType = (tagText) => {\n  if (tagText === 'éœ€æ±‚') {\n    return 'warning';\n  } else if (tagText === 'å¯åˆ€' || tagText === 'ä¸å¯åˆ€') {\n    return 'error';\n  }\n  return 'primary';\n};\n\n// æ ¹æ®ç”¨æˆ·ç±»å‹è·å–ä¿¡æ¯\nconst getUserType = (userType) => {\n  return userType === 'seller' ? 'å–' : 'ä¹°';\n};\n\n// å¤„ç†æ»šåŠ¨äº‹ä»¶ï¼šç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨æ—¶å…³é—­è‡ªåŠ¨æ»šåŠ¨\nconst onScroll = (e) => {\n  const { scrollTop, scrollHeight, clientHeight } = e.detail;\n  // å½“è·ç¦»åº•éƒ¨å°äº20rpxæ—¶ï¼Œè§†ä¸ºâ€œåœ¨åº•éƒ¨â€ï¼Œå¼€å¯è‡ªåŠ¨æ»šåŠ¨\n  const isAtBottom = scrollTop >= scrollHeight - clientHeight - 20;\n  isAutoScroll.value = isAtBottom;\n};\n\n// æ»šåŠ¨åˆ°åº•éƒ¨\nconst scrollToBottom = () => {\n  uni.createSelectorQuery().select('.chat-container').boundingClientRect(container => {\n    uni.createSelectorQuery().select('.message-list').boundingClientRect(list => {\n      if (container && list) {\n        // ç›´æ¥æ»šåŠ¨åˆ°åˆ—è¡¨æ€»é«˜åº¦ï¼ˆå³æœ«å°¾ï¼‰\n        scrollTop.value = list.height;\n        console.log('æ»šåŠ¨åˆ°åº•éƒ¨æˆåŠŸï¼Œæ»šåŠ¨é«˜åº¦ï¼š', scrollTop.value);\n      }\n    }).exec();\n  }).exec();\n};\n\n// é¡µé¢æŒ‚è½½å®Œæˆåæ»šåŠ¨åˆ°åº•éƒ¨\nonMounted(() => {\n  // ç›‘å¬æ¶ˆæ¯åˆ—è¡¨å˜åŒ–ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨\n  watch(messageList, () => {\n    nextTick(() => {\n      setTimeout(() => {\n        scrollToBottom();\n      }, 50);\n    });\n  }, { deep: true });\n\n  // åˆå§‹æŒ‚è½½æ—¶ï¼šå¦‚æœå¼¹çª—å·²å…³é—­ï¼Œç›´æ¥æ»šåŠ¨\n  if (!showPopup.value) {\n    nextTick(() => {\n      setTimeout(() => {\n        scrollToBottom();\n      }, 200);\n    });\n  }\n  \n});\n\n// ç›‘å¬å¼¹çª—å…³é—­ï¼Œå…³é—­åå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨\nwatch(showPopup, (newVal) => {\n  if (!newVal) {\n    nextTick(() => {\n      setTimeout(() => {\n        scrollToBottom();\n      }, 100);\n    });\n  }\n});\n\n// åˆ‡æ¢è¡¨æƒ…é¢æ¿\nconst toggleEmojiPanel = () => {\n  showEmojiPanel.value = !showEmojiPanel.value;\n};\n\n// æ’å…¥emojiåˆ°è¾“å…¥æ¡†\nconst insertEmoji = (emoji) => {\n  inputContent.value += emoji;\n};\n\n// é€‰æ‹©å›¾ç‰‡\nconst chooseImage = () => {\n  uni.chooseImage({\n    count: 1,\n    sizeType: ['original', 'compressed'],\n    sourceType: ['album', 'camera'],\n    success: (res) => {\n      waitSendImage.value = res.tempFilePaths[0];\n      uni.showToast({\n        title: 'å›¾ç‰‡å·²é€‰æ‹©ï¼Œç‚¹å‡»å‘é€',\n        icon: 'none',\n        duration: 1500\n      });\n    },\n    fail: (err) => {\n      uni.showToast({\n        title: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥',\n        icon: 'none',\n        duration: 1500\n      });\n      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼š', err);\n    }\n  });\n};\n\n// é¢„è§ˆå›¾ç‰‡\nconst previewImage = (currentImage) => {\n  const imageUrls = messageList.value\n    .filter(msg => msg.type === 'image')\n    .map(msg => msg.content);\n  \n  uni.previewImage({\n    current: currentImage,\n    urls: imageUrls,\n    loop: true\n  });\n};\n\n// é¡µé¢å¸è½½æ—¶å…³é—­WebSocketè¿æ¥\nonUnload(() => {\n  // åœæ­¢å¿ƒè·³æœºåˆ¶\n  stopHeartbeat();\n  \n  if (socketTask.value) {\n    // å…³é—­Socketè¿æ¥\n    uni.closeSocket({\n      success: () => {\n        console.log('é¡µé¢å¸è½½ï¼Œå…³é—­Socketè¿æ¥');\n      }\n    });\n    // é‡ç½®è¿æ¥çŠ¶æ€\n    isSocketConnected.value = false;\n    socketTask.value = null;\n  }\n  if (timer.value) { // æ ¡éªŒæ˜¯å¦å­˜åœ¨\n    clearInterval(timer.value);\n    timer.value = null;\n    console.log(\"å®šæ—¶å™¨å·²åœæ­¢ï¼Œä¸å†è·å–æ¶ˆæ¯\");\n  }\n});\n</script>\n\n<style scoped>\n/* åŸºç¡€æ ·å¼è°ƒæ•´ï¼šæ›´ç°ä»£ç®€æ´çš„é£æ ¼ */\n.chat-page {\n  display: flex;\n  flex-direction: column;\n  height: 100vh;\n  background-color: #f5f7fa;\n}\n\n/* å¼¹çª—æ ·å¼ï¼šå±…ä¸­æ˜¾ç¤ºï¼ŒåŠé€æ˜é®ç½© */\n.popup-overlay {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: rgba(0, 0, 0, 0.5);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 9999;\n}\n.popup-container {\n  width: 60%;\n  background-color: #fff;\n  border-radius: 24rpx;\n  padding: 40rpx 30rpx;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 30rpx;\n}\n.popup-content {\n  font-size: 24rpx;\n  color: #333;\n  text-align: center;\n}\n.popup-close-btn {\n  width: 180rpx;\n  height: 70rpx;\n  line-height: 70rpx;\n  background-color: #007aff;\n  color: #fff;\n  border-radius: 35rpx;\n  font-size: 28rpx;\n  padding: 0;\n}\n\n/* ä¸»å†…å®¹åŒºï¼šå¼¹çª—å…³é—­åæ˜¾ç¤º */\n.main-content {\n  display: flex;\n  flex-direction: column;\n  height: 100vh;\n  overflow: hidden;\n}\n\n/* å‚æ•°ä¿¡æ¯å¡ç‰‡ç›¸å…³æ ·å¼è°ƒæ•´ */\n.params-card {\n  background-color: #fff;\n  margin: 0 24rpx;\n  border-radius: 12rpx;\n  box-shadow: 0 0 20rpx rgba(0, 0, 0, 0.05);\n}\n.params-card__header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 16rpx 20rpx;\n  border-bottom: 1px solid #f7f7f7;\n  background-color: #fffab9;\n}\n.params-card__user{\n  display: flex;\n  align-items: center;\n}\n.user-avatar {\n  width: 60rpx;\n  height: 60rpx;\n  border-radius: 50%;\n  margin-right: 12rpx;\n}\n.user-info {\n  flex: 1;\n}\n.user-name {\n  font-size: 28rpx;\n  font-weight: 600;\n  color: #333;\n}\n.member-name {\n  font-size: 24rpx;\n  color: #999;\n  margin-top: 4rpx;\n  display: block;\n}\n.params-card__close {\n  width: 36rpx;\n  height: 36rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: 50%;\n  background-color: #f5f5f5;\n  color: #999;\n}\n.params-card__close--active {\n  background-color: #eee;\n  color: #666;\n}\n.params-card__content {\n  padding: 16rpx 20rpx;\n  display: flex;\n  align-items: flex-start;\n  gap: 25rpx;\n}\n.product-image {\n  width: 135rpx;\n  height: 135rpx;\n  border-radius: 8rpx;\n}\n.product-info {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 6rpx;\n}\n.product-price {\n  font-size: 28rpx;\n  color: #ff4d4f;\n  font-weight: 600;\n}\n.product-freight {\n  font-size: 24rpx;\n  color: #666;\n}\n/* æ ‡ç­¾å®¹å™¨æ”¯æŒè‡ªåŠ¨æ¢è¡Œ */\n.tags {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8rpx; /* æ ‡ç­¾ä¹‹é—´çš„é—´è· */\n}\n\n:deep(.tag-view) {\n  margin-top: 0rpx !important\n}\n\n/* æ”¶èµ·çŠ¶æ€ï¼šå±•å¼€æŒ‰é’®æ ·å¼ï¼ˆç‹¬ç«‹å¡ç‰‡ï¼Œè§†è§‰ç»Ÿä¸€ï¼‰ */\n.params-expand-btn {\n  background-color: #ffe76f;\n  margin: 16rpx 24rpx;\n  border-radius: 24rpx;\n  box-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.05);\n  padding: 18rpx 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 8rpx;\n  color: #333;\n  font-size: 22rpx;\n  cursor: pointer;\n}\n/* ç‚¹å‡»åé¦ˆ */\n.params-expand-btn--active {\n  background-color: #f5f5f5;\n}\n\n/* å¡ç‰‡åˆ†éš”çº¿ */\n.params-card__divider {\n  height: 1px;\n  background-color: #f7f7f7;\n  margin: 20rpx 0;\n}\n\n/* å¡ç‰‡åº•éƒ¨ */\n.params-card__footer {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 8rpx;\n  padding: 16rpx 0;\n  background-color: #ffe76f;\n  color: #333;\n  font-size: 22rpx;\n  cursor: pointer;\n}\n\n.params-card__footer--active {\n  background-color: #f5f5f5;\n}\n\n.params-card__footer-icon {\n  font-size: 20rpx;\n  transition: transform 0.2s ease;\n}\n\n/* ç‚¹å‡»æ”¶èµ·æ—¶å›¾æ ‡æ—‹è½¬ï¼ˆå¯é€‰åŠ¨ç”»æ•ˆæœï¼‰ */\n.params-card__footer:active .params-card__footer-icon {\n  transform: rotate(180deg);\n}\n/* èŠå¤©å†…å®¹åŒºï¼šä¼˜åŒ–èƒŒæ™¯å’Œé—´è· */\n.chat-container {\n  flex: 1;\n  max-height: calc(100vh - 185rpx - 128rpx);\n  padding: 24rpx;\n  box-sizing: border-box;\n  background-color: #f5f7fa;\n  overflow-y: auto;\n}\n.message-list {\n  min-height: 100%;\n  display: flex;\n  flex-direction: column;\n  gap: 25rpx;\n}\n.system-message {\n  text-align: center;\n  font-size: 24rpx;\n  color: #999;\n  padding: 10rpx 20rpx;\n  background-color: #eef1f5;\n  border-radius: 18rpx;\n  margin: 0 auto;\n}\n\n/* æ¶ˆæ¯é¡¹ï¼šä¼˜åŒ–å¸ƒå±€å’Œæ°”æ³¡æ ·å¼ */\n.message-item {\n  width: 100%;\n  display: flex;\n  flex-direction: column; \n  align-items: center;\n  margin-bottom: 10rpx; \n}\n.self-message {\n  flex-direction: row-reverse;\n}\n.avatar {\n  width: 72rpx;\n  height: 72rpx;\n  border-radius: 50%;\n  margin: 0 16rpx;\n  flex-shrink: 0;\n  border: 1px solid #f0f0f0;\n  align-self: flex-start; /* å¤´åƒé¡¶éƒ¨å¯¹é½ */\n}\n.message-bubble {\n  max-width: 68%;\n  padding: 18rpx 24rpx;\n  border-radius: 24rpx;\n  position: relative;\n  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.05);\n  overflow-wrap: anywhere;\n}\n/* å¯¹æ–¹æ¶ˆæ¯æ°”æ³¡ */\n.message-item:not(.self-message1) .message-bubble {\n  background-color: #fff;\n  border-top-left-radius: 8rpx;\n}\n/* è‡ªå·±æ¶ˆæ¯æ°”æ³¡ */\n.self-message1 .message-bubble {\n  background-color: #007aff;\n  border-top-right-radius: 8rpx;\n}\n\n/* æ¶ˆæ¯å†…å®¹ï¼šä¼˜åŒ–å­—ä½“å’Œè¡Œé«˜ */\n.message-content {\n  font-size: 28rpx;\n  line-height: 1.6;\n  white-space: pre-wrap;\n}\n.self-message .message-content {\n  color: #fff;\n}\n\n/* å‘é€è€…æ˜µç§°æ ·å¼ */\n.sender-nickname {\n  font-size: 22rpx;\n  color: #666;\n  margin-bottom: 8rpx;\n  display: block;\n  font-weight: 500;\n}\n/* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */\n.message-image {\n  width: auto;\n  height: auto;\n  max-width: 300rpx; \n  max-height: 400rpx;\n  min-width: 130rpx; \n  min-height: 130rpx; \n  border-radius: 16rpx;\n  object-fit: cover;\n}\n\n/* æ¶ˆæ¯æ—¶é—´ï¼šä¼˜åŒ–ä½ç½®å’Œé¢œè‰² */\n.message-time {\n  display: block;\n  font-size: 20rpx;\n  color: #999;\n  text-align: center; \n  margin: 8rpx auto; \n  padding: 4rpx 12rpx;\n  background-color: #f0f0f0;\n  border-radius: 8rpx;\n  width: fit-content; \n}\n/* æ¶ˆæ¯å†…å®¹ä¸å¤´åƒçš„æ¨ªå‘å¸ƒå±€å®¹å™¨ */\n.message-content-wrap {\n  display: flex;\n  align-items: flex-start;\n  width: 100%;\n}\n\n.message-item:not(.self-message) .message-time {\n  color: #999;\n}\n.self-message .message-time {\n  color: rgba(255, 255, 255, 0.8);\n}\n\n/* åŠŸèƒ½å·¥å…·æ ï¼šè¡¨æƒ…ã€å›¾ç‰‡æŒ‰é’® */\n.input-panel {\n  display: flex;\n  flex-direction: column;\n  background-color: #fff;\n  border-top: 1px solid #f0f0f0;\n  padding-bottom: 30px; \n}\n.tool-bar {\n  display: flex;\n  padding: 12rpx 24rpx;\n  background-color: #fff;\n  border-top: 1px solid #f0f0f0;\n  gap: 24rpx;\n}\n.tool-btn {\n  width: 56rpx;\n  height: 56rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: 50%;\n  background-color: #f5f5f5;\n  cursor: pointer;\n}\n.icon-smile, .icon-image {\n  font-size: 32rpx;\n  color: #666;\n}\n\n/* è¡¨æƒ…é¢æ¿ */\n.emoji-panel {\n  background-color: #fff;\n  padding: 20rpx;\n  border-top: 1px solid #f0f0f0;\n  max-height: 300rpx;\n  overflow-y: auto;\n  transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;\n}\n/* è¡¨æƒ…é¢æ¿éšè—æ—¶çš„åˆå§‹çŠ¶æ€ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ */\n.emoji-panel[style*=\"display: none\"] {\n  max-height: 0;\n  padding: 0;\n  overflow: hidden;\n}\n.emoji-list {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 16rpx;\n}\n.emoji-item {\n  width: 70rpx;\n  height: 70rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 48rpx;\n  cursor: pointer;\n  border-radius: 8rpx;\n}\n.emoji-item:hover {\n  background-color: #f5f5f5;\n}\n\n/* è¾“å…¥åŒºåŸŸï¼šä¼˜åŒ–æ ·å¼ */\n.input-container {\n  display: flex;\n  align-items: center;\n  padding: 16rpx 24rpx;\n}\n.message-input {\n  flex: 1;\n  height: 84rpx;\n  background-color: #f5f5f5;\n  border-radius: 42rpx;\n  padding: 0 32rpx;\n  font-size: 28rpx;\n  margin-right: 20rpx;\n  border: none;\n}\n.message-input:focus {\n  outline: none;\n  background-color: #eee;\n}\n.send-button {\n  width: 128rpx;\n  height: 84rpx;\n  line-height: 84rpx;\n  text-align: center;\n  background-color: #007aff;\n  color: #fff;\n  border-radius: 42rpx;\n  font-size: 28rpx;\n  padding: 0;\n  border: none;\n}\n.send-button:disabled {\n  background-color: #e5e5e5;\n  color: #999;\n}\n\n/* ä¿®å¤scroll-viewåœ¨H5ä¸­çš„é«˜åº¦é—®é¢˜ */\n::-webkit-scrollbar {\n  width: 4rpx;\n  height: 4rpx;\n}\n::-webkit-scrollbar-thumb {\n  background-color: #ddd;\n  border-radius: 2rpx;\n}\n\n\n.loading-more {\n  text-align: center;\n  font-size: 24rpx;\n  color: #999;\n  padding: 15rpx 0;\n}\n\n.product-title {\n  font-size: 26rpx;\n  color: #333;\n  margin-bottom: 8rpx;\n  display: -webkit-box;\n  -webkit-line-clamp: 2;\n  -webkit-box-orient: vertical;\n  overflow: hidden;\n}\n</style>","import MiniProgramPage from 'C:/Users/86133/Desktop/demo/Lezhuan/pages/chat/chat/chat.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","userApi","onLoad","otherUserId","productApi","page","chatApi","senderId","receiverId","scrollTop","onMounted","watch","nextTick","onUnload"],"mappings":"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"}