{"version":3,"file":"message.js","sources":["pages/message/message.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbWVzc2FnZS9tZXNzYWdlLnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"chat-list-container\">\n    <!-- 搜索栏 -->\n    <view class=\"search-bar\">\n      <view class=\"search-input-wrapper\">\n        <uni-icons type=\"search\" size=\"18\" color=\"#999\" class=\"search-icon\" />\n        <input \n          type=\"text\" \n          v-model=\"searchQuery\" \n          placeholder=\"搜索聊天...\" \n          class=\"search-input\"\n          @input=\"handleSearch\"\n        />\n        <uni-icons \n          type=\"clear\" \n          size=\"16\" \n          color=\"#999\" \n          class=\"clear-icon\" \n          v-if=\"searchQuery\"\n          @click=\"clearSearch\"\n        />\n      </view>\n    </view>\n\t\n\t<!-- 系统通知区域 -->\n\t<view class=\"system-notice\" @click=\"goToNoticePage\">\n\t  <uni-icons type=\"notification\" size=\"24\" color=\"#007aff\" class=\"notice-icon\" />\n\t  <view class=\"notice-content\">\n\t    <text class=\"notice-title\">系统通知</text>\n\t    <!-- 动态显示未读数量，根据数量调整文案 -->\n\t    <text class=\"notice-desc\">\n\t      您有{{ unreadCount }}条{{ unreadCount > 1 ? '未读通知' : '未读通知' }}，点击查看详情\n\t    </text>\n\t  </view>\n\t  <!-- 未读数量徽章 -->\n\t  <view class=\"system-notice-badge\" v-if=\"unreadCount > 0\">\n\t    {{ unreadCount }}\n\t  </view>\n\t  <uni-icons type=\"right\" size=\"20\" color=\"#999\" class=\"arrow-icon\" />\n\t</view>\n\n    <!-- 聊天列表 -->\n    <view class=\"chat-list\">\n      <view \n        v-for=\"(chat, index) in filteredChats\" \n        :key=\"index\" \n        class=\"chat-item\"\n        @click=\"handleChatClick(chat)\"\n      >\n        <!-- 头像 -->\n        <view class=\"avatar-wrapper\">\n          <image \n            :src=\"chat.avatar\" \n            mode=\"widthFix\" \n            class=\"avatar\"\n            :alt=\"chat.name\"\n          ></image>\n          <view class=\"unread-badge\" v-if=\"chat.unread > 0\">\n            {{ chat.unread > 99 ? '99+' : chat.unread }}\n          </view>\n        </view>\n        \n        <!-- 聊天信息 -->\n        <view class=\"chat-info\">\n          <view class=\"chat-header\">\n            <text class=\"chat-name\">{{ chat.name }}</text>\n            <text class=\"chat-time\">{{ chat.time }}</text>\n          </view>\n          <view class=\"chat-last-message\">\n            <text \n              class=\"message-content\" \n              :class=\"{ 'unread-message': chat.unread > 0 }\"\n            >\n              {{ chat.lastMessage }}\n            </text>\n          </view>\n        </view>\n      </view>\n      \n      <!-- 空状态 -->\n      <view class=\"empty-state\" v-if=\"filteredChats.length === 0\">\n        <uni-icons type=\"chat\" size=\"48\" color=\"#ccc\" />\n        <text class=\"empty-text\">没有找到匹配的聊天</text>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, computed, onMounted } from 'vue';\nimport { onShow, onPullDownRefresh } from '@dcloudio/uni-app';\nimport chatApi from '@/api/chat.js'; \nimport noticeApi from '@/api/notice.js';\nimport { ensureLoggedIn, ensureStudentCertified, ensureMembership } from '@/utils/uniHelper';\n\nconst userId = uni.getStorageSync('userId') || '';\n// 搜索查询\nconst searchQuery = ref('');\n// 聊天数据\nconst chats = ref([]);\nconst isFirstLoad = ref(true); // 标记是否为首次加载\n\nconst goToNoticePage = () => {\n  uni.navigateTo({\n    url: `/pages/notice/notice`\n  });\n};\n\n// 识别图片链接并替换为[图片]\nconst replaceImageUrl = (text) => {\n  // 匹配常见图片格式的URL（png/jpg/jpeg/gif/webp）\n  const imageUrlRegex = /https?:\\/\\/\\S+\\.(png|jpg|jpeg|gif|webp)/gi;\n  return text.replace(imageUrlRegex, '[图片]');\n};\n\n// 下拉刷新回调\nonPullDownRefresh(() => {\n  if (!ensureLoggedIn({ content: '登录后才能查看消息', redirectTo: '/pages/mine/mine' })) {\n    uni.stopPullDownRefresh();\n    return;\n  }\n  // 执行刷新逻辑：重新请求聊天列表和未读通知\n  Promise.all([fetchChats(), fetchUnreadCount()])\n    .then(() => {\n      // 刷新完成后，停止下拉刷新动画\n      uni.stopPullDownRefresh();\n    })\n    .catch((error) => {\n      console.error('下拉刷新失败：', error);\n      uni.stopPullDownRefresh();\n    });\n});\n\n//未读通知数量变量\nconst unreadCount = ref(0);\n\n//获取未读通知数量\nconst fetchUnreadCount = async () => {\n  try {\n    const res = await noticeApi.getUnreadCount();\n    if (res.code === 200 && res.data) {\n      unreadCount.value = res.data.totalUnreadCount || 0;\n    }\n  } catch (error) {\n    console.error('获取未读通知数量失败:', error);\n  }\n};\n\n// 页面显示时触发（包括返回场景）\nonShow(async () => {\n  if (!ensureLoggedIn({ content: '登录后才能查看消息', redirectTo: '/pages/mine/mine' })) return;\n  // if (isFirstLoad.value) {\n  //   // 首次加载：请求接口并初始化数据\n  //   await fetchChats();\n  //   await fetchUnreadCount();\n  //   isFirstLoad.value = false;\n  // } else {\n  //   // 非首次加载（返回场景）：仅刷新未读数量，聊天列表复用已有数据\n  //   await fetchUnreadCount();\n  // }\n    const pages = getCurrentPages();\n    if (pages.length > 1) { // 说明是从其他页面返回\n      await fetchChats();\n      await fetchUnreadCount();\n    }\n    isFirstLoad.value = false;\n\n    fetchUnreadCount();\n});\n\n// 过滤后的聊天列表\nconst filteredChats = computed(() => {\n  if (!searchQuery.value) {\n    return chats.value;\n  }\n  \n  const query = searchQuery.value.toLowerCase();\n  return chats.value.filter(chat => \n    chat.name.toLowerCase().includes(query) || \n    chat.lastMessage.toLowerCase().includes(query)\n  );\n});\n\n// 处理搜索\nconst handleSearch = () => {\n  // 搜索逻辑由computed自动处理\n};\n\n// 清空搜索\nconst clearSearch = () => {\n  searchQuery.value = '';\n};\n\n// 点击聊天项跳转到聊天详情页（仅要求登录即可查看）\nconst handleChatClick = (chat) => {\n  if (!ensureLoggedIn({ content: '登录后才能查看并进入聊天', redirectTo: '/pages/mine/mine' })) return;\n  uni.navigateTo({\n    url: `/pages/chat/chat?sellerId=${chat.senderId}`\n  });\n};\n\n// 组件挂载时获取聊天列表数据\nonMounted(async () => {\n  if (!ensureLoggedIn({ content: '登录后才能查看消息', redirectTo: '/pages/mine/mine' })) return;\n\t  // 监听返回按钮点击\n\t  uni.onNavigationBarButtonTap((res) => {\n\t    if (res.type === 'back') {\n\t      fetchChats();\n\t      fetchUnreadCount();\n\t    }\n\t  });\n\t //  if (isFirstLoad.value) {\n\t\t// await fetchChats();\n\t\t// await fetchUnreadCount();\n\t\t// isFirstLoad.value = false;\n\t //  }\n\t //  fetchChats ();\n});\n\nconst fetchChats = async () => {\n\ttry {\n\t  const res = await chatApi.getChatConversations();\n\t\tconsole.log('后端返回的消息列表为：',res)\n\t  if (res.code === 200) {\n\t    const chatData = res.data.map(item => {\n\t      // 条件判断：senderId等于userId时，用receiverNickname；否则用senderNickname\n\t      const name = item.senderId === userId \n\t        ? item.receiverNickname \n\t        : item.senderNickname;\n\t      const senderId = item.senderId === userId\n\t        ? item.receiverId \n\t        : item.senderId;\n\t\t\tconst avatar = item.senderId === userId\n\t\t\t  ? item.receiverAvatar \n\t\t\t  : item.senderAvatar;\n\t\t\t\n\t\t\t // 处理lastMessage：替换图片链接为[图片]\n\t\t\tconst lastMessage = replaceImageUrl(item.lastMessageContent || '');\n\t\t\t\n\t      return {\n\t        name, // 使用条件判断后的name\n\t        avatar,\n\t        lastMessage,\n\t        time: item.lastMessageTime || '',\n\t        unread: item.unreadCount || 0,\n\t        senderId,\n\t      };\n\t    });\n\t    chats.value = chatData;\n\t    await fetchUnreadCount();\n\t  } else {\n\t    uni.showToast({\n\t      title: res.msg || '获取聊天列表失败',\n\t      icon: 'none'\n\t    });\n\t  }\n\t} catch (error) {\n\t  uni.showToast({\n\t    title: '接口请求异常',\n\t    icon: 'none'\n\t  });\n\t  console.error('获取聊天列表失败：', error);\n\t}\n}\n\n\n</script>\n\n<style scoped>\n.chat-list-container {\n  flex: 1;\n  background-color: #f5f5f5;\n  display: flex;\n  flex-direction: column;\n}\n\n/* 搜索栏样式 */\n.search-bar {\n  padding: 12rpx 24rpx;\n  background-color: #fff;\n}\n\n.search-input-wrapper {\n  display: flex;\n  align-items: center;\n  background-color: #f0f0f0;\n  border-radius: 60rpx;\n  padding: 14rpx 24rpx;\n}\n\n.search-icon {\n  margin-right: 16rpx;\n}\n\n.search-input {\n  flex: 1;\n  font-size: 28rpx;\n  color: #333;\n  background: transparent;\n  height: 40rpx;\n  line-height: 40rpx;\n}\n\n.search-input::placeholder {\n  color: #999;\n}\n\n.clear-icon {\n  margin-left: 16rpx;\n}\n\n/* 聊天列表样式 */\n.chat-list {\n  flex: 1;\n  overflow-y: auto;\n}\n\n.chat-item {\n  display: flex;\n  padding: 20rpx 24rpx;\n  background-color: #fff;\n  border-bottom: 1px solid #eee;\n  align-items: center;\n  transition: background-color 0.2s;\n}\n\n.chat-item:active {\n  background-color: #f9f9f9;\n}\n\n.avatar-wrapper {\n  position: relative;\n  margin-right: 24rpx;\n}\n\n.avatar {\n  width: 100rpx;\n  height: 100rpx;\n  border-radius: 20rpx;\n}\n\n.unread-badge {\n  position: absolute;\n  top: -10rpx;\n  right: -10rpx;\n  background-color: #ff3b30;\n  color: #fff;\n  font-size: 24rpx;\n  height: 40rpx;\n  border-radius: 20rpx; /* 椭圆更适配多位数 */\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-width: 40rpx;\n  padding: 0 8rpx; /* 关键：增加左右留白，适配1-3位数字 */\n}\n\n.chat-info {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  min-height: 100rpx;\n  position: relative;\n}\n\n.chat-header {\n  display: flex;\n  justify-content: space-between;\n  margin-bottom: 8rpx;\n}\n\n.chat-name {\n  font-size: 32rpx;\n  color: #333;\n  font-weight: 500;\n  max-width: 400rpx;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.chat-time {\n  font-size: 24rpx;\n  color: #999;\n}\n\n.chat-last-message {\n  display: flex;\n  align-items: center;\n}\n\n.message-content {\n  font-size: 28rpx;\n  color: #666;\n  max-width: 500rpx;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.unread-message {\n  color: #333;\n  font-weight: 500;\n}\n\n/* 空状态样式 */\n.empty-state {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  padding-top: 200rpx;\n}\n\n.empty-text {\n  font-size: 30rpx;\n  color: #999;\n  margin-top: 30rpx;\n}\n\n/* 系统通知样式 */\n.system-notice {\n  display: flex;\n  align-items: center;\n  padding: 20rpx 24rpx;\n  background-color: #fff;\n  border-bottom: 1px solid #eee;\n  margin-bottom: 10rpx; /* 与下方聊天列表分隔 */\n}\n\n.notice-icon {\n  margin-right: 20rpx;\n  background-color: #e8f3ff;\n  width: 56rpx;\n  height: 56rpx;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.notice-content {\n  flex: 1;\n}\n\n.notice-title {\n  font-size: 30rpx;\n  color: #333;\n  font-weight: 500;\n  display: block;\n  margin-bottom: 4rpx;\n}\n\n.notice-desc {\n  font-size: 26rpx;\n  color: #666;\n}\n\n.arrow-icon {\n  margin-left: 10rpx;\n}\n</style>","import MiniProgramPage from 'C:/Users/86133/Desktop/demo/Lezhuan/pages/message/message.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","ref","onPullDownRefresh","ensureLoggedIn","noticeApi","onShow","computed","onMounted","chatApi"],"mappings":"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"}