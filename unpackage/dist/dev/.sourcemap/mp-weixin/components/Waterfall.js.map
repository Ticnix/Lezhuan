{"version":3,"file":"Waterfall.js","sources":["components/Waterfall.vue","D:/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/QzovVXNlcnMvODYxMzMvRGVza3RvcC9kZW1vL0xlemh1YW4vY29tcG9uZW50cy9XYXRlcmZhbGwudnVl"],"sourcesContent":["<template>\n  <view class=\"waterfall-container\">\n    <!-- 瀑布流列 -->\n    <view\n      class=\"waterfall-column\"\n      v-for=\"(column, colIndex) in sortedColumns\"\n      :key=\"colIndex\"\n      :style=\"{ width: columnWidth }\"\n    >\n      <view\n        class=\"waterfall-item\"\n        v-for=\"item in column\"\n        :key=\"item.id\"\n        :style=\"{ \n          marginBottom: gap + 'rpx',\n          // 置顶商品添加特殊样式标记\n          borderTop: Number(item.adminPinScore) > 0 ? '4rpx solid #ff4d4f' : 'none'\n        }\"\n        @click=\"goToDetail(item.id,item.type)\"\n      >\n        <!-- 置顶标签（仅置顶商品显示） -->\n        <view v-if=\"Number(item.adminPinScore) > 0\" class=\"pinned-tag\">\n          <uni-tag text=\"置顶\" type=\"error\" size=\"mini\" />\n        </view>\n        \n        <image\n          class=\"waterfall-img\"\n\t\t  lazy-load\n          :src=\"item.imgUrl\"\n          mode=\"widthFix\"\n          :alt=\"item.title\"\n          :style=\"{ borderRadius: `${borderRadius}rpx ${borderRadius}rpx 0 0` }\"\n        />\n        <view class=\"waterfall-content\" :style=\"{ padding: `${contentPadding}rpx` }\">\n          \n          <!-- 标签区域 -->\n          <view class=\"tags\" v-if=\"item.tags && item.tags.length > 0\">\n            <view class=\"tag-view\" v-for=\"(tag, index) in item.tags\" :key=\"index\">\n              <uni-tag \n                size=\"mini\"\n                :text=\"tag\" \n                :type=\"getTagType(tag)\" \n              />\n            </view>\n          </view>\n          \n          <text class=\"waterfall-title\">{{ item.title }}</text>\n          <text \n            class=\"waterfall-desc\" \n            :style=\"{ \n              fontSize: `${descSize}rpx`, \n              marginTop: `${descMarginTop}rpx`,\n              display: '-webkit-box',\n              '-webkit-box-orient': 'vertical',\n              '-webkit-line-clamp': descLineCount,\n              overflow: 'hidden'\n            }\"\n          >\n            {{ item.desc }}\n          </text>\n          \n          <!-- 价格显示（新增） -->\n          <text class=\"price\" :style=\"{ marginTop: `${priceMarginTop}rpx` }\">\n            ¥{{ item.price.toFixed(2) }}\n          </text>\n          \n          <view class=\"user-info\" :style=\"{ marginTop: `${userInfoMarginTop}rpx` }\">\n            <image \n              class=\"user-avatar\" \n              :src=\"item.user.avatar\" \n              :style=\"{ \n                width: `${avatarSize}rpx`, \n                height: `${avatarSize}rpx`, \n                borderRadius: `${avatarSize / 2}rpx` \n              }\"\n              mode=\"widthFix\"\n            />\n            <text \n              class=\"user-nickname\" \n              :style=\"{ \n                fontSize: `${nicknameSize}rpx`, \n                marginLeft: `${nicknameMarginLeft}rpx` \n              }\"\n            >\n              {{ item.user.nickname }}\n            </text>\n          </view>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { computed } from 'vue';\nimport { sanitizeImageUrl } from '@/utils/uniHelper';\n\nconst props = defineProps({\n  // 商品列表（需包含 isAdminPinned 和 adminPinScore 字段）\n  list: {\n    type: Array,\n    default: () => []\n  },\n  columnCount: {\n    type: Number,\n    default: 2\n  },\n  gap: {\n    type: Number,\n    default: 20 // 单位 rpx\n  },\n  borderRadius: {\n    type: Number,\n    default: 10 // 单位 rpx\n  },\n  contentPadding: {\n    type: Number,\n    default: 16 // 单位 rpx\n  },\n  titleSize: {\n    type: Number,\n    default: 28 // 单位 rpx\n  },\n  descSize: {\n    type: Number,\n    default: 24 // 单位 rpx\n  },\n  descMarginTop: {\n    type: Number,\n    default: 8 // 单位 rpx\n  },\n  descLineCount: {\n    type: Number,\n    default: 2 // 商品简介显示行数\n  },\n  priceMarginTop: {\n    type: Number,\n    default: 8 // 单位 rpx\n  },\n  userInfoMarginTop: {\n    type: Number,\n    default: 12 // 单位 rpx\n  },\n  avatarSize: {\n    type: Number,\n    default: 40 // 单位 rpx\n  },\n  nicknameSize: {\n    type: Number,\n    default: 24 // 单位 rpx\n  },\n  nicknameMarginLeft: {\n    type: Number,\n    default: 8 // 单位 rpx\n  }\n});\n\n// 计算每列宽度（减去列间距）\nconst columnWidth = computed(() => {\n  return `calc((100% - ${(props.columnCount - 1) * props.gap}rpx) / ${props.columnCount})`;\n});\n\n// 对传入列表进行域名清洗（图片与头像）\nconst sanitizedList = computed(() => {\n  return (props.list || []).map(item => {\n    const type = item.type === 'demand' ? 'demand' : 'product';\n    return {\n      ...item,\n      imgUrl: sanitizeImageUrl(item.imgUrl || item.mainImageUrl, type),\n      user: {\n        avatar: sanitizeImageUrl(item?.user?.avatar, 'avatar'),\n        nickname: item?.user?.nickname || '未知用户'\n      }\n    };\n  });\n});\n\n// 按「adminPinScore」非0置顶，并按权重降序分配到列\nconst sortedColumns = computed(() => {\n  if (sanitizedList.value.length === 0) return []; // 空数据直接返回\n  // 1. 分离置顶商品和普通商品\n  const pinnedItems = sanitizedList.value.filter(item => Number(item.adminPinScore) > 0); // 管理员置顶（权重非0）\n  const normalItems = sanitizedList.value.filter(item => !(Number(item.adminPinScore) > 0)); // 其他（权重为0或空）\n\n  // 2. 分别按权重降序排序（权重越高越靠前）\n  const sortedPinned = [...pinnedItems].sort((a, b) => b.adminPinScore - a.adminPinScore);\n  const sortedNormal = [...normalItems].sort((a, b) => b.adminPinScore - a.adminPinScore);\n\n  // 3. 合并列表（置顶商品在前，普通商品在后）\n  const sortedList = [...sortedPinned, ...sortedNormal];\n\n  // 4. 分配到瀑布流列（优化：优先分配到当前高度最低的列，避免列高差异过大）\n  const columns = Array.from({ length: props.columnCount }, () => []);\n  const columnHeights = new Array(props.columnCount).fill(0); // 记录每列当前总高度\n\n  sortedList.forEach(item => {\n      const minHeight = Math.min(...columnHeights);\n      const minIndex = columnHeights.indexOf(minHeight);\n      \n      columns[minIndex].push(item);\n      // 替换为“固定高度 + 内容行数”的预估方式\n      const itemHeight = 400 + (item.desc.split(' ').length / 10) * 20; // 示例公式，可根据实际调整\n      columnHeights[minIndex] += itemHeight;\n    });\n\n  return columns;\n});\n\n// 根据标签内容获取类型\nconst getTagType = (tagText) => {\n  if (tagText === '需求') {\n    return 'warning';\n  } else if (tagText === '可刀' || tagText === '不可刀') {\n    return 'error';\n  }\n  return 'primary'; // 默认类型\n};\n\n// 点击商品跳转到详情页（传递id和type参数）\nconst goToDetail = (id, type) => {\n  const targetType = type || 'product';\n  uni.navigateTo({\n    url: `/pages/ProductDetail/ProductDetail?id=${id}&type=${targetType}`,\n  });\n};\n</script>\n\n<style scoped>\n.waterfall-container {\n  display: flex;\n  display: -webkit-flex; /* 兼容旧版微信小程序 */\n  justify-content: space-between;\n  -webkit-justify-content: space-between;\n  width: 100%;\n  box-sizing: border-box;\n  padding: 0 20rpx; /* 与父组件保持一致的左右边距 */\n}\n\n.waterfall-column {\n  display: flex;\n  flex-direction: column;\n}\n\n.waterfall-item {\n  background-color: #fff;\n  border-radius: 10rpx;\n  overflow: hidden;\n  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.05);\n  position: relative; /* 用于置顶标签定位 */\n}\n\n/* 置顶标签位置 */\n.pinned-tag {\n  position: absolute;\n  top: 10rpx;\n  right: 10rpx;\n  z-index: 2;\n}\n\n.waterfall-img {\n  width: 100%;\n  display: block;\n  aspect-ratio: 1/1; /* 正方形图片，可根据需求调整 */\n  object-fit: cover;\n}\n\n.waterfall-content {\n  padding: 16rpx;\n}\n\n/* 标签容器支持自动换行 */\n.tags {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8rpx;\n  padding-bottom: 4rpx;\n}\n\n.tag-view {\n  margin: 0;\n}\n\n.waterfall-title {\n  font-size: 28rpx;\n  font-weight: bold;\n  color: #333;\n  display: block;\n  line-height: 1.3;\n}\n\n.waterfall-desc {\n  color: #666;\n  line-height: 1.4;\n  display: block;\n}\n\n/* 价格样式 */\n.price {\n  display: block;\n  color: #ff4d4f;\n  font-size: 28rpx;\n  font-weight: bold;\n}\n\n.user-info {\n  display: flex;\n  align-items: center;\n  margin-top: 12rpx;\n}\n\n.user-avatar {\n  display: block;\n  object-fit: cover;\n  border: 1rpx solid #f0f0f0;\n}\n\n.user-nickname {\n  color: #666;\n  font-size: 24rpx;\n}\n</style>","import Component from 'C:/Users/86133/Desktop/demo/Lezhuan/components/Waterfall.vue'\nwx.createComponent(Component)"],"names":["computed","sanitizeImageUrl","uni"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiGA,UAAM,QAAQ;AA6Dd,UAAM,cAAcA,cAAQ,SAAC,MAAM;AACjC,aAAO,iBAAiB,MAAM,cAAc,KAAK,MAAM,GAAG,UAAU,MAAM,WAAW;AAAA,IACvF,CAAC;AAGD,UAAM,gBAAgBA,cAAQ,SAAC,MAAM;AACnC,cAAQ,MAAM,QAAQ,CAAA,GAAI,IAAI,UAAQ;;AACpC,cAAM,OAAO,KAAK,SAAS,WAAW,WAAW;AACjD,eAAO;AAAA,UACL,GAAG;AAAA,UACH,QAAQC,gBAAgB,iBAAC,KAAK,UAAU,KAAK,cAAc,IAAI;AAAA,UAC/D,MAAM;AAAA,YACJ,QAAQA,gBAAAA,kBAAiB,kCAAM,SAAN,mBAAY,QAAQ,QAAQ;AAAA,YACrD,YAAU,kCAAM,SAAN,mBAAY,aAAY;AAAA,UACnC;AAAA,QACP;AAAA,MACA,CAAG;AAAA,IACH,CAAC;AAGD,UAAM,gBAAgBD,cAAQ,SAAC,MAAM;AACnC,UAAI,cAAc,MAAM,WAAW;AAAG,eAAO,CAAA;AAE7C,YAAM,cAAc,cAAc,MAAM,OAAO,UAAQ,OAAO,KAAK,aAAa,IAAI,CAAC;AACrF,YAAM,cAAc,cAAc,MAAM,OAAO,UAAQ,EAAE,OAAO,KAAK,aAAa,IAAI,EAAE;AAGxF,YAAM,eAAe,CAAC,GAAG,WAAW,EAAE,KAAK,CAAC,GAAG,MAAM,EAAE,gBAAgB,EAAE,aAAa;AACtF,YAAM,eAAe,CAAC,GAAG,WAAW,EAAE,KAAK,CAAC,GAAG,MAAM,EAAE,gBAAgB,EAAE,aAAa;AAGtF,YAAM,aAAa,CAAC,GAAG,cAAc,GAAG,YAAY;AAGpD,YAAM,UAAU,MAAM,KAAK,EAAE,QAAQ,MAAM,YAAW,GAAI,MAAM,CAAA,CAAE;AAClE,YAAM,gBAAgB,IAAI,MAAM,MAAM,WAAW,EAAE,KAAK,CAAC;AAEzD,iBAAW,QAAQ,UAAQ;AACvB,cAAM,YAAY,KAAK,IAAI,GAAG,aAAa;AAC3C,cAAM,WAAW,cAAc,QAAQ,SAAS;AAEhD,gBAAQ,QAAQ,EAAE,KAAK,IAAI;AAE3B,cAAM,aAAa,MAAO,KAAK,KAAK,MAAM,GAAG,EAAE,SAAS,KAAM;AAC9D,sBAAc,QAAQ,KAAK;AAAA,MACjC,CAAK;AAEH,aAAO;AAAA,IACT,CAAC;AAGD,UAAM,aAAa,CAAC,YAAY;AAC9B,UAAI,YAAY,MAAM;AACpB,eAAO;AAAA,MACR,WAAU,YAAY,QAAQ,YAAY,OAAO;AAChD,eAAO;AAAA,MACR;AACD,aAAO;AAAA,IACT;AAGA,UAAM,aAAa,CAAC,IAAI,SAAS;AAC/B,YAAM,aAAa,QAAQ;AAC3BE,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK,yCAAyC,EAAE,SAAS,UAAU;AAAA,MACvE,CAAG;AAAA,IACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/NA,GAAG,gBAAgB,SAAS;"}